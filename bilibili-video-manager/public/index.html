<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B站视频管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f4f5f7;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cookie设置模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #00a1d6;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .cookie-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .cookie-status.success {
            background: #f0f9ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .cookie-status.warning {
            background: #fff9e6;
            color: #cc8800;
            border: 1px solid #ffcc66;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
            color: #00a1d6;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #00a1d6;
        }

        /* 标签页导航 */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button:hover {
            color: #00a1d6;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #00a1d6;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00a1d6;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* 标签管理面板 */
        .tag-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .tag-item:hover {
            background: #e9ecef;
        }

        .tag-name {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .tag-count {
            color: #666;
            font-size: 13px;
            margin-right: 12px;
        }

        .tag-actions {
            display: flex;
            gap: 6px;
        }

        .tag-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-hide {
            background: #ff4d4f;
        }

        .btn-hide:hover {
            background: #ff1f22;
        }

        .btn-show {
            background: #52c41a;
        }

        .btn-show:hover {
            background: #3fa714;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input {
            flex: 1;
            min-width: 200px;
        }

        button {
            background: #00a1d6;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #0088bb;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 视频列表表格样式 */
        .video-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .video-table {
            width: 100%;
            border-collapse: collapse;
        }

        .video-table thead {
            background: #f8f9fa;
        }

        .video-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        .video-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .video-table tbody tr:hover {
            background: #f8f9fa;
        }

        .video-table td {
            padding: 12px 16px;
            color: #333;
        }

        .video-title-cell {
            max-width: 400px;
        }

        .video-title-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-title-link:hover {
            color: #00a1d6;
        }

        .video-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .video-tag {
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 3px;
            font-size: 11px;
            color: #666;
        }

        .video-stats-cell {
            font-size: 13px;
            color: #666;
        }

        .state-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .state-published {
            background: #d4edda;
            color: #155724;
        }

        .state-unpublished {
            background: #f8d7da;
            color: #721c24;
        }

        .state-publishing {
            background: #fff3cd;
            color: #856404;
        }

        .badge-hidden {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-charging {
            background: #ffeaa7;
            color: #856404;
            margin-left: 5px;
        }

        .btn-delete {
            background: #dc3545;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .batch-controls {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .batch-controls h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .batch-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .batch-button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .batch-hide {
            background: #6c757d;
        }

        .batch-hide:hover {
            background: #5a6268;
        }

        .batch-delete {
            background: #dc3545;
        }

        .batch-delete:hover {
            background: #c82333;
        }

        .video-stats-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-item strong {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination button {
            min-width: 36px;
            height: 36px;
        }

        .pagination .page-info {
            margin: 0 10px;
            color: #666;
        }

        .pagination select {
            margin-left: 10px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .processing-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .processing-overlay.show {
            display: flex;
        }

        .processing-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        .processing-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .progress-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00a1d6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-actions {
            display: flex;
            gap: 6px;
        }

        .video-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>B站视频管理系统</h1>
                <div class="header-actions">
                    <button onclick="showCookieModal()">设置Cookie</button>
                    <button onclick="refreshData()">刷新数据</button>
                </div>
            </div>
            <div id="cookie-status" class="cookie-status" style="display:none;"></div>
            <p id="last-update">最后更新: --</p>
        </header>

        <div id="no-cookie-alert" class="alert alert-warning" style="display:none;">
            请先设置Cookie才能使用完整功能。点击右上角的"设置Cookie"按钮。
        </div>

        <div class="stats-container" id="stats-container">
            <div class="stat-card">
                <h3>总视频数</h3>
                <div class="value" id="total-videos">--</div>
            </div>
            <div class="stat-card">
                <h3>总播放量</h3>
                <div class="value" id="total-views">--</div>
            </div>
            <div class="stat-card">
                <h3>总点赞数</h3>
                <div class="value" id="total-likes">--</div>
            </div>
            <div class="stat-card">
                <h3>总硬币数</h3>
                <div class="value" id="total-coins">--</div>
            </div>
            <div class="stat-card">
                <h3>总收藏数</h3>
                <div class="value" id="total-favorites">--</div>
            </div>
            <div class="stat-card">
                <h3>总评论数</h3>
                <div class="value" id="total-comments">--</div>
            </div>
        </div>

        <!-- 标签页容器 -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('videos')">视频列表</button>
                <button class="tab-button" onclick="switchTab('tags')">标签管理</button>
            </div>

            <!-- 视频列表标签页 -->
            <div id="videos-tab" class="tab-content active">
                <!-- 批量操作控制面板 -->
                <div class="batch-controls">
                    <h3>批量操作</h3>
                    <div class="video-stats-info" id="video-stats-info">
                        <div class="stat-item">
                            <span>普通视频：</span>
                            <strong id="normal-count">--</strong>
                        </div>
                        <div class="stat-item">
                            <span>充电视频：</span>
                            <strong id="charging-count">--</strong>
                        </div>
                        <div class="stat-item">
                            <span>已隐藏：</span>
                            <strong id="hidden-count">--</strong>
                        </div>
                        <div class="stat-item">
                            <span>已发布：</span>
                            <strong id="published-count">--</strong>
                        </div>
                    </div>
                    <div class="batch-buttons">
                        <button class="batch-button batch-hide" onclick="batchHideNormalVideos()">
                            隐藏所有普通视频
                        </button>
                        <button class="batch-button batch-delete" onclick="batchDeleteChargingVideos()">
                            删除所有充电视频
                        </button>
                        <button class="batch-button" onclick="loadVideoStats()">
                            刷新统计
                        </button>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="controls-row">
                        <input type="text" id="search-input" placeholder="搜索视频标题或标签...">
                        <select id="category-filter">
                            <option value="">所有分类</option>
                        </select>
                        <select id="state-filter">
                            <option value="">所有状态</option>
                            <option value="0">已发布</option>
                            <option value="-40">待发布</option>
                            <option value="other">其他</option>
                        </select>
                        <select id="sort-select">
                            <option value="time-desc">发布时间↓</option>
                            <option value="time-asc">发布时间↑</option>
                            <option value="views-desc">播放量↓</option>
                            <option value="views-asc">播放量↑</option>
                            <option value="likes-desc">点赞数↓</option>
                            <option value="likes-asc">点赞数↑</option>
                        </select>
                        <button onclick="applyFilters()">应用筛选</button>
                    </div>
                </div>

                <div id="loading" class="loading">正在加载数据...</div>
                
                <div class="video-table-container" id="video-table-container" style="display:none;">
                    <table class="video-table">
                        <thead>
                            <tr>
                                <th>视频标题</th>
                                <th>分类</th>
                                <th>播放量</th>
                                <th>点赞</th>
                                <th>硬币</th>
                                <th>收藏</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="video-tbody">
                        </tbody>
                    </table>
                </div>
                
                <div id="pagination" class="pagination" style="display:none;">
                    <button onclick="changePage(-1)">上一页</button>
                    <span class="page-info">第 <span id="current-page">1</span> / <span id="total-pages">1</span> 页</span>
                    <button onclick="changePage(1)">下一页</button>
                    <select id="page-size-select" onchange="changePageSize()">
                        <option value="20">20条/页</option>
                        <option value="50">50条/页</option>
                        <option value="100">100条/页</option>
                        <option value="all" selected>显示全部</option>
                    </select>
                </div>
            </div>

            <!-- 标签管理标签页 -->
            <div id="tags-tab" class="tab-content">
                <div class="tag-grid" id="tag-grid">
                    <div class="loading">加载标签中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cookie设置模态框 -->
    <div id="cookie-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设置B站Cookie</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px;">请粘贴完整的B站Cookie字符串：</p>
                <textarea id="cookie-input" placeholder="例如: SESSDATA=xxx; bili_jct=xxx; DedeUserID=xxx; ..."></textarea>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    获取方法：登录B站创作中心 → F12打开开发者工具 → Network标签 → 刷新页面 → 找到任意请求 → 复制Cookie
                </p>
            </div>
            <div class="modal-footer">
                <button onclick="closeCookieModal()">取消</button>
                <button onclick="saveCookie()">保存</button>
            </div>
        </div>
    </div>

    <!-- 处理中提示 -->
    <div id="processing-overlay" class="processing-overlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h3 id="processing-title">处理中...</h3>
            <div id="progress-info" class="progress-info"></div>
        </div>
    </div>

    <script>
        let allVideos = [];
        let filteredVideos = [];
        let statistics = {};
        let currentPage = 1;
        let videosPerPage = 'all';
        let hasCookie = false;
        let currentTab = 'videos';

        function switchTab(tabName) {
            currentTab = tabName;
            
            // 更新标签按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 切换内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // 如果切换到标签页，加载标签数据
            if (tabName === 'tags') {
                loadTags();
            }
        }

        async function checkCookieStatus() {
            try {
                const response = await fetch('/api/cookie/status');
                const data = await response.json();
                hasCookie = data.hasCookie;
                
                const statusEl = document.getElementById('cookie-status');
                const alertEl = document.getElementById('no-cookie-alert');
                
                if (hasCookie) {
                    statusEl.style.display = 'block';
                    statusEl.className = 'cookie-status success';
                    statusEl.textContent = `Cookie已配置 (更新时间: ${data.updatedAt ? new Date(data.updatedAt).toLocaleString('zh-CN') : '未知'})`;
                    alertEl.style.display = 'none';
                } else {
                    statusEl.style.display = 'block';
                    statusEl.className = 'cookie-status warning';
                    statusEl.textContent = 'Cookie未配置';
                    alertEl.style.display = 'block';
                }
            } catch (error) {
                console.error('检查Cookie状态失败:', error);
            }
        }

        function showCookieModal() {
            document.getElementById('cookie-modal').classList.add('show');
        }

        function closeCookieModal() {
            document.getElementById('cookie-modal').classList.remove('show');
            document.getElementById('cookie-input').value = '';
        }

        async function saveCookie() {
            const cookie = document.getElementById('cookie-input').value.trim();
            if (!cookie) {
                alert('请输入Cookie');
                return;
            }

            try {
                const response = await fetch('/api/cookie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cookie })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Cookie保存成功！');
                    closeCookieModal();
                    await checkCookieStatus();
                    if (currentTab === 'tags') {
                        await loadTags();
                    }
                } else {
                    alert('保存失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('保存Cookie失败:', error);
                alert('保存失败，请重试');
            }
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                const data = await response.json();
                
                const tagGrid = document.getElementById('tag-grid');
                
                if (!data.tags || data.tags.length === 0) {
                    tagGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无标签数据</div>';
                    return;
                }
                
                tagGrid.innerHTML = data.tags.map(tag => {
                    const stats = data.stats[tag] || { count: 0, hiddenCount: 0, publicCount: 0 };
                    return `
                        <div class="tag-item">
                            <span class="tag-name">${tag}</span>
                            <span class="tag-count">${stats.count}个视频</span>
                            <div class="tag-actions">
                                <button class="btn-hide" onclick="hideVideosByTag('${tag.replace(/'/g, "\\'")}')">隐藏</button>
                                <button class="btn-show" onclick="showVideosByTag('${tag.replace(/'/g, "\\'")}')">显示</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载标签失败:', error);
                document.getElementById('tag-grid').innerHTML = '<div style="padding: 20px; text-align: center; color: #f00;">加载标签失败</div>';
            }
        }

        async function hideVideosByTag(tag) {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (!confirm(`确定要隐藏所有包含标签"${tag}"的视频吗？\n这些视频将设置为仅自己可见。`)) {
                return;
            }

            showProcessing(`正在隐藏包含标签"${tag}"的视频...`);

            try {
                const response = await fetch('/api/videos/hide-by-tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tag })
                });

                const result = await response.json();
                
                if (response.ok) {
                    let message = `处理完成！\n`;
                    if (result.results) {
                        message += `成功: ${result.results.success.length}个\n`;
                        message += `失败: ${result.results.failed.length}个\n`;
                        message += `跳过: ${result.results.skipped.length}个`;
                        
                        if (result.results.failed.length > 0) {
                            console.error('失败的视频:', result.results.failed);
                        }
                    }
                    alert(message);
                    await loadData();
                    await loadTags();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量隐藏失败:', error);
                alert('操作失败，请重试');
            } finally {
                hideProcessing();
            }
        }

        async function showVideosByTag(tag) {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (!confirm(`确定要公开所有包含标签"${tag}"的视频吗？`)) {
                return;
            }

            showProcessing(`正在公开包含标签"${tag}"的视频...`);

            try {
                const response = await fetch('/api/videos/show-by-tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tag })
                });

                const result = await response.json();
                
                if (response.ok) {
                    let message = `处理完成！\n`;
                    if (result.results) {
                        message += `成功: ${result.results.success.length}个\n`;
                        message += `失败: ${result.results.failed.length}个\n`;
                        message += `跳过: ${result.results.skipped.length}个`;
                        
                        if (result.results.failed.length > 0) {
                            console.error('失败的视频:', result.results.failed);
                        }
                    }
                    alert(message);
                    await loadData();
                    await loadTags();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量显示失败:', error);
                alert('操作失败，请重试');
            } finally {
                hideProcessing();
            }
        }

        async function hideVideo(aid) {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (!confirm('确定要隐藏此视频吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/video/${aid}/hide`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('视频已隐藏');
                    await loadData();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('隐藏视频失败:', error);
                alert('操作失败，请重试');
            }
        }

        async function showVideo(aid) {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (!confirm('确定要公开此视频吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/video/${aid}/show`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('视频已公开');
                    await loadData();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('公开视频失败:', error);
                alert('操作失败，请重试');
            }
        }

        function showProcessing(title) {
            document.getElementById('processing-title').textContent = title;
            document.getElementById('processing-overlay').classList.add('show');
        }

        function hideProcessing() {
            document.getElementById('processing-overlay').classList.remove('show');
        }

        async function loadData() {
            try {
                const [videosRes, statsRes] = await Promise.all([
                    fetch('/api/videos'),
                    fetch('/api/statistics')
                ]);

                allVideos = await videosRes.json();
                statistics = await statsRes.json();

                updateStatistics();
                updateCategoryFilter();
                applyFilters();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('video-table-container').style.display = 'block';
                document.getElementById('pagination').style.display = 'flex';
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('loading').textContent = '加载失败，请刷新页面重试';
            }
        }

        function updateStatistics() {
            document.getElementById('total-videos').textContent = statistics.totalVideos || '--';
            document.getElementById('total-views').textContent = formatNumber(statistics.totalViews || 0);
            document.getElementById('total-likes').textContent = formatNumber(statistics.totalLikes || 0);
            document.getElementById('total-coins').textContent = formatNumber(statistics.totalCoins || 0);
            document.getElementById('total-favorites').textContent = formatNumber(statistics.totalFavorites || 0);
            document.getElementById('total-comments').textContent = formatNumber(statistics.totalComments || 0);
            
            if (statistics.fetchTime) {
                document.getElementById('last-update').textContent = 
                    `最后更新: ${new Date(statistics.fetchTime).toLocaleString('zh-CN')}`;
            }
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            categoryFilter.innerHTML = '<option value="">所有分类</option>';
            const categories = [...new Set(allVideos.map(v => v.parentTname))].filter(Boolean);
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const stateFilter = document.getElementById('state-filter').value;
            const sortBy = document.getElementById('sort-select').value;

            filteredVideos = allVideos.filter(video => {
                // 搜索标题和标签
                if (searchTerm) {
                    const inTitle = video.title.toLowerCase().includes(searchTerm);
                    const inTags = video.tags && video.tags.some(tag => 
                        tag.toLowerCase().includes(searchTerm));
                    if (!inTitle && !inTags) {
                        return false;
                    }
                }
                if (categoryFilter && video.parentTname !== categoryFilter) {
                    return false;
                }
                if (stateFilter) {
                    if (stateFilter === 'other') {
                        if (video.state === 0 || video.state === -40) return false;
                    } else {
                        if (video.state !== parseInt(stateFilter)) return false;
                    }
                }
                return true;
            });

            // 排序
            filteredVideos.sort((a, b) => {
                switch (sortBy) {
                    case 'time-desc':
                        return new Date(b.pubTime || 0) - new Date(a.pubTime || 0);
                    case 'time-asc':
                        return new Date(a.pubTime || 0) - new Date(b.pubTime || 0);
                    case 'views-desc':
                        return (b.stats.view || 0) - (a.stats.view || 0);
                    case 'views-asc':
                        return (a.stats.view || 0) - (b.stats.view || 0);
                    case 'likes-desc':
                        return (b.stats.like || 0) - (a.stats.like || 0);
                    case 'likes-asc':
                        return (a.stats.like || 0) - (b.stats.like || 0);
                    default:
                        return 0;
                }
            });

            currentPage = 1;
            displayVideos();
        }

        function displayVideos() {
            let videosToShow = filteredVideos;
            
            // 处理分页
            if (videosPerPage !== 'all') {
                const pageSize = parseInt(videosPerPage);
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                videosToShow = filteredVideos.slice(startIndex, endIndex);
            }

            const tbody = document.getElementById('video-tbody');
            tbody.innerHTML = videosToShow.map(video => {
                const isHidden = video.isOnlySelf || false;
                const isCharging = video.isCharging || false;
                const hiddenBadge = isHidden ? '<span class="state-badge badge-hidden">仅自己可见</span>' : '';
                const chargingBadge = isCharging ? '<span class="state-badge badge-charging">充电专属</span>' : '';
                
                const tagsHtml = video.tags && video.tags.length > 0 ? 
                    `<div class="video-tags">
                        ${video.tags.slice(0, 3).map(tag => 
                            `<span class="video-tag">${tag}</span>`
                        ).join('')}
                        ${video.tags.length > 3 ? `<span class="video-tag">+${video.tags.length - 3}</span>` : ''}
                    </div>` : '';
                
                // 根据视频类型决定显示的操作按钮
                let actionButtons = '';
                if (isCharging) {
                    // 充电视频显示提示信息，不能隐藏
                    actionButtons = `<span style="color: #999; font-size: 12px;">充电视频不支持隐藏</span>`;
                } else {
                    // 普通视频可以隐藏/显示
                    actionButtons = isHidden ? 
                        `<button class="btn-show" onclick="showVideo('${video.aid}')">显示</button>` :
                        `<button class="btn-hide" onclick="hideVideo('${video.aid}')">隐藏</button>`;
                }
                
                return `
                    <tr>
                        <td class="video-title-cell">
                            <a href="${video.url}" target="_blank" class="video-title-link">${video.title}</a>
                            ${tagsHtml}
                        </td>
                        <td>${video.parentTname || '未分类'}</td>
                        <td class="video-stats-cell">${formatNumber(video.stats.view)}</td>
                        <td class="video-stats-cell">${formatNumber(video.stats.like)}</td>
                        <td class="video-stats-cell">${formatNumber(video.stats.coin)}</td>
                        <td class="video-stats-cell">${formatNumber(video.stats.favorite)}</td>
                        <td>
                            <span class="state-badge ${getStateBadgeClass(video.state)}">${video.stateDesc}</span>
                            ${chargingBadge}
                            ${hiddenBadge}
                        </td>
                        <td>
                            <div class="video-actions">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            if (videosPerPage === 'all') {
                document.getElementById('current-page').textContent = '1';
                document.getElementById('total-pages').textContent = '1';
                document.querySelector('#pagination button[onclick="changePage(-1)"]').disabled = true;
                document.querySelector('#pagination button[onclick="changePage(1)"]').disabled = true;
            } else {
                const pageSize = parseInt(videosPerPage);
                const totalPages = Math.ceil(filteredVideos.length / pageSize);
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                
                document.querySelector('#pagination button[onclick="changePage(-1)"]').disabled = currentPage <= 1;
                document.querySelector('#pagination button[onclick="changePage(1)"]').disabled = currentPage >= totalPages;
            }
        }

        function changePage(direction) {
            if (videosPerPage === 'all') return;
            
            const pageSize = parseInt(videosPerPage);
            const totalPages = Math.ceil(filteredVideos.length / pageSize);
            currentPage = Math.max(1, Math.min(currentPage + direction, totalPages));
            displayVideos();
            window.scrollTo(0, 0);
        }

        function changePageSize() {
            const select = document.getElementById('page-size-select');
            videosPerPage = select.value;
            currentPage = 1;
            displayVideos();
        }

        function getStateBadgeClass(state) {
            switch (state) {
                case 0: return 'state-published';
                case -40: return 'state-publishing';
                case -50: return 'state-unpublished';  // 仅自己可见状态
                default: return 'state-unpublished';
            }
        }

        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            }
            return num.toLocaleString();
        }

        async function refreshData() {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (confirm('确定要重新获取最新数据吗？这可能需要几分钟时间。')) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = '正在获取最新数据...';
                document.getElementById('video-table-container').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';

                try {
                    const response = await fetch('/api/refresh', { method: 'POST' });
                    if (response.ok) {
                        await loadData();
                        if (currentTab === 'tags') {
                            await loadTags();
                        }
                    } else {
                        alert('刷新失败，请稍后重试');
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('video-table-container').style.display = 'block';
                        document.getElementById('pagination').style.display = 'flex';
                    }
                } catch (error) {
                    console.error('刷新失败:', error);
                    alert('刷新失败，请稍后重试');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('video-table-container').style.display = 'block';
                    document.getElementById('pagination').style.display = 'flex';
                }
            }
        }

        // 加载视频统计信息
        async function loadVideoStats() {
            try {
                const response = await fetch('/api/videos/stats');
                const stats = await response.json();
                
                document.getElementById('normal-count').textContent = stats.normal || 0;
                document.getElementById('charging-count').textContent = stats.charging || 0;
                document.getElementById('hidden-count').textContent = stats.hidden || 0;
                document.getElementById('published-count').textContent = stats.published || 0;
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 批量隐藏所有普通视频
        async function batchHideNormalVideos() {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            const stats = await (await fetch('/api/videos/stats')).json();
            const toHide = stats.published - stats.charging - stats.hidden;
            
            if (toHide <= 0) {
                alert('没有可以隐藏的普通视频');
                return;
            }

            if (!confirm(`确定要隐藏所有普通视频吗？\n预计将隐藏 ${toHide} 个视频\n\n注意：此操作可能需要较长时间`)) {
                return;
            }

            showProcessing(`正在批量隐藏普通视频...`);

            try {
                const response = await fetch('/api/videos/batch-hide-normal', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    let message = `处理完成！\n`;
                    if (result.results) {
                        message += `成功: ${result.results.success.length}个\n`;
                        message += `失败: ${result.results.failed.length}个\n`;
                        message += `跳过: ${result.results.skipped.length}个`;
                        
                        if (result.results.failed.length > 0) {
                            console.error('失败的视频:', result.results.failed);
                        }
                    }
                    alert(message);
                    await loadData();
                    await loadVideoStats();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量隐藏失败:', error);
                alert('操作失败，请重试');
            } finally {
                hideProcessing();
            }
        }

        // 批量删除所有充电视频
        async function batchDeleteChargingVideos() {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            const stats = await (await fetch('/api/videos/stats')).json();
            
            if (stats.charging <= 0) {
                alert('没有充电视频需要删除');
                return;
            }

            if (!confirm(`确定要删除所有充电视频吗？\n将删除 ${stats.charging} 个充电视频\n\n警告：此操作不可恢复！`)) {
                return;
            }

            // 二次确认
            if (!confirm(`再次确认：真的要删除 ${stats.charging} 个充电视频吗？\n删除后无法恢复！`)) {
                return;
            }

            showProcessing(`正在删除充电视频...`);

            try {
                const response = await fetch('/api/videos/batch-delete-charging', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    let message = `处理完成！\n`;
                    if (result.results) {
                        message += `成功删除: ${result.results.success.length}个\n`;
                        message += `删除失败: ${result.results.failed.length}个`;
                        
                        if (result.results.failed.length > 0) {
                            console.error('删除失败的视频:', result.results.failed);
                        }
                    }
                    alert(message);
                    await loadData();
                    await loadVideoStats();
                } else {
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                alert('操作失败，请重试');
            } finally {
                hideProcessing();
            }
        }

        // 删除单个视频
        async function deleteVideo(aid) {
            if (!hasCookie) {
                alert('请先设置Cookie');
                showCookieModal();
                return;
            }

            if (!confirm('确定要删除此视频吗？此操作不可恢复！')) {
                return;
            }

            try {
                const response = await fetch(`/api/video/${aid}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('视频已删除');
                    await loadData();
                    await loadVideoStats();
                } else {
                    alert('删除失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除视频失败:', error);
                alert('删除失败，请重试');
            }
        }

        // 页面加载时初始化
        async function init() {
            await checkCookieStatus();
            await loadData();
            await loadVideoStats();
        }

        init();
    </script>
</body>
</html>