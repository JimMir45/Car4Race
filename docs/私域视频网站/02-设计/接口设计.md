# 接口设计

## 1. 接口规范

### 1.1 基本约定

| 项目 | 规范 |
|-----|------|
| 协议 | HTTP/HTTPS |
| 基础路径 | `/api/v1` |
| 数据格式 | JSON |
| 字符编码 | UTF-8 |
| 时间格式 | ISO 8601 (`2025-01-15T10:30:00Z`) |

### 1.2 请求格式

```http
POST /api/v1/orders HTTP/1.1
Host: example.com
Content-Type: application/json
Authorization: Bearer <token>

{
  "course_id": 1,
  "payment_type": "payment"
}
```

### 1.3 响应格式

#### 成功响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 响应数据
  }
}
```

#### 错误响应

```json
{
  "code": 40001,
  "message": "课程不存在",
  "data": null
}
```

### 1.4 错误码定义

| 错误码 | 说明 | HTTP 状态码 |
|-------|------|------------|
| 0 | 成功 | 200 |
| 40001 | 请求参数错误 | 400 |
| 40002 | 资源不存在 | 404 |
| 40003 | Token 无效或已过期 | 401 |
| 40004 | 下载次数已用完 | 403 |
| 40005 | 未登录或登录已过期 | 401 |
| 40006 | 无权限访问 | 403 |
| 40007 | 验证码错误或已过期 | 400 |
| 40008 | 手机号已注册 | 400 |
| 40009 | 邀请码无效或已使用 | 400 |
| 40010 | 访问频率超限 | 429 |
| 40011 | 游客排队中，请稍后再试 | 503 |
| 50001 | 服务器内部错误 | 500 |

### 1.5 认证方式

采用 JWT（JSON Web Token）认证：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Token 有效期**：7 天

**Token 载荷**：
```json
{
  "user_id": 1,
  "username": "202601156826",
  "role": "user",
  "exp": 1737014400
}
```

### 1.6 分页参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| page | int | 1 | 页码 |
| page_size | int | 10 | 每页数量（最大 50）|

分页响应格式：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [...],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 100,
      "total_pages": 10
    }
  }
}
```

## 2. 接口列表

### 2.1 接口总览

| 模块 | 接口 | 方法 | 认证 | 说明 |
|-----|------|------|-----|------|
| **认证** | `/api/v1/auth/sms/send` | POST | 否 | 发送短信验证码 |
| | `/api/v1/auth/register` | POST | 否 | 用户注册 |
| | `/api/v1/auth/login` | POST | 否 | 用户登录 |
| **用户** | `/api/v1/user/profile` | GET | 是 | 获取个人信息 |
| | `/api/v1/user/orders` | GET | 是 | 获取我的订单 |
| | `/api/v1/user/browse-history` | GET | 是 | 获取浏览记录 |
| | `/api/v1/user/download-history` | GET | 是 | 获取下载记录 |
| **分类** | `/api/v1/categories` | GET | 否 | 获取分类列表 |
| **笔记** | `/api/v1/notes` | GET | 否 | 获取笔记列表 |
| | `/api/v1/notes/:slug` | GET | 否 | 获取笔记详情 |
| **课程** | `/api/v1/courses` | GET | 否 | 获取课程列表 |
| | `/api/v1/courses/:slug` | GET | 否 | 获取课程详情 |
| **订单** | `/api/v1/orders` | POST | 是 | 创建订单 |
| | `/api/v1/orders/redeem` | POST | 是 | 邀请码兑换 |
| **下载** | `/api/v1/download/:token` | GET | 是 | 获取下载信息 |
| | `/api/v1/download/:token/file` | GET | 是 | 下载文件 |
| **公告** | `/api/v1/announcements` | GET | 否 | 获取公告列表 |
| **统计** | `/api/v1/stats/pv` | POST | 否 | 记录页面访问 |
| **系统** | `/api/v1/system/queue-status` | GET | 否 | 获取排队状态 |
| **站长** | `/api/v1/admin/invite-codes` | POST | 是 | 创建邀请码 |
| | `/api/v1/admin/invite-codes` | GET | 是 | 获取邀请码列表 |
| | `/api/v1/admin/courses` | POST | 是 | 创建/更新课程 |

## 3. 接口详细设计

### 3.1 认证模块

#### POST /api/v1/auth/sms/send

发送短信验证码。

**频率限制**：同一手机号 60 秒内只能发送 1 次

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| phone | string | 是 | 手机号（11位） |

**请求示例**：

```json
{
  "phone": "13800138000"
}
```

**响应示例（成功）**：

```json
{
  "code": 0,
  "message": "验证码已发送",
  "data": {
    "expire_seconds": 300
  }
}
```

**响应示例（频率限制）**：

```json
{
  "code": 40010,
  "message": "请求过于频繁，请60秒后再试",
  "data": null
}
```

---

#### POST /api/v1/auth/register

用户注册（手机号+验证码）。

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| phone | string | 是 | 手机号 |
| code | string | 是 | 短信验证码（6位） |

**请求示例**：

```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应示例（成功）**：

```json
{
  "code": 0,
  "message": "注册成功",
  "data": {
    "user_id": 1,
    "username": "202601156826",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**用户名生成规则**：`YYYYMMDD` + 手机号后4位，如 `202601156826`

**响应示例（手机号已注册）**：

```json
{
  "code": 40008,
  "message": "该手机号已注册，请直接登录",
  "data": null
}
```

---

#### POST /api/v1/auth/login

用户登录（手机号+验证码）。

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| phone | string | 是 | 手机号 |
| code | string | 是 | 短信验证码（6位） |

**请求示例**：

```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**响应示例（成功）**：

```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "user_id": 1,
    "username": "202601156826",
    "role": "user",
    "is_vip": false,
    "vip_expire_at": null,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

### 3.2 用户模块

#### GET /api/v1/user/profile

获取当前用户个人信息。

**请求头**：`Authorization: Bearer <token>`

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "user_id": 1,
    "username": "202601156826",
    "phone": "138****8000",
    "role": "user",
    "is_vip": false,
    "vip_expire_at": null,
    "year_spent": 500.00,
    "vip_threshold": 2000.00,
    "vip_progress": 25,
    "created_at": "2025-01-15T10:00:00Z"
  }
}
```

**字段说明**：

| 字段 | 说明 |
|-----|------|
| is_vip | 是否为会员（年消费满2000元） |
| vip_expire_at | 会员到期时间（非会员为 null） |
| year_spent | 今年已消费金额（不含邀请码） |
| vip_threshold | 会员触发门槛（2000元） |
| vip_progress | 会员进度百分比（year_spent / vip_threshold * 100） |

---

#### GET /api/v1/user/orders

获取我的订单列表。

**请求头**：`Authorization: Bearer <token>`

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 10 |

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "order_no": "HPA20250115100001",
        "course": {
          "id": 1,
          "name": "Go 语言入门到实战",
          "slug": "go-beginner",
          "cover_image": "/static/covers/go-beginner.png"
        },
        "amount": 99.00,
        "payment_type": "payment",
        "payment_type_text": "在线支付",
        "status": "paid",
        "status_text": "已完成",
        "download_token": "abc123def456",
        "download_remaining": 2,
        "download_expire_at": "2025-01-22T10:00:00Z",
        "created_at": "2025-01-15T10:00:00Z"
      },
      {
        "order_no": "HPA20250115100002",
        "course": {
          "id": 2,
          "name": "Docker 实战课程",
          "slug": "docker-course",
          "cover_image": "/static/covers/docker.png"
        },
        "amount": 0.00,
        "payment_type": "invite",
        "payment_type_text": "邀请码兑换",
        "status": "paid",
        "status_text": "已完成",
        "download_token": "xyz789abc123",
        "download_remaining": 3,
        "download_expire_at": "2025-01-22T12:00:00Z",
        "created_at": "2025-01-15T12:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 2,
      "total_pages": 1
    }
  }
}
```

---

#### GET /api/v1/user/browse-history

获取浏览记录。

**请求头**：`Authorization: Bearer <token>`

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| type | string | 否 | 类型筛选：note/course，默认全部 |
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 20 |

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "type": "note",
        "target_id": 5,
        "title": "Go 并发编程指南",
        "slug": "go-concurrency-guide",
        "cover_image": null,
        "viewed_at": "2025-01-15T14:30:00Z"
      },
      {
        "id": 2,
        "type": "course",
        "target_id": 1,
        "title": "Go 语言入门到实战",
        "slug": "go-beginner",
        "cover_image": "/static/covers/go-beginner.png",
        "viewed_at": "2025-01-15T14:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 2,
      "total_pages": 1
    }
  }
}
```

---

#### GET /api/v1/user/download-history

获取下载记录。

**请求头**：`Authorization: Bearer <token>`

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 20 |

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "course": {
          "id": 1,
          "name": "Go 语言入门到实战",
          "slug": "go-beginner"
        },
        "file_name": "go-beginner.zip",
        "file_size_display": "1.0 GB",
        "ip": "192.168.1.***",
        "downloaded_at": "2025-01-15T15:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  }
}
```

---

### 3.3 分类模块

#### GET /api/v1/categories

获取笔记分类列表。

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "Go 语言",
      "slug": "golang",
      "description": "Go 语言学习笔记",
      "note_count": 15
    },
    {
      "id": 2,
      "name": "云原生",
      "slug": "cloud-native",
      "description": "Docker、K8s 相关",
      "note_count": 8
    }
  ]
}
```

---

### 3.4 笔记模块

#### GET /api/v1/notes

获取笔记列表。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| category | string | 否 | 分类 slug 筛选 |
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 10 |

**请求示例**：

```
GET /api/v1/notes?category=golang&page=1&page_size=10
```

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "title": "Go 并发编程指南",
        "slug": "go-concurrency-guide",
        "category": {
          "id": 1,
          "name": "Go 语言",
          "slug": "golang"
        },
        "summary": "本文介绍 Go 语言的并发编程模型...",
        "view_count": 1234,
        "created_at": "2025-01-10T08:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 15,
      "total_pages": 2
    }
  }
}
```

---

#### GET /api/v1/notes/:slug

获取笔记详情（包含完整内容）。

**路径参数**：

| 参数 | 类型 | 说明 |
|-----|------|------|
| slug | string | 笔记的 URL 标识 |

**请求示例**：

```
GET /api/v1/notes/go-concurrency-guide
```

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "title": "Go 并发编程指南",
    "slug": "go-concurrency-guide",
    "category": {
      "id": 1,
      "name": "Go 语言",
      "slug": "golang"
    },
    "content": "# Go 并发编程指南\n\n## 1. Goroutine\n\nGoroutine 是 Go 语言的轻量级线程...",
    "view_count": 1235,
    "created_at": "2025-01-10T08:00:00Z",
    "updated_at": "2025-01-12T10:30:00Z",
    "prev_note": {
      "slug": "go-basic-syntax",
      "title": "Go 基础语法"
    },
    "next_note": {
      "slug": "go-channel-patterns",
      "title": "Go Channel 使用模式"
    }
  }
}
```

---

### 3.5 课程模块

#### GET /api/v1/courses

获取课程列表。

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| sort_by | string | 否 | 排序方式，默认 `default` |
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 10 |

**排序方式（sort_by）**：

| 值 | 说明 |
|---|------|
| default | 默认排序（站长设定的 sort_order） |
| view_count | 按点击量降序 |
| download_count | 按下载量降序 |
| updated_at | 按更新时间降序 |

**请求示例**：

```
GET /api/v1/courses?sort_by=download_count&page=1&page_size=10
```

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "Go 语言入门到实战",
        "slug": "go-beginner",
        "price": 99.00,
        "description": "Go 语言从零基础到项目实战",
        "cover_image": "/static/covers/go-beginner.png",
        "view_count": 1500,
        "download_count": 120,
        "created_at": "2025-01-01T00:00:00Z",
        "updated_at": "2025-01-10T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 2,
      "total_pages": 1
    },
    "current_sort": "download_count"
  }
}
```

---

#### GET /api/v1/courses/:slug

获取课程详情。

**路径参数**：

| 参数 | 类型 | 说明 |
|-----|------|------|
| slug | string | 课程的 URL 标识 |

**请求头**（可选）：`Authorization: Bearer <token>`

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "name": "Go 语言入门到实战",
    "slug": "go-beginner",
    "price": 99.00,
    "description": "## 课程介绍\n\n本课程适合零基础学员...\n\n## 课程大纲\n\n1. Go 语言简介\n2. 基础语法\n...",
    "cover_image": "/static/covers/go-beginner.png",
    "file_size": 1073741824,
    "file_size_display": "1.0 GB",
    "view_count": 1500,
    "download_count": 120,
    "is_purchased": false,
    "is_vip": false,
    "can_download": false,
    "created_at": "2025-01-01T00:00:00Z",
    "updated_at": "2025-01-10T00:00:00Z"
  }
}
```

**字段说明**：

| 字段 | 说明 |
|-----|------|
| is_purchased | 当前用户是否已购买（未登录为 false） |
| is_vip | 当前用户是否为会员 |
| can_download | 是否可以下载（已购买或会员） |

---

### 3.6 订单模块

#### POST /api/v1/orders

创建订单（第三方支付方式）。

**请求头**：`Authorization: Bearer <token>`

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| course_id | int | 是 | 课程 ID |
| payment_ref | string | 是 | 支付凭证（订单号后 4 位） |

**请求示例**：

```json
{
  "course_id": 1,
  "payment_ref": "1234"
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "购买成功",
  "data": {
    "order_no": "HPA20250115100001",
    "amount": 99.00,
    "download_token": "abc123def456",
    "download_url": "/api/v1/download/abc123def456",
    "expire_at": "2025-01-22T10:00:00Z",
    "max_download": 3,
    "new_year_spent": 599.00,
    "became_vip": false
  }
}
```

**会员升级响应**（年消费达到 2000 元时）：

```json
{
  "code": 0,
  "message": "购买成功，恭喜您成为年度会员！",
  "data": {
    "order_no": "HPA20250115100001",
    "amount": 199.00,
    "download_token": "abc123def456",
    "download_url": "/api/v1/download/abc123def456",
    "expire_at": "2025-01-22T10:00:00Z",
    "max_download": 3,
    "new_year_spent": 2100.00,
    "became_vip": true,
    "vip_expire_at": "2026-01-15T10:00:00Z"
  }
}
```

---

#### POST /api/v1/orders/redeem

邀请码兑换课程。

**请求头**：`Authorization: Bearer <token>`

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| course_id | int | 是 | 课程 ID |
| invite_code | string | 是 | 邀请码 |

**请求示例**：

```json
{
  "course_id": 1,
  "invite_code": "ABCD1234"
}
```

**响应示例（成功）**：

```json
{
  "code": 0,
  "message": "兑换成功",
  "data": {
    "order_no": "HPA20250115100002",
    "amount": 0.00,
    "download_token": "xyz789abc123",
    "download_url": "/api/v1/download/xyz789abc123",
    "expire_at": "2025-01-22T10:00:00Z",
    "max_download": 3
  }
}
```

**响应示例（邀请码无效）**：

```json
{
  "code": 40009,
  "message": "邀请码无效或已被使用",
  "data": null
}
```

---

### 3.7 下载模块

#### GET /api/v1/download/:token

验证下载令牌并获取下载信息。

**请求头**：`Authorization: Bearer <token>`

**路径参数**：

| 参数 | 类型 | 说明 |
|-----|------|------|
| token | string | 下载令牌 |

**响应示例（成功）**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "course_name": "Go 语言入门到实战",
    "file_name": "go-beginner.zip",
    "file_size": 1073741824,
    "file_size_display": "1.0 GB",
    "remaining_downloads": 2,
    "expire_at": "2025-01-22T10:00:00Z",
    "download_url": "/api/v1/download/abc123def456/file"
  }
}
```

**响应示例（令牌过期）**：

```json
{
  "code": 40003,
  "message": "下载链接已过期，请重新购买或联系客服",
  "data": null
}
```

**响应示例（下载次数用完）**：

```json
{
  "code": 40004,
  "message": "下载次数已用完，请联系客服",
  "data": null
}
```

---

#### GET /api/v1/download/:token/file

下载课程文件。

**请求头**：`Authorization: Bearer <token>`

**路径参数**：

| 参数 | 类型 | 说明 |
|-----|------|------|
| token | string | 下载令牌 |

**响应**：

成功时返回文件流，设置以下响应头：

```http
HTTP/1.1 200 OK
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="go-beginner.zip"
Content-Length: 1073741824
```

---

### 3.8 公告模块

#### GET /api/v1/announcements

获取公告列表（仅返回有效期内的公告）。

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "content": "恭喜用户 202601156826 成为年度会员！",
      "type": "vip",
      "expire_at": "2025-01-18T10:00:00Z"
    }
  ]
}
```

---

### 3.9 统计模块

#### POST /api/v1/stats/pv

记录页面访问（前端埋点调用）。

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| path | string | 是 | 页面路径 |
| referer | string | 否 | 来源页面 |

**请求示例**：

```json
{
  "path": "/notes/go-concurrency-guide",
  "referer": "https://google.com"
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

---

### 3.10 系统模块

#### GET /api/v1/system/queue-status

获取游客排队状态。

**请求参数**：无

**响应示例（无需排队）**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "need_queue": false,
    "current_online": 35,
    "max_online": 50
  }
}
```

**响应示例（需要排队）**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "need_queue": true,
    "queue_position": 5,
    "estimated_wait_seconds": 60,
    "current_online": 50,
    "max_online": 50
  }
}
```

---

### 3.11 站长管理模块

> 以下接口仅站长（role = 'admin'）可访问

#### POST /api/v1/admin/invite-codes

创建邀请码。

**请求头**：`Authorization: Bearer <token>`（站长 Token）

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| count | int | 否 | 生成数量，默认 1，最大 100 |
| remark | string | 否 | 备注说明 |

**请求示例**：

```json
{
  "count": 5,
  "remark": "公众号活动赠送"
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "codes": [
      "ABCD1234",
      "EFGH5678",
      "IJKL9012",
      "MNOP3456",
      "QRST7890"
    ],
    "count": 5
  }
}
```

---

#### GET /api/v1/admin/invite-codes

获取邀请码列表。

**请求头**：`Authorization: Bearer <token>`（站长 Token）

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| status | string | 否 | 筛选状态：unused/used，默认全部 |
| page | int | 否 | 页码，默认 1 |
| page_size | int | 否 | 每页数量，默认 20 |

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "code": "ABCD1234",
        "status": "unused",
        "remark": "公众号活动赠送",
        "used_by": null,
        "used_at": null,
        "created_at": "2025-01-15T10:00:00Z"
      },
      {
        "id": 2,
        "code": "EFGH5678",
        "status": "used",
        "remark": "公众号活动赠送",
        "used_by": {
          "user_id": 5,
          "username": "202601151234"
        },
        "used_at": "2025-01-15T12:00:00Z",
        "created_at": "2025-01-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 10,
      "total_pages": 1
    },
    "summary": {
      "total": 10,
      "unused": 5,
      "used": 5
    }
  }
}
```

---

#### POST /api/v1/admin/courses

创建或更新课程。

**请求头**：`Authorization: Bearer <token>`（站长 Token）

**请求体**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| id | int | 否 | 课程 ID（更新时必填） |
| name | string | 是 | 课程名称 |
| slug | string | 是 | URL 标识 |
| price | float | 是 | 价格（元） |
| description | string | 否 | 课程描述（Markdown） |
| cover_image | string | 否 | 封面图片路径 |
| file_name | string | 是 | 课程文件名 |
| sort_order | int | 否 | 排序权重，默认 0 |

**请求示例（创建）**：

```json
{
  "name": "Go 语言入门到实战",
  "slug": "go-beginner",
  "price": 99.00,
  "description": "Go 语言从零基础到项目实战",
  "cover_image": "/static/covers/go-beginner.png",
  "file_name": "go-beginner.zip",
  "sort_order": 1
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "id": 1,
    "slug": "go-beginner"
  }
}
```

---

## 4. 接口安全

### 4.1 安全措施总览

| 安全措施 | 优先级 | 防护目标 | 实现位置 |
|---------|-------|---------|---------|
| HTTPS 强制 | **P0** | 传输层窃听、中间人攻击 | Nginx |
| 参数化查询 | **P0** | SQL 注入 | 后端 ORM |
| 输入验证 | **P0** | 注入攻击、非法数据 | 后端中间件 |
| 输出编码 | **P0** | XSS 跨站脚本 | 前端框架 |
| JWT 认证 | **P0** | 身份伪造、未授权访问 | 后端中间件 |
| 频率限制 | **P0** | DDoS、暴力破解 | 后端中间件 |
| 安全响应头 | **P0** | XSS、点击劫持 | 后端中间件 |
| CSRF 防护 | **P1** | 跨站请求伪造 | 前后端配合 |
| 敏感数据脱敏 | **P1** | 信息泄露 | 后端响应处理 |
| 日志脱敏 | **P1** | 日志泄露敏感信息 | 后端日志模块 |
| 请求签名 | **P2** | 参数篡改、重放攻击 | 前后端配合 |

---

### 4.2 传输安全（P0）

#### 4.2.1 HTTPS 强制

**Nginx 配置**：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    # 强制跳转 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;

    # HSTS 头（强制浏览器使用 HTTPS）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
```

#### 4.2.2 敏感数据传输

| 数据类型 | 传输要求 | 说明 |
|---------|---------|------|
| 手机号 | POST body | 不出现在 URL |
| 验证码 | POST body | 不出现在 URL |
| JWT Token | Authorization Header | 不出现在 URL |
| 支付凭证 | POST body | 不出现在 URL |
| 邀请码 | POST body | 不出现在 URL |

---

### 4.3 注入攻击防护（P0）

#### 4.3.1 SQL 注入防护

**错误示例（绝对禁止）**：

```go
// ❌ 危险：字符串拼接 SQL
query := "SELECT * FROM users WHERE phone = '" + phone + "'"
db.Raw(query).Scan(&user)
```

**正确示例（必须使用）**：

```go
// ✅ 安全：参数化查询
db.Where("phone = ?", phone).First(&user)

// ✅ 安全：GORM 链式调用
db.Model(&Course{}).
    Where("id = ?", courseID).
    Where("status = ?", "active").
    First(&course)

// ✅ 安全：命名参数
db.Where("phone = @phone AND status = @status",
    sql.Named("phone", phone),
    sql.Named("status", "active")).First(&user)
```

**ORM 框架自动防护**：

```go
// GORM 自动转义，以下均安全
db.Create(&user)                    // INSERT
db.Save(&user)                      // UPDATE
db.Delete(&user)                    // DELETE
db.Where("id = ?", id).First(&u)    // SELECT
```

#### 4.3.2 输入验证（白名单策略）

```go
// 输入验证中间件
func ValidateInput() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 所有输入参数必须通过验证才能使用
        c.Next()
    }
}

// 手机号验证 - 严格11位数字格式
func validatePhone(phone string) bool {
    matched, _ := regexp.MatchString(`^1[3-9]\d{9}$`, phone)
    return matched
}

// 验证码验证 - 严格6位数字
func validateSMSCode(code string) bool {
    matched, _ := regexp.MatchString(`^\d{6}$`, code)
    return matched
}

// 邀请码验证 - 严格8位大写字母数字
func validateInviteCode(code string) bool {
    matched, _ := regexp.MatchString(`^[A-Z0-9]{8}$`, code)
    return matched
}

// Slug 验证 - 只允许小写字母、数字、连字符
func validateSlug(slug string) bool {
    if len(slug) == 0 || len(slug) > 200 {
        return false
    }
    matched, _ := regexp.MatchString(`^[a-z0-9][a-z0-9-]*[a-z0-9]$`, slug)
    return matched
}

// 分页参数验证 - 限制范围
func validatePagination(page, pageSize int) (int, int) {
    if page < 1 {
        page = 1
    }
    if pageSize < 1 {
        pageSize = 10
    }
    if pageSize > 50 {
        pageSize = 50  // 最大50条
    }
    return page, pageSize
}

// 排序参数验证 - 白名单
func validateSortBy(sortBy string) string {
    allowed := map[string]bool{
        "default":        true,
        "view_count":     true,
        "download_count": true,
        "updated_at":     true,
    }
    if allowed[sortBy] {
        return sortBy
    }
    return "default"  // 非法值返回默认
}
```

---

### 4.4 XSS 防护（P0）

#### 4.4.1 后端输出编码

```go
import "html"

// 对用户生成内容进行 HTML 转义
func sanitizeOutput(input string) string {
    return html.EscapeString(input)
}

// 响应时自动处理
type UserResponse struct {
    Username string `json:"username"`
    // 前端框架（Vue/React）会自动转义，但后端也做一层保险
}
```

#### 4.4.2 前端框架自动防护

```javascript
// Vue 3 自动转义（默认行为）
<template>
  <div>{{ userContent }}</div>  <!-- 自动转义，安全 -->
</template>

// ❌ 危险：v-html 绕过转义，仅用于可信内容
<div v-html="trustedHtml"></div>

// Markdown 渲染需要使用安全的库
import DOMPurify from 'dompurify'
import { marked } from 'marked'

const safeHtml = DOMPurify.sanitize(marked(markdownContent))
```

#### 4.4.3 安全响应头

```go
func SecurityHeadersMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 防止 MIME 类型嗅探
        c.Header("X-Content-Type-Options", "nosniff")

        // XSS 过滤器（旧浏览器）
        c.Header("X-XSS-Protection", "1; mode=block")

        // 防止点击劫持
        c.Header("X-Frame-Options", "DENY")

        // 内容安全策略
        c.Header("Content-Security-Policy",
            "default-src 'self'; "+
            "script-src 'self'; "+
            "style-src 'self' 'unsafe-inline'; "+
            "img-src 'self' data:; "+
            "font-src 'self'; "+
            "connect-src 'self'")

        // 禁止浏览器缓存敏感页面
        if strings.HasPrefix(c.Request.URL.Path, "/api/v1/user") {
            c.Header("Cache-Control", "no-store, no-cache, must-revalidate")
            c.Header("Pragma", "no-cache")
        }

        c.Next()
    }
}
```

---

### 4.5 CSRF 防护（P1）

#### 4.5.1 防护策略

本项目采用 **JWT + SameSite Cookie** 双重防护：

| 策略 | 说明 |
|-----|------|
| JWT 存储在 localStorage | 不自动携带，天然防 CSRF |
| SameSite Cookie | 登录态 Cookie 设置 SameSite=Strict |
| Referer 校验 | 可选，校验请求来源 |

#### 4.5.2 实现方式

**方式一：JWT 存 localStorage（当前采用）**

```javascript
// 前端：手动在请求头添加 Token
api.interceptors.request.use(config => {
    const token = localStorage.getItem('token')
    if (token) {
        config.headers.Authorization = `Bearer ${token}`
    }
    return config
})
```

因为 Token 不会被浏览器自动携带，所以天然防御 CSRF。

**方式二：如需 Cookie 存储 Token（可选增强）**

```go
// 后端：设置安全 Cookie
func SetAuthCookie(c *gin.Context, token string) {
    c.SetSameSite(http.SameSiteStrictMode)
    c.SetCookie(
        "auth_token",           // name
        token,                  // value
        7*24*3600,              // maxAge（7天）
        "/",                    // path
        "",                     // domain
        true,                   // secure（仅HTTPS）
        true,                   // httpOnly（JS不可读）
    )
}
```

**方式三：CSRF Token（高安全场景可选）**

```go
// 后端：生成 CSRF Token
func GenerateCSRFToken(c *gin.Context) {
    token := generateRandomString(32)
    c.SetCookie("csrf_token", token, 3600, "/", "", true, false)
    c.Header("X-CSRF-Token", token)
}

// 后端：验证 CSRF Token
func ValidateCSRFToken() gin.HandlerFunc {
    return func(c *gin.Context) {
        if c.Request.Method == "GET" {
            c.Next()
            return
        }

        cookieToken, _ := c.Cookie("csrf_token")
        headerToken := c.GetHeader("X-CSRF-Token")

        if cookieToken == "" || cookieToken != headerToken {
            c.JSON(403, gin.H{"code": 40012, "message": "CSRF token invalid"})
            c.Abort()
            return
        }
        c.Next()
    }
}
```

```javascript
// 前端：携带 CSRF Token
api.interceptors.request.use(config => {
    if (['POST', 'PUT', 'DELETE'].includes(config.method.toUpperCase())) {
        const csrfToken = getCookie('csrf_token')
        config.headers['X-CSRF-Token'] = csrfToken
    }
    return config
})
```

---

### 4.6 频率限制（P0）

#### 4.6.1 用户级频率限制

```go
// 注册用户每 15 秒限制一次接口调用
func UserRateLimitMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := getUserIDFromToken(c)
        if userID == 0 {
            c.Next() // 游客走游客限制
            return
        }

        key := fmt.Sprintf("rate_limit:user:%d", userID)

        // 使用内存缓存或 Redis
        if isRateLimited(key, 15*time.Second) {
            c.JSON(429, gin.H{
                "code":    40010,
                "message": "访问频率过高，请15秒后再试",
                "data": gin.H{
                    "retry_after": 15,
                },
            })
            c.Abort()
            return
        }

        setRateLimit(key, 15*time.Second)
        c.Next()
    }
}
```

#### 4.6.2 游客排队机制

```go
// 在线游客 IP 超过 50 时，新游客需排队
func GuestQueueMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := getUserIDFromToken(c)
        if userID != 0 {
            c.Next() // 登录用户直接通过
            return
        }

        clientIP := c.ClientIP()

        if !canGuestAccess(clientIP, 50) {
            position := getQueuePosition(clientIP)
            c.JSON(503, gin.H{
                "code":    40011,
                "message": "当前访问人数较多，请稍后再试",
                "data": gin.H{
                    "queue_position":         position,
                    "estimated_wait_seconds": position * 12,
                },
            })
            c.Abort()
            return
        }

        refreshGuestActivity(clientIP)
        c.Next()
    }
}
```

#### 4.6.3 接口频率限制汇总

| 接口 | 限制规则 | 优先级 |
|-----|---------|-------|
| POST /auth/sms/send | 同一手机号 60 秒 1 次 | P0 |
| POST /auth/register | 同一 IP 10 次/小时 | P0 |
| POST /auth/login | 同一 IP 20 次/小时 | P0 |
| POST /orders | 同一用户 1 分钟 1 次 | P0 |
| POST /orders/redeem | 同一用户 1 分钟 1 次 | P0 |
| GET /download/*/file | 5 次/小时/Token | P0 |
| 其他接口（登录用户） | 每用户 15 秒 1 次 | P0 |
| 其他接口（游客） | IP 池限制 50 个 | P0 |

---

### 4.7 敏感数据处理（P1）

#### 4.7.1 响应数据脱敏

```go
// 手机号脱敏：13812345678 → 138****5678
func maskPhone(phone string) string {
    if len(phone) != 11 {
        return "***"
    }
    return phone[:3] + "****" + phone[7:]
}

// IP 地址脱敏：192.168.1.100 → 192.168.1.***
func maskIP(ip string) string {
    parts := strings.Split(ip, ".")
    if len(parts) == 4 {
        return parts[0] + "." + parts[1] + "." + parts[2] + ".***"
    }
    return "***"
}

// 用户信息响应示例
type UserProfileResponse struct {
    UserID      int64   `json:"user_id"`
    Username    string  `json:"username"`
    Phone       string  `json:"phone"`        // 返回脱敏后的手机号
    Role        string  `json:"role"`
    YearSpent   float64 `json:"year_spent"`
    // 不返回密码、Token 等敏感字段
}
```

#### 4.7.2 日志脱敏

```go
// 日志中间件 - 脱敏敏感信息
func LoggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()

        c.Next()

        // 记录日志时脱敏
        log.Printf("[%s] %s %s - %d - %s - %s",
            c.Request.Method,
            c.Request.URL.Path,
            maskIP(c.ClientIP()),        // IP 脱敏
            c.Writer.Status(),
            time.Since(start),
            maskSensitiveParams(c),       // 参数脱敏
        )
    }
}

// 脱敏敏感参数
func maskSensitiveParams(c *gin.Context) string {
    // 不记录以下参数的真实值
    sensitiveKeys := []string{"phone", "code", "token", "password", "invite_code"}
    // 返回 "phone=138****5678" 格式
    // ...
}
```

#### 4.7.3 错误信息处理

```go
// ❌ 危险：暴露内部错误
c.JSON(500, gin.H{"error": err.Error()})  // 可能泄露数据库结构

// ✅ 安全：返回通用错误，详情记录日志
func handleError(c *gin.Context, err error) {
    // 记录详细错误到日志
    log.Printf("Error: %v", err)

    // 返回通用错误给客户端
    c.JSON(500, gin.H{
        "code":    50001,
        "message": "服务器内部错误，请稍后重试",
        "data":    nil,
    })
}
```

---

### 4.8 请求签名（P2 - 可选）

> 适用于高安全要求场景，MVP 阶段可暂不实现

#### 4.8.1 签名算法

```
签名 = HMAC-SHA256(请求方法 + 请求路径 + 时间戳 + 请求体Hash, SecretKey)
```

#### 4.8.2 后端验证

```go
func SignatureMiddleware(secretKey string) gin.HandlerFunc {
    return func(c *gin.Context) {
        timestamp := c.GetHeader("X-Timestamp")
        signature := c.GetHeader("X-Signature")

        // 验证时间戳（防重放，5分钟内有效）
        ts, _ := strconv.ParseInt(timestamp, 10, 64)
        if time.Now().Unix()-ts > 300 {
            c.JSON(401, gin.H{"code": 40013, "message": "请求已过期"})
            c.Abort()
            return
        }

        // 验证签名
        body, _ := io.ReadAll(c.Request.Body)
        c.Request.Body = io.NopCloser(bytes.NewBuffer(body))

        expectedSig := generateSignature(
            c.Request.Method,
            c.Request.URL.Path,
            timestamp,
            body,
            secretKey,
        )

        if signature != expectedSig {
            c.JSON(401, gin.H{"code": 40014, "message": "签名验证失败"})
            c.Abort()
            return
        }

        c.Next()
    }
}
```

#### 4.8.3 前端签名

```javascript
import CryptoJS from 'crypto-js'

function signRequest(method, path, body, secretKey) {
    const timestamp = Math.floor(Date.now() / 1000).toString()
    const bodyHash = body ? CryptoJS.SHA256(JSON.stringify(body)).toString() : ''
    const signString = `${method}${path}${timestamp}${bodyHash}`
    const signature = CryptoJS.HmacSHA256(signString, secretKey).toString()

    return { timestamp, signature }
}

// 使用示例
api.interceptors.request.use(config => {
    const { timestamp, signature } = signRequest(
        config.method.toUpperCase(),
        config.url,
        config.data,
        'your-secret-key'
    )
    config.headers['X-Timestamp'] = timestamp
    config.headers['X-Signature'] = signature
    return config
})
```

---

### 4.9 安全检查清单

#### MVP 上线前必须完成（P0）

- [ ] HTTPS 已启用，HTTP 自动跳转
- [ ] 所有数据库操作使用参数化查询
- [ ] 所有用户输入经过验证
- [ ] JWT Secret 已修改为强密码
- [ ] 安全响应头已配置
- [ ] 频率限制已启用
- [ ] 敏感接口（登录、支付）日志正常

#### 上线后建议完成（P1）

- [ ] CSRF 防护已实现（如使用 Cookie 存储 Token）
- [ ] 响应数据脱敏已实现
- [ ] 日志脱敏已实现
- [ ] 错误信息不暴露内部细节

#### 高安全场景可选（P2）

- [ ] 请求签名已实现
- [ ] API 调用审计日志
- [ ] 异常行为检测告警

## 5. 前端调用示例

### 5.1 认证相关

```javascript
// api/auth.js
import axios from 'axios'

const api = axios.create({
  baseURL: '/api/v1',
  timeout: 10000
})

// 请求拦截器：添加 Token
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 发送验证码
export async function sendSmsCode(phone) {
  const { data } = await api.post('/auth/sms/send', { phone })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

// 注册
export async function register(phone, code) {
  const { data } = await api.post('/auth/register', { phone, code })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  // 保存 Token
  localStorage.setItem('token', data.data.token)
  return data.data
}

// 登录
export async function login(phone, code) {
  const { data } = await api.post('/auth/login', { phone, code })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  localStorage.setItem('token', data.data.token)
  return data.data
}
```

### 5.2 课程列表与排序

```javascript
// api/course.js
export async function getCourses(params = {}) {
  const { data } = await api.get('/courses', { params })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

// 使用示例
// 默认排序
getCourses()

// 按点击量排序
getCourses({ sort_by: 'view_count' })

// 按下载量排序
getCourses({ sort_by: 'download_count' })

// 按更新时间排序
getCourses({ sort_by: 'updated_at' })
```

### 5.3 个人中心

```javascript
// api/user.js
export async function getProfile() {
  const { data } = await api.get('/user/profile')
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

export async function getOrders(page = 1) {
  const { data } = await api.get('/user/orders', { params: { page } })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

export async function getBrowseHistory(type = '', page = 1) {
  const { data } = await api.get('/user/browse-history', {
    params: { type, page }
  })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

export async function getDownloadHistory(page = 1) {
  const { data } = await api.get('/user/download-history', { params: { page } })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}
```

### 5.4 购买与邀请码兑换

```javascript
// api/order.js
// 第三方支付方式
export async function createOrder(courseId, paymentRef) {
  const { data } = await api.post('/orders', {
    course_id: courseId,
    payment_ref: paymentRef
  })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

// 邀请码兑换
export async function redeemInviteCode(courseId, inviteCode) {
  const { data } = await api.post('/orders/redeem', {
    course_id: courseId,
    invite_code: inviteCode
  })
  if (data.code !== 0) {
    throw new Error(data.message)
  }
  return data.data
}

// 下载文件
export function downloadFile(token) {
  const authToken = localStorage.getItem('token')
  // 带 Token 下载
  window.location.href = `/api/v1/download/${token}/file?token=${authToken}`
}
```

---

**文档版本**：v2.0
**创建日期**：2025-01-15
**最后更新**：2025-01-15
