# 数据库设计

## 1. 设计概述

### 1.1 设计原则

- **简单优先**：MVP 阶段只保留必要字段
- **扩展预留**：预留扩展字段，便于后续迭代
- **文件分离**：静态内容（笔记、课程文件）存储在文件系统，数据库只存元数据

### 1.2 存储策略

| 内容类型 | 存储位置 | 说明 |
|---------|---------|------|
| 笔记内容 | 文件系统 | Markdown 文件，按目录分类 |
| 课程文件 | 文件系统 | ZIP 压缩包 |
| 用户信息 | SQLite | 手机号、用户名、会员状态 |
| 笔记元数据 | SQLite | 标题、分类、路径、浏览次数 |
| 课程信息 | SQLite | 名称、价格、点击量、下载量 |
| 订单记录 | SQLite | 支付信息、下载 Token |
| 邀请码 | SQLite | 生成记录、使用记录 |
| 用户记录 | SQLite | 浏览记录、下载记录 |
| 访问统计 | SQLite | PV/UV 记录 |

## 2. 数据模型

### 2.1 ER 图

```
┌─────────────────┐
│     User        │
├─────────────────┤
│ id (PK)         │
│ username        │──────────────────────────────────┐
│ phone           │                                  │
│ role            │                                  │
│ year_spent      │                                  │
│ vip_expire_at   │                                  │
│ created_at      │                                  │
└────────┬────────┘                                  │
         │                                           │
         │ 1:N                                       │
         ▼                                           │
┌─────────────────┐       ┌─────────────────┐       │
│     Order       │       │   InviteCode    │       │
├─────────────────┤       ├─────────────────┤       │
│ id (PK)         │       │ id (PK)         │       │
│ user_id (FK)    │←──────│ used_by (FK)    │       │
│ course_id (FK)  │       │ course_id (FK)  │───────┤
│ amount          │       │ code            │       │
│ payment_type    │       │ created_at      │       │
│ status          │       │ used_at         │       │
└────────┬────────┘       └─────────────────┘       │
         │                                           │
         │ 1:N                                       │
         ▼                                           │
┌─────────────────┐                                  │
│ DownloadToken   │                                  │
├─────────────────┤                                  │
│ id (PK)         │                                  │
│ order_id (FK)   │                                  │
│ user_id (FK)    │──────────────────────────────────┤
│ token           │                                  │
│ expire_at       │                                  │
│ max_count       │                                  │
│ used_count      │                                  │
└─────────────────┘                                  │
                                                     │
┌─────────────────┐       ┌─────────────────┐       │
│  BrowseHistory  │       │DownloadHistory  │       │
├─────────────────┤       ├─────────────────┤       │
│ id (PK)         │       │ id (PK)         │       │
│ user_id (FK)    │←──────│ user_id (FK)    │←──────┘
│ content_type    │       │ course_id (FK)  │
│ content_id      │       │ created_at      │
│ created_at      │       └─────────────────┘
└─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│   Category      │       │     Course      │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │──┐    │ id (PK)         │
│ name            │  │    │ name            │
│ slug            │  │    │ slug            │
│ sort_order      │  │    │ price           │
└─────────────────┘  │    │ view_count      │
                     │    │ download_count  │
┌─────────────────┐  │    │ sort_order      │
│     Note        │  │    │ updated_at      │
├─────────────────┤  │    └─────────────────┘
│ id (PK)         │  │
│ title           │  │
│ category_id(FK) │←─┘
│ view_count      │
└─────────────────┘

┌─────────────────┐
│  Announcement   │
├─────────────────┤
│ id (PK)         │
│ content         │
│ type            │
│ start_at        │
│ end_at          │
└─────────────────┘
```

### 2.2 表结构详细设计

#### users - 用户表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| username | VARCHAR(20) | UNIQUE, NOT NULL | 用户名（日期+手机后4位） |
| phone | VARCHAR(20) | UNIQUE, NOT NULL | 手机号 |
| role | VARCHAR(20) | DEFAULT 'user' | 角色：user/vip/admin |
| year_spent | DECIMAL(10,2) | DEFAULT 0 | 年消费金额（不含邀请码） |
| vip_expire_at | DATETIME | | 会员到期时间 |
| created_at | DATETIME | DEFAULT NOW | 注册时间 |
| updated_at | DATETIME | | 更新时间 |

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(20) UNIQUE NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    role VARCHAR(20) DEFAULT 'user',
    year_spent DECIMAL(10,2) DEFAULT 0,
    vip_expire_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME
);

CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role ON users(role);
```

#### sms_codes - 短信验证码表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| phone | VARCHAR(20) | NOT NULL | 手机号 |
| code | VARCHAR(10) | NOT NULL | 验证码 |
| expire_at | DATETIME | NOT NULL | 过期时间 |
| used | BOOLEAN | DEFAULT 0 | 是否已使用 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE sms_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    phone VARCHAR(20) NOT NULL,
    code VARCHAR(10) NOT NULL,
    expire_at DATETIME NOT NULL,
    used BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sms_phone ON sms_codes(phone);
CREATE INDEX idx_sms_expire ON sms_codes(expire_at);
```

#### categories - 笔记分类表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(50) | NOT NULL | 分类名称 |
| slug | VARCHAR(50) | UNIQUE | URL 友好标识 |
| description | TEXT | | 分类描述 |
| sort_order | INTEGER | DEFAULT 0 | 排序序号 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL,
    slug VARCHAR(50) UNIQUE,
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_slug ON categories(slug);
```

#### notes - 笔记表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| title | VARCHAR(200) | NOT NULL | 笔记标题 |
| slug | VARCHAR(200) | UNIQUE | URL 友好标识 |
| category_id | INTEGER | FK | 所属分类 |
| file_path | VARCHAR(500) | NOT NULL | Markdown 文件路径 |
| summary | TEXT | | 摘要（前 200 字） |
| view_count | INTEGER | DEFAULT 0 | 浏览次数 |
| is_published | BOOLEAN | DEFAULT 1 | 是否发布 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

```sql
CREATE TABLE notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    category_id INTEGER,
    file_path VARCHAR(500) NOT NULL,
    summary TEXT,
    view_count INTEGER DEFAULT 0,
    is_published BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

CREATE INDEX idx_notes_slug ON notes(slug);
CREATE INDEX idx_notes_category ON notes(category_id);
CREATE INDEX idx_notes_view ON notes(view_count DESC);
CREATE INDEX idx_notes_created ON notes(created_at DESC);
```

#### courses - 课程表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(200) | NOT NULL | 课程名称 |
| slug | VARCHAR(200) | UNIQUE | URL 友好标识 |
| price | DECIMAL(10,2) | NOT NULL | 价格（站长定价） |
| description | TEXT | | 课程详细描述 |
| cover_image | VARCHAR(500) | | 封面图片路径 |
| view_count | INTEGER | DEFAULT 0 | 点击量 |
| download_count | INTEGER | DEFAULT 0 | 下载量 |
| is_active | BOOLEAN | DEFAULT 1 | 是否上架 |
| sort_order | INTEGER | DEFAULT 0 | 站长排序序号 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

```sql
CREATE TABLE courses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    price DECIMAL(10,2) NOT NULL,
    description TEXT,
    cover_image VARCHAR(500),
    view_count INTEGER DEFAULT 0,
    download_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT 1,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME
);

CREATE INDEX idx_courses_slug ON courses(slug);
CREATE INDEX idx_courses_active ON courses(is_active);
CREATE INDEX idx_courses_sort ON courses(sort_order);
CREATE INDEX idx_courses_view ON courses(view_count DESC);
CREATE INDEX idx_courses_download ON courses(download_count DESC);
CREATE INDEX idx_courses_updated ON courses(updated_at DESC);
```

#### course_files - 课程文件表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| course_id | INTEGER | FK, NOT NULL | 关联课程 |
| file_type | VARCHAR(20) | NOT NULL | 文件类型：intro（MD介绍）/ resource（ZIP资源） |
| file_name | VARCHAR(200) | NOT NULL | 原始文件名 |
| file_path | VARCHAR(500) | NOT NULL | 存储路径 |
| file_size | BIGINT | DEFAULT 0 | 文件大小（字节） |
| sort | INTEGER | DEFAULT 0 | 排序序号 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE course_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id INTEGER NOT NULL,
    file_type VARCHAR(20) NOT NULL,
    file_name VARCHAR(200) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT DEFAULT 0,
    sort INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

CREATE INDEX idx_course_files_course ON course_files(course_id);
CREATE INDEX idx_course_files_type ON course_files(file_type);
```

#### orders - 订单表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| order_no | VARCHAR(32) | UNIQUE | 订单号 |
| user_id | INTEGER | FK, NOT NULL | 用户 ID |
| course_id | INTEGER | FK, NOT NULL | 课程 ID |
| amount | DECIMAL(10,2) | NOT NULL | 订单金额 |
| payment_type | VARCHAR(20) | NOT NULL | 支付类型：payment/invite |
| payment_ref | VARCHAR(100) | | 支付凭证/邀请码 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

**支付类型**：
- `payment` - 第三方支付
- `invite` - 邀请码兑换

**状态枚举**：
- `pending` - 待支付
- `paid` - 已支付
- `completed` - 已完成（已下载）

```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_no VARCHAR(32) UNIQUE,
    user_id INTEGER NOT NULL,
    course_id INTEGER NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_type VARCHAR(20) NOT NULL,
    payment_ref VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

CREATE INDEX idx_orders_no ON orders(order_no);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_course ON orders(course_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created ON orders(created_at DESC);
```

#### invite_codes - 邀请码表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| code | VARCHAR(32) | UNIQUE, NOT NULL | 邀请码 |
| course_id | INTEGER | FK, NOT NULL | 关联课程 |
| created_by | INTEGER | FK | 创建者（站长） |
| used_by | INTEGER | FK | 使用者 |
| used_at | DATETIME | | 使用时间 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE invite_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(32) UNIQUE NOT NULL,
    course_id INTEGER NOT NULL,
    created_by INTEGER,
    used_by INTEGER,
    used_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES courses(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (used_by) REFERENCES users(id)
);

CREATE INDEX idx_invite_code ON invite_codes(code);
CREATE INDEX idx_invite_course ON invite_codes(course_id);
CREATE INDEX idx_invite_used ON invite_codes(used_by);
```

#### download_tokens - 下载令牌表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| order_id | INTEGER | FK, NOT NULL | 关联订单 |
| user_id | INTEGER | FK, NOT NULL | 关联用户 |
| token | VARCHAR(64) | UNIQUE | 下载令牌 |
| expire_at | DATETIME | NOT NULL | 过期时间 |
| max_count | INTEGER | DEFAULT 3 | 最大下载次数 |
| used_count | INTEGER | DEFAULT 0 | 已使用次数 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE download_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    token VARCHAR(64) UNIQUE,
    expire_at DATETIME NOT NULL,
    max_count INTEGER DEFAULT 3,
    used_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_tokens_token ON download_tokens(token);
CREATE INDEX idx_tokens_user ON download_tokens(user_id);
CREATE INDEX idx_tokens_expire ON download_tokens(expire_at);
```

#### browse_history - 浏览记录表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| user_id | INTEGER | FK, NOT NULL | 用户 ID |
| content_type | VARCHAR(20) | NOT NULL | 内容类型：note/course |
| content_id | INTEGER | NOT NULL | 内容 ID |
| created_at | DATETIME | DEFAULT NOW | 浏览时间 |

```sql
CREATE TABLE browse_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_browse_user ON browse_history(user_id);
CREATE INDEX idx_browse_type ON browse_history(content_type);
CREATE INDEX idx_browse_created ON browse_history(created_at DESC);
```

#### download_history - 下载记录表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| user_id | INTEGER | FK, NOT NULL | 用户 ID |
| course_id | INTEGER | FK, NOT NULL | 课程 ID |
| created_at | DATETIME | DEFAULT NOW | 下载时间 |

```sql
CREATE TABLE download_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    course_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

CREATE INDEX idx_dlhistory_user ON download_history(user_id);
CREATE INDEX idx_dlhistory_course ON download_history(course_id);
CREATE INDEX idx_dlhistory_created ON download_history(created_at DESC);
```

#### announcements - 公告表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| content | TEXT | NOT NULL | 公告内容 |
| type | VARCHAR(20) | DEFAULT 'general' | 类型：general/member |
| start_at | DATETIME | NOT NULL | 开始时间 |
| end_at | DATETIME | NOT NULL | 结束时间 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |

```sql
CREATE TABLE announcements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    type VARCHAR(20) DEFAULT 'general',
    start_at DATETIME NOT NULL,
    end_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_announce_time ON announcements(start_at, end_at);
CREATE INDEX idx_announce_type ON announcements(type);
```

#### page_views - 页面访问记录表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| path | VARCHAR(500) | NOT NULL | 访问路径 |
| user_id | INTEGER | | 用户 ID（可为空） |
| ip | VARCHAR(50) | | 访问 IP |
| user_agent | VARCHAR(500) | | UA |
| referer | VARCHAR(500) | | 来源页 |
| created_at | DATETIME | DEFAULT NOW | 访问时间 |

```sql
CREATE TABLE page_views (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    path VARCHAR(500) NOT NULL,
    user_id INTEGER,
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    referer VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_pv_path ON page_views(path);
CREATE INDEX idx_pv_user ON page_views(user_id);
CREATE INDEX idx_pv_created ON page_views(created_at);
```

## 3. 初始化脚本

### 3.1 完整建表脚本

```sql
-- schema.sql
-- HPA 数据库初始化脚本 v2.0

PRAGMA foreign_keys = ON;

-- 用户表
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(20) UNIQUE NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    role VARCHAR(20) DEFAULT 'user',
    year_spent DECIMAL(10,2) DEFAULT 0,
    vip_expire_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME
);

-- 短信验证码表
CREATE TABLE IF NOT EXISTS sms_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    phone VARCHAR(20) NOT NULL,
    code VARCHAR(10) NOT NULL,
    expire_at DATETIME NOT NULL,
    used BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 分类表
CREATE TABLE IF NOT EXISTS categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL,
    slug VARCHAR(50) UNIQUE,
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 笔记表
CREATE TABLE IF NOT EXISTS notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    category_id INTEGER,
    file_path VARCHAR(500) NOT NULL,
    summary TEXT,
    view_count INTEGER DEFAULT 0,
    is_published BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- 课程表
CREATE TABLE IF NOT EXISTS courses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE,
    price DECIMAL(10,2) NOT NULL,
    description TEXT,
    cover_image VARCHAR(500),
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT,
    view_count INTEGER DEFAULT 0,
    download_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT 1,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME
);

-- 订单表
CREATE TABLE IF NOT EXISTS orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_no VARCHAR(32) UNIQUE,
    user_id INTEGER NOT NULL,
    course_id INTEGER NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_type VARCHAR(20) NOT NULL,
    payment_ref VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

-- 邀请码表
CREATE TABLE IF NOT EXISTS invite_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(32) UNIQUE NOT NULL,
    course_id INTEGER NOT NULL,
    created_by INTEGER,
    used_by INTEGER,
    used_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (course_id) REFERENCES courses(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (used_by) REFERENCES users(id)
);

-- 下载令牌表
CREATE TABLE IF NOT EXISTS download_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    token VARCHAR(64) UNIQUE,
    expire_at DATETIME NOT NULL,
    max_count INTEGER DEFAULT 3,
    used_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 浏览记录表
CREATE TABLE IF NOT EXISTS browse_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 下载记录表
CREATE TABLE IF NOT EXISTS download_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    course_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (course_id) REFERENCES courses(id)
);

-- 公告表
CREATE TABLE IF NOT EXISTS announcements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    type VARCHAR(20) DEFAULT 'general',
    start_at DATETIME NOT NULL,
    end_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 访问记录表
CREATE TABLE IF NOT EXISTS page_views (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    path VARCHAR(500) NOT NULL,
    user_id INTEGER,
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    referer VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_sms_phone ON sms_codes(phone);
CREATE INDEX IF NOT EXISTS idx_categories_slug ON categories(slug);
CREATE INDEX IF NOT EXISTS idx_notes_slug ON notes(slug);
CREATE INDEX IF NOT EXISTS idx_notes_category ON notes(category_id);
CREATE INDEX IF NOT EXISTS idx_notes_view ON notes(view_count DESC);
CREATE INDEX IF NOT EXISTS idx_courses_slug ON courses(slug);
CREATE INDEX IF NOT EXISTS idx_courses_view ON courses(view_count DESC);
CREATE INDEX IF NOT EXISTS idx_courses_download ON courses(download_count DESC);
CREATE INDEX IF NOT EXISTS idx_courses_updated ON courses(updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_orders_user ON orders(user_id);
CREATE INDEX IF NOT EXISTS idx_orders_created ON orders(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_invite_code ON invite_codes(code);
CREATE INDEX IF NOT EXISTS idx_tokens_token ON download_tokens(token);
CREATE INDEX IF NOT EXISTS idx_browse_user ON browse_history(user_id);
CREATE INDEX IF NOT EXISTS idx_dlhistory_user ON download_history(user_id);
CREATE INDEX IF NOT EXISTS idx_announce_time ON announcements(start_at, end_at);
CREATE INDEX IF NOT EXISTS idx_pv_created ON page_views(created_at);
```

### 3.2 示例数据

```sql
-- seed.sql
-- 示例数据

-- 插入管理员用户
INSERT INTO users (username, phone, role) VALUES
('admin', '13800000000', 'admin');

-- 插入分类
INSERT INTO categories (name, slug, description, sort_order) VALUES
('Go 语言', 'golang', 'Go 语言学习笔记', 1),
('云原生', 'cloud-native', 'Docker、K8s 相关', 2),
('安全', 'security', '网络安全相关', 3);

-- 插入示例课程（价格由站长定）
INSERT INTO courses (name, slug, price, description, file_path, sort_order) VALUES
('Go 语言入门到实战', 'go-beginner', 99.00, 'Go 语言从零基础到项目实战...', 'courses/go-beginner.zip', 1),
('Docker 容器化实战', 'docker-practice', 149.00, 'Docker 从入门到精通...', 'courses/docker-practice.zip', 2);
```

## 4. 常用查询

### 4.1 课程排序查询

```sql
-- 默认排序（站长上传顺序）
SELECT * FROM courses WHERE is_active = 1 ORDER BY sort_order ASC;

-- 按点击量排序
SELECT * FROM courses WHERE is_active = 1 ORDER BY view_count DESC;

-- 按下载量排序
SELECT * FROM courses WHERE is_active = 1 ORDER BY download_count DESC;

-- 按更新时间排序
SELECT * FROM courses WHERE is_active = 1 ORDER BY updated_at DESC;
```

### 4.2 用户年消费查询（不含邀请码）

```sql
-- 计算用户年消费金额
SELECT SUM(amount) as year_spent
FROM orders
WHERE user_id = ?
  AND payment_type = 'payment'
  AND status IN ('paid', 'completed')
  AND created_at >= date('now', 'start of year');
```

### 4.3 用户记录查询

```sql
-- 用户订单列表
SELECT o.*, c.name as course_name
FROM orders o
JOIN courses c ON o.course_id = c.id
WHERE o.user_id = ?
ORDER BY o.created_at DESC;

-- 用户浏览记录
SELECT bh.*,
       CASE bh.content_type
           WHEN 'note' THEN n.title
           WHEN 'course' THEN c.name
       END as content_title
FROM browse_history bh
LEFT JOIN notes n ON bh.content_type = 'note' AND bh.content_id = n.id
LEFT JOIN courses c ON bh.content_type = 'course' AND bh.content_id = c.id
WHERE bh.user_id = ?
ORDER BY bh.created_at DESC;

-- 用户下载记录
SELECT dh.*, c.name as course_name
FROM download_history dh
JOIN courses c ON dh.course_id = c.id
WHERE dh.user_id = ?
ORDER BY dh.created_at DESC;
```

## 5. 数据维护

### 5.1 备份策略

```bash
#!/bin/bash
# backup.sh - 数据库备份脚本

BACKUP_DIR="/backup/hpa"
DB_FILE="/app/data/hpa.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
sqlite3 $DB_FILE ".backup '$BACKUP_DIR/hpa_$DATE.db'"
find $BACKUP_DIR -name "hpa_*.db" -mtime +7 -delete

echo "Backup completed: hpa_$DATE.db"
```

### 5.2 数据清理

```sql
-- 清理过期的验证码
DELETE FROM sms_codes WHERE expire_at < datetime('now');

-- 清理过期的下载令牌
DELETE FROM download_tokens WHERE expire_at < datetime('now', '-7 days');

-- 清理 90 天前的浏览记录（可选）
DELETE FROM browse_history WHERE created_at < datetime('now', '-90 days');

-- 清理 30 天前的访问记录（可选）
DELETE FROM page_views WHERE created_at < datetime('now', '-30 days');
```

---

**文档版本**：v2.1
**创建日期**：2025-01-15
**最后更新**：2026-01-17
