# 使用手册

## 1. 手册概述

本手册面向网站站长，介绍 HPA 系统的日常运营操作，包括内容管理、用户管理、订单处理等。

### 1.1 登录管理后台

1. 使用站长手机号登录网站
2. 登录后自动识别管理员身份
3. 导航栏显示「管理」入口

---

## 2. 内容管理

### 2.1 笔记管理

#### 2.1.1 笔记目录结构

笔记以 Markdown 文件形式存储在服务器上：

```
/opt/hpa/static/notes/
├── golang/                    # 分类目录
│   ├── _category.yaml         # 分类配置文件
│   ├── 01-go-basic.md         # 笔记文件
│   ├── 02-go-concurrency.md
│   └── 03-go-channel.md
├── docker/
│   ├── _category.yaml
│   └── docker-intro.md
└── kubernetes/
    ├── _category.yaml
    └── k8s-basic.md
```

#### 2.1.2 分类配置文件

每个分类目录下创建 `_category.yaml` 文件：

```yaml
# _category.yaml
name: Go 语言        # 分类名称（中文）
slug: golang        # URL 标识（英文）
description: Go 语言学习笔记
sort_order: 1       # 分类排序权重
```

#### 2.1.3 笔记文件格式

Markdown 文件头部使用 YAML Front Matter：

```markdown
---
title: Go 并发编程指南
slug: go-concurrency-guide
summary: 本文介绍 Go 语言的并发编程模型，包括 goroutine、channel 等核心概念
sort_order: 2
created_at: 2025-01-10
updated_at: 2025-01-12
---

# Go 并发编程指南

## 1. Goroutine

Goroutine 是 Go 语言的轻量级线程...
```

#### 2.1.4 添加新笔记

1. 在对应分类目录下创建 `.md` 文件
2. 填写 Front Matter 元信息
3. 编写 Markdown 内容
4. 执行同步命令：

```bash
docker exec hpa ./hpa notes sync
```

#### 2.1.5 修改笔记

1. 直接编辑 `.md` 文件
2. 执行同步命令刷新数据库

#### 2.1.6 删除笔记

1. 删除对应的 `.md` 文件
2. 执行同步命令

---

### 2.2 课程管理

#### 2.2.1 添加新课程

**步骤 1：准备文件**

```bash
# 将课程压缩包放入 courses 目录
cp /path/to/my-course.zip /opt/hpa/static/courses/

# 将封面图片放入 covers 目录
cp /path/to/my-course-cover.png /opt/hpa/static/covers/
```

**步骤 2：创建课程记录**

方式一：通过 API（推荐）

```bash
curl -X POST http://localhost:8080/api/v1/admin/courses \
  -H "Authorization: Bearer <your-admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Go 语言入门到实战",
    "slug": "go-beginner",
    "price": 99.00,
    "description": "## 课程介绍\n\n本课程适合零基础学员...",
    "cover_image": "/static/covers/my-course-cover.png",
    "file_name": "my-course.zip",
    "sort_order": 1
  }'
```

方式二：通过命令行

```bash
docker exec hpa ./hpa course create \
  --name "Go 语言入门到实战" \
  --slug "go-beginner" \
  --price 99.00 \
  --file "my-course.zip"
```

#### 2.2.2 修改课程信息

```bash
curl -X POST http://localhost:8080/api/v1/admin/courses \
  -H "Authorization: Bearer <your-admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "name": "Go 语言入门到实战（第2版）",
    "price": 129.00
  }'
```

#### 2.2.3 调整课程排序

修改 `sort_order` 字段，数值越小越靠前：

```bash
# 将课程 ID=1 的排序设为第一位
curl -X POST http://localhost:8080/api/v1/admin/courses \
  -H "Authorization: Bearer <token>" \
  -d '{"id": 1, "sort_order": 1}'
```

#### 2.2.4 下架课程

目前通过删除课程文件实现：

```bash
# 移除课程文件（保留订单记录）
mv /opt/hpa/static/courses/old-course.zip /opt/hpa/archive/
```

---

## 3. 邀请码管理

### 3.1 生成邀请码

**通过 API**：

```bash
curl -X POST http://localhost:8080/api/v1/admin/invite-codes \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "count": 10,
    "remark": "公众号活动 - 2025年1月"
  }'
```

**响应示例**：

```json
{
  "code": 0,
  "data": {
    "codes": ["ABCD1234", "EFGH5678", ...],
    "count": 10
  }
}
```

**通过命令行**：

```bash
docker exec hpa ./hpa invite create --count 10 --remark "公众号活动"
```

### 3.2 查看邀请码

**查看所有邀请码**：

```bash
curl "http://localhost:8080/api/v1/admin/invite-codes" \
  -H "Authorization: Bearer <admin-token>"
```

**只看未使用的**：

```bash
curl "http://localhost:8080/api/v1/admin/invite-codes?status=unused" \
  -H "Authorization: Bearer <admin-token>"
```

### 3.3 邀请码使用统计

API 响应中包含统计信息：

```json
{
  "data": {
    "list": [...],
    "summary": {
      "total": 100,
      "unused": 45,
      "used": 55
    }
  }
}
```

### 3.4 邀请码最佳实践

| 场景 | 建议 |
|-----|------|
| 公众号活动 | 批量生成，设置活动备注 |
| 老用户回馈 | 单独生成，私信发送 |
| 合作推广 | 按合作方分批生成，便于统计 |

---

## 4. 用户与订单管理

### 4.1 查看用户列表

```bash
# 通过命令行查看
docker exec hpa ./hpa user list --page 1 --size 20

# 输出示例
ID    用户名          手机号        角色    年消费    会员到期
1     202501156826   138****6826   admin   -        -
2     202501151234   139****1234   user    1500.00  -
3     202501155678   137****5678   vip     2500.00  2026-01-15
```

### 4.2 查看订单列表

```bash
docker exec hpa ./hpa order list --page 1 --size 20

# 按用户筛选
docker exec hpa ./hpa order list --user-id 2

# 按支付类型筛选
docker exec hpa ./hpa order list --payment-type payment
docker exec hpa ./hpa order list --payment-type invite
```

### 4.3 手动处理订单

**场景 1：用户支付成功但未提交凭证**

```bash
# 手动创建订单
docker exec hpa ./hpa order create \
  --user-id 5 \
  --course-id 1 \
  --amount 99.00 \
  --payment-ref "manual"
```

**场景 2：用户下载次数用完需要重置**

```bash
# 重置下载次数
docker exec hpa ./hpa order reset-download --order-no HPA20250115100001
```

**场景 3：订单退款处理**

1. 在支付平台完成退款
2. 标记订单状态：

```bash
docker exec hpa ./hpa order refund --order-no HPA20250115100001
```

### 4.4 会员管理

**查看会员列表**：

```bash
docker exec hpa ./hpa user list --role vip
```

**手动设置会员（特殊情况）**：

```bash
# 设置用户为会员，有效期1年
docker exec hpa ./hpa user set-vip --user-id 5 --months 12
```

---

## 5. 公告管理

### 5.1 公告类型

| 类型 | 触发方式 | 展示时长 |
|-----|---------|---------|
| vip | 用户升级会员时自动生成 | 3 天 |
| system | 手动创建 | 自定义 |

### 5.2 创建系统公告

```bash
docker exec hpa ./hpa announce create \
  --content "网站将于 2025-01-20 凌晨 2:00-4:00 进行维护，届时无法访问" \
  --type system \
  --expire-days 5
```

### 5.3 删除公告

```bash
docker exec hpa ./hpa announce delete --id 1
```

---

## 6. 数据统计

### 6.1 访问统计

```bash
# 查看今日 PV/UV
docker exec hpa ./hpa stats today

# 输出示例
日期: 2025-01-15
PV: 1,234
UV: 456
笔记浏览: 890
课程浏览: 344
```

### 6.2 销售统计

```bash
# 查看月度销售
docker exec hpa ./hpa stats sales --month 2025-01

# 输出示例
月份: 2025-01
订单数: 45
销售额: ¥4,500.00
  - 支付: ¥3,200.00 (28单)
  - 邀请码: ¥0 (17单)
新增会员: 3
```

### 6.3 课程销量

```bash
docker exec hpa ./hpa stats course

# 输出示例
排名  课程名称              销量    销售额
1     Go 语言入门到实战      120    ¥11,880
2     Docker 实战课程        85     ¥7,225
3     Kubernetes 入门        42     ¥5,460
```

---

## 7. 日常运维

### 7.1 每日检查清单

| 检查项 | 命令 | 说明 |
|-------|------|------|
| 服务状态 | `docker ps` | 确认容器运行 |
| 磁盘空间 | `df -h` | 确保磁盘充足 |
| 访问日志 | `docker logs --tail 100 hpa` | 检查异常 |
| 备份状态 | `ls -la /opt/hpa/backups/` | 确认备份正常 |

### 7.2 定期维护

| 周期 | 任务 | 说明 |
|-----|------|------|
| 每日 | 检查日志 | 关注错误和异常 |
| 每周 | 清理临时文件 | 保持磁盘整洁 |
| 每月 | 数据库优化 | SQLite VACUUM |
| 每月 | 安全更新 | 更新系统和 Docker |

### 7.3 数据库优化

```bash
# SQLite 数据库优化
docker exec hpa ./hpa db optimize

# 或直接执行
docker exec hpa sqlite3 /app/data/hpa.db "VACUUM; ANALYZE;"
```

### 7.4 日志清理

```bash
# 清理 30 天前的日志
docker logs --since "720h" hpa > /dev/null

# 或使用日志轮转
docker run --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 ...
```

---

## 8. 常见运营问题

### 8.1 用户无法收到验证码

**排查步骤**：

1. 检查短信配置是否正确
2. 检查短信余额是否充足
3. 检查用户手机号是否正确
4. 查看日志中的短信发送记录

```bash
docker logs hpa | grep -i "sms"
```

**临时解决**：

```bash
# 手动获取验证码（仅测试环境）
docker exec hpa ./hpa sms code --phone 13800138001
```

### 8.2 用户支付后无法下载

**可能原因**：

1. 支付凭证输入错误
2. 订单创建失败
3. 下载次数已用完
4. 下载链接已过期

**解决方案**：

```bash
# 查看用户订单
docker exec hpa ./hpa order list --user-id <user_id>

# 重置下载次数
docker exec hpa ./hpa order reset-download --order-no <order_no>

# 或手动创建新订单
docker exec hpa ./hpa order create --user-id <user_id> --course-id <course_id> --amount 0 --payment-ref "补发"
```

### 8.3 用户要求退款

**处理流程**：

1. 在支付平台完成退款操作
2. 标记订单为已退款状态
3. 用户消费金额相应扣减（如影响会员资格）

```bash
docker exec hpa ./hpa order refund --order-no HPA20250115100001 --reason "用户申请退款"
```

### 8.4 笔记更新后未显示

**排查**：

1. 检查文件是否保存到正确目录
2. 检查 Front Matter 格式是否正确
3. 执行同步命令

```bash
# 检查文件
ls -la /opt/hpa/static/notes/category/

# 验证 YAML 格式
docker exec hpa ./hpa notes validate

# 重新同步
docker exec hpa ./hpa notes sync
```

### 8.5 会员权限未生效

**排查**：

1. 检查用户年消费是否达到 2000 元
2. 检查是否有邀请码消费（不计入年消费）
3. 检查会员是否已过期

```bash
# 查看用户详情
docker exec hpa ./hpa user show --id <user_id>
```

---

## 9. 安全提醒

### 9.1 敏感操作确认

以下操作需要格外谨慎：

| 操作 | 风险 | 建议 |
|-----|------|------|
| 修改课程价格 | 影响后续销售 | 提前公告 |
| 删除订单 | 用户权益受损 | 仅退款时使用 |
| 重置下载次数 | 可能被滥用 | 记录操作原因 |
| 手动设置会员 | 绕过消费规则 | 限特殊情况 |

### 9.2 定期备份

确保自动备份正常运行：

```bash
# 检查备份文件
ls -la /opt/hpa/backups/

# 测试恢复（使用测试环境）
```

### 9.3 配置保密

- JWT Secret 不要泄露
- 短信 AccessKey 妥善保管
- 配置文件权限设为 600

```bash
chmod 600 /opt/hpa/config.yaml
```

---

## 10. 运营建议

### 10.1 内容运营

| 策略 | 说明 |
|-----|------|
| 定期更新笔记 | 保持内容新鲜度，提升回访率 |
| 课程连载 | 分期发布，培养用户付费习惯 |
| 专题整理 | 将零散笔记整理成系列 |

### 10.2 用户运营

| 策略 | 说明 |
|-----|------|
| 会员关怀 | 会员到期前提醒续费 |
| 邀请码活动 | 定期发放，激活老用户 |
| 内容预告 | 预告新课程，收集用户需求 |

### 10.3 数据关注

| 指标 | 关注点 |
|-----|-------|
| 日活 UV | 网站健康度 |
| 转化率 | 浏览到购买的比例 |
| 复购率 | 用户黏性 |
| 会员占比 | 高价值用户比例 |

---

**文档版本**：v1.0
**创建日期**：2025-01-15
**最后更新**：2025-01-15
