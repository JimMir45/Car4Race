# Car4Race 测试记录

> 测试日期：2026-01-17

## 测试环境

- macOS Darwin 23.6.0
- Go 1.25.6
- SQLite 3
- 测试端口：8080

## 第一阶段：基础架构

### 1. 健康检查
```bash
curl http://localhost:8080/health
```
**结果**：✅ `{"status":"ok"}`

### 2. 发送验证码
```bash
curl -X POST http://localhost:8080/api/v1/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```
**结果**：✅ `{"code":0,"message":"success","data":{"message":"验证码已发送"}}`

### 3. 频率限制测试
重复发送验证码：
**结果**：✅ `{"code":429,"message":"请稍后再试"}` （1分钟内限制）

### 4. 登录/注册
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"974049"}'
```
**结果**：✅ 返回 JWT token 和用户信息
- 自动创建用户
- 自动生成用户名 `user_rm3xggqi`
- 自动生成昵称 `用户8000`

### 5. 获取用户信息
```bash
curl http://localhost:8080/api/v1/user/profile \
  -H "Authorization: Bearer $TOKEN"
```
**结果**：✅ 返回完整用户信息

---

## 第二阶段：私域视频网站 (HPA)

### 数据库表创建
服务启动时自动创建以下表：
- ✅ `hpa_categories` - 分类表
- ✅ `hpa_notes` - 笔记表
- ✅ `hpa_browse_history` - 浏览记录表
- ✅ `hpa_courses` - 课程表
- ✅ `hpa_orders` - 订单表
- ✅ `hpa_invite_codes` - 邀请码表
- ✅ `hpa_downloads` - 下载记录表

### 管理后台 API

#### 创建分类
```bash
curl -X POST http://localhost:8080/api/v1/admin/categories \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Go语言教程","slug":"golang","sort":1}'
```
**结果**：✅ 创建成功，返回分类 ID

#### 创建笔记
```bash
curl -X POST http://localhost:8080/api/v1/admin/notes \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"category_id":1,"title":"Go语言入门指南","slug":"golang-getting-started",...}'
```
**结果**：✅ 创建成功

#### 创建课程
```bash
curl -X POST http://localhost:8080/api/v1/admin/courses \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Go语言实战课程","slug":"golang-in-action","price":199,...}'
```
**结果**：✅ 创建成功

#### 创建邀请码
```bash
curl -X POST http://localhost:8080/api/v1/admin/invite-codes \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"course_id":1,"max_uses":10}'
```
**结果**：✅ 创建成功，生成邀请码 `INVcec450a9`

### 公开 API

#### 获取分类列表
```bash
curl http://localhost:8080/api/v1/hpa/categories
```
**结果**：✅ 返回分类列表（支持树形结构）

#### 获取笔记列表
```bash
curl http://localhost:8080/api/v1/hpa/notes
```
**结果**：✅ 返回笔记列表，包含分类信息

#### 获取笔记详情
```bash
curl http://localhost:8080/api/v1/hpa/notes/golang-getting-started
```
**结果**：✅ 返回笔记详情，自动增加浏览次数

#### 获取课程列表
```bash
curl http://localhost:8080/api/v1/hpa/courses
```
**结果**：✅ 返回课程列表，支持 4 种排序（newest/price_asc/price_desc/sales）

#### 获取课程详情
```bash
curl http://localhost:8080/api/v1/hpa/courses/golang-in-action \
  -H "Authorization: Bearer $TOKEN"
```
**结果**：✅ 返回课程详情，包含 `purchased` 字段

### 业务功能

#### 兑换邀请码
```bash
curl -X POST http://localhost:8080/api/v1/hpa/redeem \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"code":"INVcec450a9"}'
```
**结果**：✅ 兑换成功
- 创建订单（状态：paid）
- 邀请码使用次数 +1
- 课程销量 +1

#### 获取订单列表
```bash
curl http://localhost:8080/api/v1/hpa/orders \
  -H "Authorization: Bearer $TOKEN"
```
**结果**：✅ 返回订单列表，包含课程信息

### 权限控制

#### 管理员权限
普通用户访问管理后台：
**结果**：✅ `{"code":403,"message":"需要管理员权限"}`

#### JWT 认证
无 token 访问受保护接口：
**结果**：✅ `{"code":401,"message":"未提供认证信息"}`

---

## 数据库验证

```sql
-- 订单记录
SELECT id, order_no, user_id, course_id, status FROM hpa_orders;
-- 结果：1|ORD1768642183332e73395|1|1|paid

-- 邀请码使用情况
SELECT code, used_count, max_uses FROM hpa_invite_codes;
-- 结果：INVcec450a9|1|10

-- 课程销量
SELECT title, sales_count FROM hpa_courses;
-- 结果：Go语言实战课程|1
```

---

## 测试结论

| 模块 | 测试项 | 状态 |
|------|--------|------|
| 基础架构 | 健康检查 | ✅ |
| 基础架构 | 验证码发送 | ✅ |
| 基础架构 | 频率限制 | ✅ |
| 基础架构 | 登录/注册 | ✅ |
| 基础架构 | JWT 认证 | ✅ |
| HPA | 分类 CRUD | ✅ |
| HPA | 笔记 CRUD | ✅ |
| HPA | 课程 CRUD | ✅ |
| HPA | 邀请码管理 | ✅ |
| HPA | 邀请码兑换 | ✅ |
| HPA | 订单管理 | ✅ |
| HPA | 管理员权限 | ✅ |

**总计**：12/12 测试通过 ✅
