# Car4Race 圈速榜 - 接口设计

## 1. 接口规范

### 1.1 基础信息

| 项目 | 说明 |
|------|------|
| 基础路径 | `/api/v1/laptracker` |
| 数据格式 | JSON |
| 字符编码 | UTF-8 |
| 认证方式 | JWT Bearer Token（与 HPA 共用） |

### 1.2 请求头

```http
Content-Type: application/json
Authorization: Bearer <jwt_token>
```

### 1.3 响应格式

**成功响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

**错误响应**：
```json
{
  "code": 40001,
  "message": "参数错误：圈速格式不正确",
  "data": null
}
```

### 1.4 错误码定义

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 40001 | 参数错误 |
| 40002 | 缺少必填字段 |
| 40101 | 未登录 |
| 40102 | Token 过期 |
| 40301 | 无权限 |
| 40302 | 已被禁止上榜 |
| 40401 | 资源不存在 |
| 40901 | 重复操作 |
| 50001 | 服务器内部错误 |

### 1.5 分页参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| page | int | 1 | 页码 |
| page_size | int | 20 | 每页数量（最大100） |

**分页响应**：
```json
{
  "code": 0,
  "data": {
    "list": [...],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  }
}
```

---

## 2. 接口列表

### 2.1 接口总览

| 模块 | 接口 | 方法 | 路径 | 认证 |
|------|------|------|------|------|
| **成绩记录** | 创建成绩 | POST | /records | ✅ |
| | 获取成绩详情 | GET | /records/:id | ❌ |
| | 获取我的成绩 | GET | /records/my | ✅ |
| | 获取我的最佳 | GET | /records/my/best | ✅ |
| | 删除成绩 | DELETE | /records/:id | ✅ |
| | 导入RaceChrono | POST | /records/import | ✅ |
| **榜单** | 获取综合榜单 | GET | /leaderboard | ❌ |
| | 获取榜单详情 | GET | /leaderboard/:id | ❌ |
| **赛道** | 获取赛道列表 | GET | /tracks | ❌ |
| | 获取赛道详情 | GET | /tracks/:id | ❌ |
| **山路** | 获取山路列表 | GET | /mountains | ❌ |
| | 获取山路详情 | GET | /mountains/:id | ❌ |
| | 创建山路标记 | POST | /mountains | ✅ |
| | 检查山路重叠 | POST | /mountains/check-overlap | ✅ |
| | 申诉山路 | POST | /mountains/:id/appeal | ✅ |
| **投票** | 获取待投票列表 | GET | /votes/pending | ✅ |
| | 提交投票 | POST | /votes | ✅ |
| | 获取投票详情 | GET | /votes/sessions/:id | ✅ |
| **申诉** | 创建成绩申诉 | POST | /appeals/record | ✅ |
| | 获取我的申诉 | GET | /appeals/my | ✅ |
| **免责声明** | 获取免责声明 | GET | /disclaimer | ✅ |
| | 同意免责声明 | POST | /disclaimer/agree | ✅ |
| **文件上传** | 上传图片 | POST | /upload/image | ✅ |
| | 上传视频 | POST | /upload/video | ✅ |
| **组织** | 获取组织详情 | GET | /orgs/:slug | ❌ |
| | 获取组织榜单 | GET | /orgs/:slug/leaderboard | ❌ |
| | 申请加入组织 | POST | /orgs/:slug/join | ✅ |
| | 获取我的组织列表 | GET | /orgs/my | ✅ |
| **组织成员** | 获取组织成员 | GET | /orgs/:slug/members | ✅ |
| | 退出组织 | DELETE | /orgs/:slug/members/me | ✅ |
| **组织成绩** | 创建组织成绩 | POST | /orgs/:slug/records | ✅ |
| | 获取我在组织的成绩 | GET | /orgs/:slug/records/my | ✅ |
| | 删除组织成绩 | DELETE | /orgs/:slug/records/:id | ✅ |
| **组织管理** | 获取待审批申请 | GET | /orgs/:slug/admin/requests | ✅ |
| | 处理加入申请 | POST | /orgs/:slug/admin/requests/:id | ✅ |
| | 获取待审核成绩 | GET | /orgs/:slug/admin/records/pending | ✅ |
| | 审核成绩 | POST | /orgs/:slug/admin/records/:id/review | ✅ |
| | 移除成员 | DELETE | /orgs/:slug/admin/members/:id | ✅ |
| | 更新组织信息 | PUT | /orgs/:slug/admin/info | ✅ |
| | 管理赞助商 | POST | /orgs/:slug/admin/sponsors | ✅ |

---

## 3. 成绩记录接口

### 3.1 创建成绩

**接口**：`POST /api/v1/laptracker/records`

**描述**：创建一条成绩记录

**请求体**：
```json
{
  "track_type": "track",
  "track_id": 1,
  "lap_time": "1:48.532",
  "car_brand": "大众",
  "car_model": "高尔夫R",
  "car_level": "A",
  "car_power": "燃油",
  "car_price_range": "20-50万",
  "tire_brand": "米其林",
  "tire_model": "PS4S 235/35 R19",
  "mod_level": 1,
  "weather": "晴",
  "timing_photo": "https://xxx/photo.jpg",
  "video_url": "https://xxx/video.mp4",
  "driver_name": "张三",
  "record_date": "2025-01-15",
  "notes": "第一次跑进1分50",
  "is_public": true
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_type | string | ✅ | track/mountain |
| track_id | int | ✅ | 赛道/山路ID |
| lap_time | string | ✅ | 圈速 mm:ss.xxx |
| car_brand | string | ✅ | 车辆品牌 |
| car_model | string | ✅ | 车辆型号 |
| car_level | string | ❌ | 车辆级别 |
| car_power | string | ❌ | 动力类型 |
| car_price_range | string | ❌ | 价格区间 |
| tire_brand | string | ✅ | 轮胎品牌 |
| tire_model | string | ✅ | 轮胎型号 |
| mod_level | int | ✅ | 改装程度 0-3 |
| weather | string | ✅ | 天气 |
| timing_photo | string | ❌ | 计时截图URL（上榜必填） |
| video_url | string | ❌ | 视频URL（上榜必填） |
| driver_name | string | ❌ | 驾驶人姓名 |
| record_date | string | ✅ | 成绩日期 YYYY-MM-DD |
| notes | string | ❌ | 备注 |
| is_public | bool | ✅ | 是否公开上榜 |

**响应**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 12345,
    "verify_status": "pending",
    "is_best": true,
    "message": "成绩已提交，等待投票验证"
  }
}
```

**业务规则**：
- `is_public=true` 时，`timing_photo` 和 `video_url` 必填
- `is_public=true` 时，自动创建投票会话
- 系统自动判断是否为个人最佳
- 用户被禁止上榜时，`is_public` 只能为 `false`

---

### 3.2 获取成绩详情

**接口**：`GET /api/v1/laptracker/records/:id`

**描述**：获取单条成绩详情

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 12345,
    "user": {
      "id": 100,
      "username": "user123"
    },
    "track_type": "track",
    "track": {
      "id": 1,
      "name": "浙江国际赛车场",
      "short_name": "浙赛"
    },
    "lap_time": "1:48.532",
    "lap_time_ms": 108532,
    "car_brand": "大众",
    "car_model": "高尔夫R",
    "car_level": "A",
    "car_power": "燃油",
    "car_price_range": "20-50万",
    "tire_brand": "米其林",
    "tire_model": "PS4S 235/35 R19",
    "mod_level": 1,
    "mod_level_name": "轻度改装",
    "weather": "晴",
    "timing_photo": "https://xxx/photo.jpg",
    "video_url": "https://xxx/video.mp4",
    "driver_name": "张三",
    "record_date": "2025-01-15",
    "notes": "第一次跑进1分50",
    "is_public": true,
    "is_best": true,
    "verify_status": "verified",
    "created_at": "2025-01-15T10:30:00Z"
  }
}
```

---

### 3.3 获取我的成绩列表

**接口**：`GET /api/v1/laptracker/records/my`

**描述**：获取当前用户的成绩列表

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_type | string | ❌ | 筛选场地类型 |
| track_id | int | ❌ | 筛选场地ID |
| car_brand | string | ❌ | 筛选品牌 |
| start_date | string | ❌ | 开始日期 |
| end_date | string | ❌ | 结束日期 |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 12345,
        "track_type": "track",
        "track": {
          "id": 1,
          "name": "浙江国际赛车场"
        },
        "lap_time": "1:48.532",
        "car_brand": "大众",
        "car_model": "高尔夫R",
        "mod_level": 1,
        "is_best": true,
        "verify_status": "verified",
        "record_date": "2025-01-15"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 50,
      "total_pages": 3
    }
  }
}
```

---

### 3.4 获取我的最佳成绩

**接口**：`GET /api/v1/laptracker/records/my/best`

**描述**：获取当前用户各赛道的最佳成绩

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_type | string | ❌ | 筛选场地类型 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "track_type": "track",
        "track": {
          "id": 1,
          "name": "浙江国际赛车场"
        },
        "best_record": {
          "id": 12345,
          "lap_time": "1:48.532",
          "car_brand": "大众",
          "car_model": "高尔夫R",
          "record_date": "2025-01-15",
          "is_public": true,
          "verify_status": "verified"
        },
        "total_records": 15
      }
    ]
  }
}
```

---

### 3.5 删除成绩

**接口**：`DELETE /api/v1/laptracker/records/:id`

**描述**：删除一条成绩记录（软删除）

**响应**：
```json
{
  "code": 0,
  "message": "删除成功"
}
```

---

### 3.6 导入 RaceChrono 数据

**接口**：`POST /api/v1/laptracker/records/import`

**描述**：批量导入 RaceChrono 导出的数据

**请求体**：`multipart/form-data`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | ✅ | CSV 文件 |
| car_brand | string | ✅ | 车辆品牌 |
| car_model | string | ✅ | 车辆型号 |
| tire_brand | string | ✅ | 轮胎品牌 |
| tire_model | string | ✅ | 轮胎型号 |
| mod_level | int | ✅ | 改装程度 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "total": 20,
    "imported": 18,
    "skipped": 2,
    "skipped_reasons": [
      {"row": 5, "reason": "无法匹配赛道"},
      {"row": 12, "reason": "圈速格式错误"}
    ]
  }
}
```

---

## 4. 榜单接口

### 4.1 获取综合榜单

**接口**：`GET /api/v1/laptracker/leaderboard`

**描述**：获取综合榜单（官方 + 大V + 个人）

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_id | int | ✅ | 赛道ID |
| source | string | ❌ | 来源筛选：official/dav/user/all |
| car_level | string | ❌ | 车辆级别 |
| car_power | string | ❌ | 动力类型 |
| car_price_range | string | ❌ | 价格区间 |
| mod_level | int | ❌ | 改装程度 |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "track": {
      "id": 1,
      "name": "浙江国际赛车场",
      "short_name": "浙赛"
    },
    "list": [
      {
        "rank": 1,
        "source": "official",
        "source_name": "51GT3",
        "lap_time": "1:26.435",
        "car_brand": "奥迪",
        "car_model": "R8 LMS GT3",
        "driver_name": "徐加",
        "mod_level": 3,
        "tire_info": "Pirelli Slick",
        "record_date": "2023-05-20",
        "has_video": false
      },
      {
        "rank": 2,
        "source": "dav",
        "source_name": "键盘车神教",
        "record_id": null,
        "lap_time": "1:39.688",
        "car_brand": "宝马",
        "car_model": "M3 G80",
        "driver_name": "鲁超",
        "mod_level": 0,
        "tire_info": "米其林 PS4S",
        "record_date": "2023-10-15",
        "has_video": true,
        "video_url": "https://..."
      },
      {
        "rank": 3,
        "source": "user",
        "source_name": "用户上传",
        "record_id": 12345,
        "lap_time": "1:48.532",
        "car_brand": "大众",
        "car_model": "高尔夫R",
        "driver_name": "张三",
        "mod_level": 1,
        "tire_info": "米其林 PS4S",
        "record_date": "2025-01-15",
        "has_video": true,
        "user": {
          "id": 100,
          "username": "user123"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 150,
      "total_pages": 8
    },
    "filters": {
      "car_levels": ["A00", "A0", "A", "B", "C", "SUV", "跑车"],
      "car_powers": ["燃油", "纯电", "混动"],
      "car_price_ranges": ["0-20万", "20-50万", "50-100万", "100万+"],
      "mod_levels": [0, 1, 2, 3]
    }
  }
}
```

---

### 4.2 获取榜单成绩详情

**接口**：`GET /api/v1/laptracker/leaderboard/:id`

**描述**：获取榜单中某条成绩的详情（支持爬虫数据和用户数据）

**路径参数**：

| 参数 | 说明 |
|------|------|
| id | 格式：`{source}_{id}`，如 `user_12345`、`crawled_678` |

**响应**：
```json
{
  "code": 0,
  "data": {
    "source": "user",
    "record": {
      "id": 12345,
      "lap_time": "1:48.532",
      "car_brand": "大众",
      "car_model": "高尔夫R",
      "tire_brand": "米其林",
      "tire_model": "PS4S",
      "mod_level": 1,
      "weather": "晴",
      "timing_photo": "https://...",
      "video_url": "https://...",
      "driver_name": "张三",
      "record_date": "2025-01-15",
      "user": {
        "id": 100,
        "username": "user123"
      }
    }
  }
}
```

---

## 5. 赛道接口

### 5.1 获取赛道列表

**接口**：`GET /api/v1/laptracker/tracks`

**描述**：获取所有赛道列表

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "浙江国际赛车场",
        "short_name": "浙赛",
        "location": "浙江绍兴柯桥区",
        "length": 3200,
        "record_count": 150
      },
      {
        "id": 2,
        "name": "上海国际赛车场",
        "short_name": "上赛",
        "location": "上海嘉定区",
        "length": 5451,
        "record_count": 80
      }
    ]
  }
}
```

---

### 5.2 获取赛道详情

**接口**：`GET /api/v1/laptracker/tracks/:id`

**描述**：获取赛道详情及统计信息

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "name": "浙江国际赛车场",
    "short_name": "浙赛",
    "location": "浙江绍兴柯桥区柯岩大道1188号",
    "length": 3200,
    "source": "51gt3",
    "stats": {
      "total_records": 150,
      "official_records": 50,
      "dav_records": 30,
      "user_records": 70,
      "fastest_lap": "1:26.435",
      "fastest_car": "奥迪 R8 LMS GT3"
    }
  }
}
```

---

## 6. 山路接口

### 6.1 获取山路列表

**接口**：`GET /api/v1/laptracker/mountains`

**描述**：获取山路列表

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| lat | float | ❌ | 当前纬度（用于按距离排序） |
| lon | float | ❌ | 当前经度 |
| keyword | string | ❌ | 搜索关键词 |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "XX山南坡",
        "creator": {
          "id": 100,
          "username": "user123"
        },
        "start_point": {
          "lat": 30.123456,
          "lon": 120.654321
        },
        "end_point": {
          "lat": 30.234567,
          "lon": 120.765432
        },
        "distance": 7800,
        "record_count": 25,
        "fastest_lap": "3:45.678",
        "status": "active"
      }
    ],
    "pagination": {...}
  }
}
```

---

### 6.2 获取山路详情

**接口**：`GET /api/v1/laptracker/mountains/:id`

**描述**：获取山路详情

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "name": "XX山南坡",
    "description": "从山脚停车场到山顶观景台",
    "creator": {
      "id": 100,
      "username": "user123"
    },
    "start_point": {
      "lat": 30.123456,
      "lon": 120.654321,
      "name": "山脚停车场"
    },
    "end_point": {
      "lat": 30.234567,
      "lon": 120.765432,
      "name": "山顶观景台"
    },
    "distance": 7800,
    "status": "active",
    "stats": {
      "total_records": 25,
      "fastest_lap": "3:45.678",
      "fastest_car": "丰田 86"
    },
    "created_at": "2025-01-10T08:00:00Z"
  }
}
```

---

### 6.3 创建山路标记

**接口**：`POST /api/v1/laptracker/mountains`

**描述**：创建新的山路标记

**请求体**：
```json
{
  "name": "XX山南坡",
  "description": "从山脚停车场到山顶观景台",
  "start_lat": 30.123456,
  "start_lon": 120.654321,
  "end_lat": 30.234567,
  "end_lon": 120.765432
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "name": "XX山南坡",
    "distance": 7800,
    "message": "山路标记创建成功"
  }
}
```

**错误情况**：
```json
{
  "code": 40901,
  "message": "该路段已被标记",
  "data": {
    "existing_mountain": {
      "id": 5,
      "name": "南山盘山路"
    }
  }
}
```

---

### 6.4 检查山路重叠

**接口**：`POST /api/v1/laptracker/mountains/check-overlap`

**描述**：检查指定坐标是否与现有山路重叠

**请求体**：
```json
{
  "start_lat": 30.123456,
  "start_lon": 120.654321,
  "end_lat": 30.234567,
  "end_lon": 120.765432
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "is_overlapping": false
  }
}
```

或

```json
{
  "code": 0,
  "data": {
    "is_overlapping": true,
    "overlapping_mountain": {
      "id": 5,
      "name": "南山盘山路",
      "creator": {
        "id": 50,
        "username": "driver50"
      }
    }
  }
}
```

---

### 6.5 申诉山路

**接口**：`POST /api/v1/laptracker/mountains/:id/appeal`

**描述**：对山路标记发起申诉

**请求体**：
```json
{
  "reason": "位置错误",
  "description": "起点位置标记错误，实际起点应该在停车场入口"
}
```

**reason 枚举值**：
- `位置错误`
- `命名不当`
- `重复标记`

**响应**：
```json
{
  "code": 0,
  "data": {
    "appeal_id": 123,
    "current_appeals": 2,
    "threshold": 3,
    "message": "申诉已提交，当前有2人申诉，达到3人将进入审核"
  }
}
```

---

## 7. 投票接口

### 7.1 获取待投票列表

**接口**：`GET /api/v1/laptracker/votes/pending`

**描述**：获取分配给当前用户的待投票成绩

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "session_id": 100,
        "record": {
          "id": 12345,
          "track": {
            "id": 1,
            "name": "浙江国际赛车场"
          },
          "lap_time": "1:48.532",
          "car_brand": "大众",
          "car_model": "高尔夫R",
          "timing_photo": "https://...",
          "video_url": "https://...",
          "record_date": "2025-01-15"
        },
        "expires_at": "2025-01-18T10:30:00Z"
      }
    ],
    "total": 3
  }
}
```

---

### 7.2 提交投票

**接口**：`POST /api/v1/laptracker/votes`

**描述**：对成绩进行投票

**请求体**：
```json
{
  "session_id": 100,
  "is_fake": false
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "message": "投票成功",
    "session_status": "active",
    "current_votes": 5,
    "total_needed": 10
  }
}
```

---

### 7.3 获取投票详情

**接口**：`GET /api/v1/laptracker/votes/sessions/:id`

**描述**：获取投票会话详情

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 100,
    "record": {
      "id": 12345,
      "lap_time": "1:48.532",
      "car_brand": "大众",
      "car_model": "高尔夫R"
    },
    "status": "completed",
    "result": "verified",
    "total_votes": 10,
    "real_votes": 7,
    "fake_votes": 3,
    "completed_at": "2025-01-17T15:00:00Z"
  }
}
```

---

## 8. 申诉接口

### 8.1 创建成绩申诉

**接口**：`POST /api/v1/laptracker/appeals/record`

**描述**：对被作废的成绩发起申诉

**请求体**：
```json
{
  "record_id": 12345,
  "reason": "视频中的计时器与官方计时截图一致，请审核",
  "attachments": [
    "https://xxx/evidence1.jpg",
    "https://xxx/evidence2.jpg"
  ]
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "appeal_id": 456,
    "message": "申诉已提交，请等待管理员审核"
  }
}
```

---

### 8.2 获取我的申诉列表

**接口**：`GET /api/v1/laptracker/appeals/my`

**描述**：获取当前用户的申诉列表

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 456,
        "type": "record",
        "record": {
          "id": 12345,
          "lap_time": "1:48.532"
        },
        "reason": "视频中的计时器与官方计时截图一致",
        "status": "pending",
        "created_at": "2025-01-17T10:00:00Z"
      }
    ]
  }
}
```

---

## 9. 免责声明接口

### 9.1 获取免责声明

**接口**：`GET /api/v1/laptracker/disclaimer`

**描述**：获取免责声明内容及用户同意状态

**响应**：
```json
{
  "code": 0,
  "data": {
    "version": "1.0",
    "content": "# 免责声明\n\n1. 山路为公共道路，非封闭赛道...",
    "agreed": false,
    "agreed_at": null
  }
}
```

---

### 9.2 同意免责声明

**接口**：`POST /api/v1/laptracker/disclaimer/agree`

**描述**：同意免责声明

**请求体**：
```json
{
  "version": "1.0"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "已同意免责声明"
}
```

---

## 10. 文件上传接口

### 10.1 上传图片

**接口**：`POST /api/v1/laptracker/upload/image`

**描述**：上传成绩截图

**请求**：`multipart/form-data`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | ✅ | 图片文件（jpg/png，最大5MB） |

**响应**：
```json
{
  "code": 0,
  "data": {
    "url": "https://xxx/photos/abc123.jpg"
  }
}
```

---

### 10.2 上传视频

**接口**：`POST /api/v1/laptracker/upload/video`

**描述**：上传随车视频

**请求**：`multipart/form-data`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | file | ✅ | 视频文件（mp4，最大500MB） |

**响应**：
```json
{
  "code": 0,
  "data": {
    "url": "https://xxx/videos/xyz789.mp4"
  }
}
```

---

## 11. 管理后台接口

> 以下接口仅管理员可访问

### 11.1 获取待审核申诉列表

**接口**：`GET /api/v1/laptracker/admin/appeals`

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | ❌ | 类型：record/mountain |
| status | string | ❌ | 状态：pending/approved/rejected |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 456,
        "type": "record",
        "user": {
          "id": 100,
          "username": "user123"
        },
        "reason": "...",
        "status": "pending",
        "created_at": "2025-01-17T10:00:00Z"
      }
    ]
  }
}
```

---

### 11.2 处理申诉

**接口**：`POST /api/v1/laptracker/admin/appeals/:id/handle`

**请求体**：
```json
{
  "action": "approve",
  "notes": "审核通过，恢复上榜资格"
}
```

**action 枚举值**：
- `approve` - 通过
- `reject` - 驳回

**响应**：
```json
{
  "code": 0,
  "message": "处理成功"
}
```

---

### 11.3 获取爬虫状态

**接口**：`GET /api/v1/laptracker/admin/crawler/status`

**响应**：
```json
{
  "code": 0,
  "data": {
    "sources": [
      {
        "name": "51gt3",
        "last_run": "2025-01-17T05:00:00Z",
        "status": "success",
        "records_total": 500,
        "records_new": 5
      },
      {
        "name": "kbracer",
        "last_run": "2025-01-17T05:00:00Z",
        "status": "success",
        "records_total": 200,
        "records_new": 0
      }
    ],
    "next_run": "2025-01-18T05:00:00Z"
  }
}
```

---

### 11.4 手动触发爬虫

**接口**：`POST /api/v1/laptracker/admin/crawler/run`

**请求体**：
```json
{
  "source": "51gt3"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "爬虫任务已启动",
  "data": {
    "task_id": "crawler_51gt3_20250117120000"
  }
}
```

---

## 12. 组织接口

### 12.1 获取组织详情

**接口**：`GET /api/v1/laptracker/orgs/:slug`

**描述**：获取组织公开信息（任何人可访问）

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "name": "键盘车神教",
    "slug": "kbracer",
    "type": "media",
    "type_name": "媒体/车评人",
    "description": "专注赛道圈速测试的汽车媒体",
    "logo_url": "https://xxx/logo.png",
    "cover_url": "https://xxx/cover.jpg",
    "theme_color": "#3B82F6",
    "sponsors": [
      {
        "name": "米其林",
        "logo_url": "https://xxx/michelin.png",
        "link_url": "https://michelin.com"
      }
    ],
    "stats": {
      "member_count": 50,
      "record_count": 200,
      "track_count": 8
    }
  }
}
```

---

### 12.2 获取组织榜单

**接口**：`GET /api/v1/laptracker/orgs/:slug/leaderboard`

**描述**：获取组织的成绩榜单

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_id | int | ❌ | 筛选赛道 |
| track_type | string | ❌ | track/mountain |
| car_brand | string | ❌ | 筛选品牌 |
| mod_level | int | ❌ | 改装程度 |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "org": {
      "id": 1,
      "name": "键盘车神教",
      "logo_url": "https://xxx/logo.png",
      "theme_color": "#3B82F6"
    },
    "list": [
      {
        "rank": 1,
        "record_id": 100,
        "lap_time": "1:39.688",
        "lap_time_ms": 99688,
        "car_brand": "宝马",
        "car_model": "M3 G80",
        "mod_level": 0,
        "weather": "晴",
        "record_date": "2025-01-15",
        "notes": "2025年1月浙赛赛道日",
        "member": {
          "user_id": 50,
          "nickname": "鲁超",
          "username": "luchao"
        },
        "track": {
          "id": 1,
          "name": "浙江国际赛车场"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 200,
      "total_pages": 10
    }
  }
}
```

---

### 12.3 申请加入组织

**接口**：`POST /api/v1/laptracker/orgs/:slug/join`

**描述**：申请加入组织

**请求体**：
```json
{
  "message": "我是XX车友会成员，希望加入"
}
```

**响应**：
```json
{
  "code": 0,
  "data": {
    "request_id": 123,
    "message": "申请已提交，请等待管理员审批"
  }
}
```

**错误情况**：
```json
{
  "code": 40901,
  "message": "您已是该组织成员"
}
```

---

### 12.4 获取我的组织列表

**接口**：`GET /api/v1/laptracker/orgs/my`

**描述**：获取当前用户加入的所有组织

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "org": {
          "id": 1,
          "name": "键盘车神教",
          "slug": "kbracer",
          "logo_url": "https://xxx/logo.png"
        },
        "role": "member",
        "nickname": "张三",
        "joined_at": "2025-01-10T08:00:00Z",
        "my_records": 15
      }
    ]
  }
}
```

---

## 13. 组织成员接口

### 13.1 获取组织成员列表

**接口**：`GET /api/v1/laptracker/orgs/:slug/members`

**描述**：获取组织成员列表（需登录且为组织成员）

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| role | string | ❌ | 筛选角色：admin/member |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "user_id": 50,
        "username": "luchao",
        "nickname": "鲁超",
        "role": "admin",
        "joined_at": "2025-01-01T00:00:00Z",
        "record_count": 25
      }
    ],
    "pagination": {...}
  }
}
```

---

### 13.2 退出组织

**接口**：`DELETE /api/v1/laptracker/orgs/:slug/members/me`

**描述**：退出组织（管理员不可直接退出）

**响应**：
```json
{
  "code": 0,
  "message": "已退出组织"
}
```

---

## 14. 组织成绩接口

### 14.1 创建组织成绩

**接口**：`POST /api/v1/laptracker/orgs/:slug/records`

**描述**：在组织内创建成绩记录

**请求体**：
```json
{
  "track_type": "track",
  "track_id": 1,
  "lap_time": "1:48.532",
  "car_brand": "大众",
  "car_model": "高尔夫R",
  "tire_brand": "米其林",
  "tire_model": "PS4S 235/35 R19",
  "mod_level": 1,
  "weather": "晴",
  "timing_photo": "https://xxx/photo.jpg",
  "video_url": "https://xxx/video.mp4",
  "record_date": "2025-01-15",
  "notes": "2025年1月浙赛赛道日",
  "sync_to_public": false
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_type | string | ✅ | track/mountain |
| track_id | int | ✅ | 赛道/山路ID |
| lap_time | string | ✅ | 圈速 mm:ss.xxx |
| car_brand | string | ✅ | 车辆品牌 |
| car_model | string | ✅ | 车辆型号 |
| tire_brand | string | ❌ | 轮胎品牌 |
| tire_model | string | ❌ | 轮胎型号 |
| mod_level | int | ❌ | 改装程度 0-3 |
| weather | string | ❌ | 天气 |
| timing_photo | string | ❌ | 计时截图URL |
| video_url | string | ❌ | 视频URL |
| record_date | string | ✅ | 成绩日期 |
| notes | string | ❌ | 备注（可写活动信息） |
| sync_to_public | bool | ❌ | 是否同步到综合榜单 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "id": 100,
    "verify_status": "pending",
    "message": "成绩已提交，等待管理员审核"
  }
}
```

**业务规则**：
- 必须是组织成员才能创建
- 成绩提交后为 `pending` 状态，等待管理员审核
- `sync_to_public=true` 时，审核通过后会自动创建公开成绩并进入投票验证流程

---

### 14.2 获取我在组织的成绩

**接口**：`GET /api/v1/laptracker/orgs/:slug/records/my`

**描述**：获取当前用户在该组织的成绩列表

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| track_id | int | ❌ | 筛选赛道 |
| verify_status | string | ❌ | 筛选状态 |
| page | int | ❌ | 页码 |
| page_size | int | ❌ | 每页数量 |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 100,
        "track": {
          "id": 1,
          "name": "浙江国际赛车场"
        },
        "lap_time": "1:48.532",
        "car_brand": "大众",
        "car_model": "高尔夫R",
        "mod_level": 1,
        "verify_status": "approved",
        "record_date": "2025-01-15",
        "notes": "2025年1月浙赛赛道日",
        "sync_to_public": false,
        "public_record_id": null
      }
    ],
    "pagination": {...}
  }
}
```

---

### 14.3 删除组织成绩

**接口**：`DELETE /api/v1/laptracker/orgs/:slug/records/:id`

**描述**：删除自己在组织内的成绩

**响应**：
```json
{
  "code": 0,
  "message": "删除成功"
}
```

---

## 15. 组织管理接口

> 以下接口仅组织管理员可访问

### 15.1 获取待审批加入申请

**接口**：`GET /api/v1/laptracker/orgs/:slug/admin/requests`

**描述**：获取待处理的加入申请

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | ❌ | pending/approved/rejected |

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 123,
        "user": {
          "id": 200,
          "username": "newuser",
          "phone": "138****1234"
        },
        "message": "我是XX车友会成员",
        "status": "pending",
        "created_at": "2025-01-16T10:00:00Z"
      }
    ]
  }
}
```

---

### 15.2 处理加入申请

**接口**：`POST /api/v1/laptracker/orgs/:slug/admin/requests/:id`

**描述**：审批加入申请

**请求体**：
```json
{
  "action": "approve",
  "reject_reason": ""
}
```

**action 枚举值**：
- `approve` - 通过
- `reject` - 拒绝

**响应**：
```json
{
  "code": 0,
  "message": "已通过申请"
}
```

---

### 15.3 获取待审核成绩

**接口**：`GET /api/v1/laptracker/orgs/:slug/admin/records/pending`

**描述**：获取待审核的成绩列表

**响应**：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 100,
        "member": {
          "user_id": 50,
          "nickname": "张三"
        },
        "track": {
          "id": 1,
          "name": "浙江国际赛车场"
        },
        "lap_time": "1:48.532",
        "car_brand": "大众",
        "car_model": "高尔夫R",
        "timing_photo": "https://xxx/photo.jpg",
        "video_url": "https://xxx/video.mp4",
        "record_date": "2025-01-15",
        "notes": "2025年1月浙赛赛道日",
        "sync_to_public": false,
        "created_at": "2025-01-15T12:00:00Z"
      }
    ]
  }
}
```

---

### 15.4 审核成绩

**接口**：`POST /api/v1/laptracker/orgs/:slug/admin/records/:id/review`

**描述**：审核成员提交的成绩

**请求体**：
```json
{
  "action": "approve"
}
```

**action 枚举值**：
- `approve` - 通过
- `reject` - 拒绝

**响应**：
```json
{
  "code": 0,
  "message": "审核通过",
  "data": {
    "verify_status": "approved",
    "public_record_id": null
  }
}
```

**业务规则**：
- 审核通过后，成绩进入组织榜单
- 如果 `sync_to_public=true`，会自动创建公开成绩并进入投票验证流程

---

### 15.5 移除成员

**接口**：`DELETE /api/v1/laptracker/orgs/:slug/admin/members/:id`

**描述**：从组织中移除成员

**响应**：
```json
{
  "code": 0,
  "message": "成员已移除"
}
```

---

### 15.6 更新组织信息

**接口**：`PUT /api/v1/laptracker/orgs/:slug/admin/info`

**描述**：更新组织品牌信息

**请求体**：
```json
{
  "name": "键盘车神教",
  "description": "专注赛道圈速测试的汽车媒体",
  "logo_url": "https://xxx/logo.png",
  "cover_url": "https://xxx/cover.jpg",
  "theme_color": "#3B82F6",
  "contact_name": "联系人",
  "contact_phone": "13800138000"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "更新成功"
}
```

---

### 15.7 管理赞助商

**接口**：`POST /api/v1/laptracker/orgs/:slug/admin/sponsors`

**描述**：添加/更新/删除赞助商

**请求体**：
```json
{
  "action": "add",
  "sponsor": {
    "name": "米其林",
    "logo_url": "https://xxx/michelin.png",
    "link_url": "https://michelin.com",
    "sort_order": 1
  }
}
```

或删除：
```json
{
  "action": "delete",
  "sponsor_id": 5
}
```

**action 枚举值**：
- `add` - 添加赞助商
- `update` - 更新赞助商
- `delete` - 删除赞助商

**响应**：
```json
{
  "code": 0,
  "message": "操作成功"
}
```

---

## 16. WebSocket 接口

### 16.1 GPS 计时实时推送

**连接**：`wss://xxx/api/v1/laptracker/ws/timing`

**认证**：通过 URL 参数传递 token
```
wss://xxx/api/v1/laptracker/ws/timing?token=<jwt_token>
```

**客户端发送（上报GPS位置）**：
```json
{
  "type": "gps_update",
  "data": {
    "lat": 30.123456,
    "lon": 120.654321,
    "accuracy": 5.0,
    "timestamp": 1705475400000
  }
}
```

**服务端推送（计时状态）**：
```json
{
  "type": "timing_status",
  "data": {
    "status": "running",
    "elapsed_ms": 45230,
    "distance_to_end": 2500
  }
}
```

**服务端推送（计时完成）**：
```json
{
  "type": "timing_complete",
  "data": {
    "lap_time": "3:45.678",
    "lap_time_ms": 225678
  }
}
```

---

## 17. 附录

### 17.1 改装程度说明

| 值 | 名称 | 说明 |
|-----|------|------|
| 0 | 原厂 | 完全原厂状态 |
| 1 | 轻度改装 | 刹车片/避震/轮胎 |
| 2 | 中度改装 | 轮毂/ECU/进排气 |
| 3 | 赛化改装 | 防滚架/赛车座椅/无限制 |

### 17.2 天气选项

| 值 | 说明 |
|-----|------|
| 晴 | 干燥路面，晴天 |
| 阴 | 干燥路面，阴天 |
| 雨 | 雨天，湿滑路面 |
| 湿地 | 非下雨，但路面潮湿 |

### 17.3 车辆级别

| 值 | 说明 |
|-----|------|
| A00 | 微型车 |
| A0 | 小型车 |
| A | 紧凑型 |
| B | 中型车 |
| C | 中大型 |
| D | 大型车 |
| SUV | SUV |
| MPV | MPV |
| 跑车 | 跑车 |

### 17.4 动力类型

| 值 | 说明 |
|-----|------|
| 燃油 | 纯燃油车 |
| 纯电 | 纯电动车 |
| 混动 | 混合动力 |

### 17.5 价格区间

| 值 | 说明 |
|-----|------|
| 0-20万 | 20万以下 |
| 20-50万 | 20-50万 |
| 50-100万 | 50-100万 |
| 100万+ | 100万以上 |

### 17.6 组织类型

| 值 | 说明 |
|-----|------|
| club | 俱乐部/车友会 |
| organizer | 赛道日组织方 |
| media | 媒体/车评人 |
| shop | 改装店/服务商 |

### 17.7 组织状态

| 值 | 说明 |
|-----|------|
| active | 正常使用 |
| suspended | 暂停服务 |
| expired | 已过期 |

### 17.8 组织成员角色

| 值 | 说明 |
|-----|------|
| admin | 管理员 |
| member | 普通成员 |

### 17.9 组织成绩审核状态

| 值 | 说明 |
|-----|------|
| pending | 待审核 |
| approved | 已通过 |
| rejected | 已拒绝 |
