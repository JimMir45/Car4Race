# Car4Race 圈速榜 - 数据库设计

## 1. 设计原则

| 原则 | 说明 |
|------|------|
| **共用用户表** | 与 HPA 共用 User 表，避免重复存储 |
| **独立业务表** | 圈速榜业务表独立，便于模块解耦 |
| **表名前缀** | 圈速榜相关表使用 `lt_` 前缀（LapTracker） |
| **软删除** | 重要数据使用软删除，保留历史记录 |
| **索引优化** | 针对查询场景设计索引 |

---

## 2. ER 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据库 ER 图                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐                                                            │
│  │    User     │ (HPA 共用)                                                 │
│  │─────────────│                                                            │
│  │ id          │◄───────────────────────────────────────────┐               │
│  │ phone       │                                            │               │
│  │ username    │                                            │               │
│  │ ...         │                                            │               │
│  └─────────────┘                                            │               │
│         │                                                   │               │
│         │ 1:N                                               │               │
│         ▼                                                   │               │
│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐           │
│  │ lt_record   │         │  lt_track   │         │ lt_mountain │           │
│  │─────────────│         │─────────────│         │─────────────│           │
│  │ id          │         │ id          │         │ id          │           │
│  │ user_id     │────────►│ name        │         │ name        │           │
│  │ track_id    │         │ source      │         │ creator_id  │───────────┘
│  │ track_type  │────────►│ ...         │         │ start_lat   │
│  │ lap_time    │         └─────────────┘         │ start_lon   │
│  │ car_brand   │                                 │ end_lat     │
│  │ car_model   │                                 │ end_lon     │
│  │ ...         │                                 │ status      │
│  └─────────────┘                                 └─────────────┘
│         │                                               │
│         │ 1:1                                           │ 1:N
│         ▼                                               ▼
│  ┌─────────────┐                                ┌─────────────┐
│  │ lt_vote_    │                                │ lt_mountain │
│  │ session     │                                │ _appeal     │
│  │─────────────│                                │─────────────│
│  │ id          │                                │ id          │
│  │ record_id   │                                │ mountain_id │
│  │ status      │                                │ user_id     │
│  │ result      │                                │ reason      │
│  │ ...         │                                │ status      │
│  └─────────────┘                                └─────────────┘
│         │
│         │ 1:N
│         ▼
│  ┌─────────────┐         ┌─────────────┐
│  │  lt_vote    │         │ lt_crawled  │
│  │─────────────│         │ _record     │
│  │ id          │         │─────────────│
│  │ session_id  │         │ id          │
│  │ voter_id    │         │ source      │
│  │ is_fake     │         │ track_name  │
│  │ ...         │         │ lap_time    │
│  └─────────────┘         │ ...         │
│                          └─────────────┘
│
│  ┌─────────────┐         ┌─────────────┐
│  │ lt_record   │         │ lt_crawler  │
│  │ _appeal     │         │ _log        │
│  │─────────────│         │─────────────│
│  │ id          │         │ id          │
│  │ record_id   │         │ source      │
│  │ user_id     │         │ status      │
│  │ reason      │         │ records_cnt │
│  │ status      │         │ ...         │
│  └─────────────┘         └─────────────┘
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 表结构设计

### 3.1 User 表（HPA 共用）

> 该表由 HPA 定义，圈速榜直接引用，不做修改。

```sql
CREATE TABLE user (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    phone           TEXT NOT NULL UNIQUE,
    username        TEXT NOT NULL UNIQUE,
    password_hash   TEXT,
    is_member       INTEGER DEFAULT 0,
    member_expire   TEXT,
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,
    deleted_at      TEXT
);
```

### 3.2 lt_track 表（赛道表）

存储爬取的正规赛道信息。

```sql
CREATE TABLE lt_track (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,              -- 赛道名称
    short_name      TEXT,                       -- 简称
    location        TEXT,                       -- 地址
    length          REAL,                       -- 赛道长度（米）
    source          TEXT NOT NULL,              -- 数据来源：51gt3/kbracer/dongchedi/weibo
    source_url      TEXT,                       -- 来源链接
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL
);

-- 索引
CREATE INDEX idx_lt_track_name ON lt_track(name);
CREATE INDEX idx_lt_track_source ON lt_track(source);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| name | TEXT | ✅ | 赛道名称，如"浙江国际赛车场" |
| short_name | TEXT | ❌ | 简称，如"浙赛" |
| location | TEXT | ❌ | 地理位置 |
| length | REAL | ❌ | 赛道长度（米） |
| source | TEXT | ✅ | 数据来源 |
| source_url | TEXT | ❌ | 来源链接 |

### 3.3 lt_mountain 表（山路表）

存储用户标记的山路。

```sql
CREATE TABLE lt_mountain (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,              -- 山路名称
    creator_id      INTEGER NOT NULL,           -- 创建者用户ID
    start_lat       REAL NOT NULL,              -- 起点纬度
    start_lon       REAL NOT NULL,              -- 起点经度
    end_lat         REAL NOT NULL,              -- 终点纬度
    end_lon         REAL NOT NULL,              -- 终点经度
    distance        REAL,                       -- 预估距离（米）
    description     TEXT,                       -- 描述
    status          TEXT DEFAULT 'active',      -- 状态：active/appealing/disabled
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,
    deleted_at      TEXT,

    FOREIGN KEY (creator_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_mountain_creator ON lt_mountain(creator_id);
CREATE INDEX idx_lt_mountain_status ON lt_mountain(status);
CREATE INDEX idx_lt_mountain_location ON lt_mountain(start_lat, start_lon, end_lat, end_lon);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| name | TEXT | ✅ | 山路名称，用户自定义 |
| creator_id | INTEGER | ✅ | 创建者用户ID |
| start_lat | REAL | ✅ | 起点纬度 |
| start_lon | REAL | ✅ | 起点经度 |
| end_lat | REAL | ✅ | 终点纬度 |
| end_lon | REAL | ✅ | 终点经度 |
| distance | REAL | ❌ | 预估距离（系统计算） |
| description | TEXT | ❌ | 描述 |
| status | TEXT | ✅ | 状态 |

**status 枚举值**：

| 值 | 说明 |
|-----|------|
| active | 正常使用 |
| appealing | 申诉中 |
| disabled | 已禁用 |

### 3.4 lt_record 表（成绩记录表）

存储用户的圈速成绩记录。

```sql
CREATE TABLE lt_record (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id         INTEGER NOT NULL,           -- 用户ID
    track_type      TEXT NOT NULL,              -- 场地类型：track/mountain
    track_id        INTEGER NOT NULL,           -- 赛道ID 或 山路ID
    lap_time        TEXT NOT NULL,              -- 圈速 mm:ss.xxx
    lap_time_ms     INTEGER NOT NULL,           -- 圈速毫秒数（用于排序）
    car_brand       TEXT NOT NULL,              -- 车辆品牌
    car_model       TEXT NOT NULL,              -- 车辆型号
    car_level       TEXT,                       -- 车辆级别：A00/A0/A/B/C/D/SUV/MPV/跑车
    car_power       TEXT,                       -- 动力类型：燃油/纯电/混动
    car_price_range TEXT,                       -- 价格区间
    tire_brand      TEXT NOT NULL,              -- 轮胎品牌
    tire_model      TEXT NOT NULL,              -- 轮胎型号
    mod_level       INTEGER NOT NULL,           -- 改装程度 0-3
    weather         TEXT NOT NULL,              -- 天气：晴/阴/雨/湿地
    timing_photo    TEXT,                       -- 计时截图URL
    video_url       TEXT,                       -- 视频URL
    driver_name     TEXT,                       -- 驾驶人姓名
    record_date     TEXT NOT NULL,              -- 成绩日期
    notes           TEXT,                       -- 备注
    is_public       INTEGER DEFAULT 0,          -- 是否公开上榜
    is_best         INTEGER DEFAULT 0,          -- 是否为个人最佳
    verify_status   TEXT DEFAULT 'none',        -- 验证状态：none/pending/verified/rejected
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,
    deleted_at      TEXT,

    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_record_user ON lt_record(user_id);
CREATE INDEX idx_lt_record_track ON lt_record(track_type, track_id);
CREATE INDEX idx_lt_record_lap_time ON lt_record(lap_time_ms);
CREATE INDEX idx_lt_record_public ON lt_record(is_public, verify_status);
CREATE INDEX idx_lt_record_best ON lt_record(user_id, track_type, track_id, is_best);
CREATE INDEX idx_lt_record_car ON lt_record(car_brand, car_model);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| user_id | INTEGER | ✅ | 用户ID |
| track_type | TEXT | ✅ | 场地类型：track（赛道）/mountain（山路） |
| track_id | INTEGER | ✅ | 对应 lt_track.id 或 lt_mountain.id |
| lap_time | TEXT | ✅ | 圈速，格式 mm:ss.xxx |
| lap_time_ms | INTEGER | ✅ | 圈速毫秒数，用于排序比较 |
| car_brand | TEXT | ✅ | 车辆品牌 |
| car_model | TEXT | ✅ | 车辆型号 |
| car_level | TEXT | ❌ | 车辆级别 |
| car_power | TEXT | ❌ | 动力类型 |
| car_price_range | TEXT | ❌ | 价格区间 |
| tire_brand | TEXT | ✅ | 轮胎品牌 |
| tire_model | TEXT | ✅ | 轮胎型号 |
| mod_level | INTEGER | ✅ | 改装程度 0-3 |
| weather | TEXT | ✅ | 天气条件 |
| timing_photo | TEXT | ❌ | 计时截图URL（上榜必填） |
| video_url | TEXT | ❌ | 视频URL（上榜必填） |
| driver_name | TEXT | ❌ | 驾驶人姓名 |
| record_date | TEXT | ✅ | 成绩日期 |
| notes | TEXT | ❌ | 备注 |
| is_public | INTEGER | ✅ | 是否公开上榜 |
| is_best | INTEGER | ✅ | 是否为个人最佳 |
| verify_status | TEXT | ✅ | 验证状态 |

**verify_status 枚举值**：

| 值 | 说明 |
|-----|------|
| none | 不需要验证（私密成绩） |
| pending | 待验证 |
| verified | 已验证通过 |
| rejected | 验证未通过 |

**mod_level 枚举值**：

| 值 | 说明 |
|-----|------|
| 0 | 原厂 |
| 1 | 轻度改装 |
| 2 | 中度改装 |
| 3 | 赛化改装 |

### 3.5 lt_vote_session 表（投票会话表）

存储成绩投票验证的会话信息。

```sql
CREATE TABLE lt_vote_session (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    record_id       INTEGER NOT NULL UNIQUE,    -- 成绩记录ID
    status          TEXT DEFAULT 'active',      -- 状态：active/completed/timeout
    result          TEXT,                       -- 结果：verified/rejected
    total_votes     INTEGER DEFAULT 0,          -- 已投票数
    fake_votes      INTEGER DEFAULT 0,          -- 假票数
    real_votes      INTEGER DEFAULT 0,          -- 真票数
    expires_at      TEXT NOT NULL,              -- 过期时间
    completed_at    TEXT,                       -- 完成时间
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,

    FOREIGN KEY (record_id) REFERENCES lt_record(id)
);

-- 索引
CREATE INDEX idx_lt_vote_session_status ON lt_vote_session(status);
CREATE INDEX idx_lt_vote_session_expires ON lt_vote_session(expires_at);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| record_id | INTEGER | ✅ | 成绩记录ID |
| status | TEXT | ✅ | 投票状态 |
| result | TEXT | ❌ | 投票结果 |
| total_votes | INTEGER | ✅ | 已投票数 |
| fake_votes | INTEGER | ✅ | 假票数 |
| real_votes | INTEGER | ✅ | 真票数 |
| expires_at | TEXT | ✅ | 过期时间 |
| completed_at | TEXT | ❌ | 完成时间 |

### 3.6 lt_vote 表（投票记录表）

存储单次投票记录。

```sql
CREATE TABLE lt_vote (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id      INTEGER NOT NULL,           -- 投票会话ID
    voter_id        INTEGER NOT NULL,           -- 投票人ID
    is_fake         INTEGER NOT NULL,           -- 是否认为是假：0否/1是
    created_at      TEXT NOT NULL,

    FOREIGN KEY (session_id) REFERENCES lt_vote_session(id),
    FOREIGN KEY (voter_id) REFERENCES user(id),
    UNIQUE(session_id, voter_id)                -- 一人一票
);

-- 索引
CREATE INDEX idx_lt_vote_session ON lt_vote(session_id);
CREATE INDEX idx_lt_vote_voter ON lt_vote(voter_id);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| session_id | INTEGER | ✅ | 投票会话ID |
| voter_id | INTEGER | ✅ | 投票人ID |
| is_fake | INTEGER | ✅ | 是否认为是假 |

### 3.7 lt_vote_assignment 表（投票分配表）

存储被分配的投票用户。

```sql
CREATE TABLE lt_vote_assignment (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id      INTEGER NOT NULL,           -- 投票会话ID
    voter_id        INTEGER NOT NULL,           -- 被分配的投票人ID
    notified        INTEGER DEFAULT 0,          -- 是否已通知
    voted           INTEGER DEFAULT 0,          -- 是否已投票
    created_at      TEXT NOT NULL,

    FOREIGN KEY (session_id) REFERENCES lt_vote_session(id),
    FOREIGN KEY (voter_id) REFERENCES user(id),
    UNIQUE(session_id, voter_id)
);

-- 索引
CREATE INDEX idx_lt_vote_assignment_session ON lt_vote_assignment(session_id);
CREATE INDEX idx_lt_vote_assignment_voter ON lt_vote_assignment(voter_id, voted);
```

### 3.8 lt_record_appeal 表（成绩申诉表）

存储用户对作废成绩的申诉。

```sql
CREATE TABLE lt_record_appeal (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    record_id       INTEGER NOT NULL,           -- 成绩记录ID
    user_id         INTEGER NOT NULL,           -- 申诉人ID
    reason          TEXT NOT NULL,              -- 申诉理由
    attachments     TEXT,                       -- 附件URL列表（JSON）
    status          TEXT DEFAULT 'pending',     -- 状态：pending/approved/rejected
    admin_notes     TEXT,                       -- 管理员备注
    handled_by      INTEGER,                    -- 处理人ID
    handled_at      TEXT,                       -- 处理时间
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,

    FOREIGN KEY (record_id) REFERENCES lt_record(id),
    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_record_appeal_record ON lt_record_appeal(record_id);
CREATE INDEX idx_lt_record_appeal_status ON lt_record_appeal(status);
```

### 3.9 lt_mountain_appeal 表（山路申诉表）

存储用户对山路标记的申诉。

```sql
CREATE TABLE lt_mountain_appeal (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    mountain_id     INTEGER NOT NULL,           -- 山路ID
    user_id         INTEGER NOT NULL,           -- 申诉人ID
    reason          TEXT NOT NULL,              -- 申诉理由：位置错误/命名不当/重复标记
    description     TEXT,                       -- 详细说明
    status          TEXT DEFAULT 'pending',     -- 状态：pending/approved/rejected
    admin_notes     TEXT,                       -- 管理员备注
    handled_by      INTEGER,                    -- 处理人ID
    handled_at      TEXT,                       -- 处理时间
    created_at      TEXT NOT NULL,

    FOREIGN KEY (mountain_id) REFERENCES lt_mountain(id),
    FOREIGN KEY (user_id) REFERENCES user(id),
    UNIQUE(mountain_id, user_id)                -- 一人对同一山路只能申诉一次
);

-- 索引
CREATE INDEX idx_lt_mountain_appeal_mountain ON lt_mountain_appeal(mountain_id);
CREATE INDEX idx_lt_mountain_appeal_status ON lt_mountain_appeal(status);
```

### 3.10 lt_crawled_record 表（爬虫成绩表）

存储从外部来源爬取的成绩数据。

```sql
CREATE TABLE lt_crawled_record (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    source          TEXT NOT NULL,              -- 来源：51gt3/kbracer/dongchedi/weibo
    source_type     TEXT NOT NULL,              -- 来源类型：official/dav
    source_url      TEXT,                       -- 原始链接
    track_name      TEXT NOT NULL,              -- 赛道名称
    track_id        INTEGER,                    -- 匹配到的赛道ID（可为空）
    lap_time        TEXT NOT NULL,              -- 圈速
    lap_time_ms     INTEGER NOT NULL,           -- 圈速毫秒数
    car_info        TEXT,                       -- 车型信息
    car_brand       TEXT,                       -- 车辆品牌（解析后）
    car_model       TEXT,                       -- 车辆型号（解析后）
    driver_name     TEXT,                       -- 驾驶人/媒体名称
    tire_info       TEXT,                       -- 轮胎信息
    mod_level       INTEGER,                    -- 改装程度
    record_date     TEXT,                       -- 成绩日期
    raw_data        TEXT,                       -- 原始数据（JSON）
    crawled_at      TEXT NOT NULL,              -- 爬取时间
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,

    UNIQUE(source, source_url)                  -- 避免重复爬取
);

-- 索引
CREATE INDEX idx_lt_crawled_record_source ON lt_crawled_record(source, source_type);
CREATE INDEX idx_lt_crawled_record_track ON lt_crawled_record(track_name);
CREATE INDEX idx_lt_crawled_record_lap_time ON lt_crawled_record(lap_time_ms);
CREATE INDEX idx_lt_crawled_record_car ON lt_crawled_record(car_brand, car_model);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| source | TEXT | ✅ | 数据来源 |
| source_type | TEXT | ✅ | 来源类型：official（官方）/dav（大V） |
| track_name | TEXT | ✅ | 赛道名称（原始） |
| track_id | INTEGER | ❌ | 匹配到的 lt_track.id |
| lap_time | TEXT | ✅ | 圈速 |
| car_info | TEXT | ❌ | 原始车型信息 |
| driver_name | TEXT | ❌ | 驾驶人/媒体名称 |
| raw_data | TEXT | ❌ | 原始数据JSON |

**source 枚举值**：

| 值 | 说明 |
|-----|------|
| 51gt3 | 51GT3 网站 |
| kbracer | 键盘车神教 |
| dongchedi | 懂车帝 |
| weibo | 赛道官方微博 |

**source_type 枚举值**：

| 值 | 说明 |
|-----|------|
| official | 官方成绩 |
| dav | 大V成绩 |

### 3.11 lt_crawler_log 表（爬虫日志表）

存储爬虫执行日志。

```sql
CREATE TABLE lt_crawler_log (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    source          TEXT NOT NULL,              -- 数据来源
    status          TEXT NOT NULL,              -- 执行状态：success/failed/partial
    records_total   INTEGER DEFAULT 0,          -- 总记录数
    records_new     INTEGER DEFAULT 0,          -- 新增记录数
    records_updated INTEGER DEFAULT 0,          -- 更新记录数
    error_message   TEXT,                       -- 错误信息
    started_at      TEXT NOT NULL,              -- 开始时间
    finished_at     TEXT,                       -- 结束时间
    created_at      TEXT NOT NULL
);

-- 索引
CREATE INDEX idx_lt_crawler_log_source ON lt_crawler_log(source);
CREATE INDEX idx_lt_crawler_log_started ON lt_crawler_log(started_at);
```

### 3.12 lt_user_ban 表（用户禁止上榜表）

存储被禁止上榜的用户。

```sql
CREATE TABLE lt_user_ban (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id         INTEGER NOT NULL UNIQUE,    -- 用户ID
    reason          TEXT NOT NULL,              -- 禁止原因
    record_id       INTEGER,                    -- 关联的成绩ID
    banned_at       TEXT NOT NULL,              -- 禁止时间
    lifted_at       TEXT,                       -- 解除时间
    is_active       INTEGER DEFAULT 1,          -- 是否生效

    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_user_ban_user ON lt_user_ban(user_id, is_active);
```

### 3.13 lt_disclaimer_agreement 表（免责声明同意表）

存储用户对山路免责声明的同意记录。

```sql
CREATE TABLE lt_disclaimer_agreement (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id         INTEGER NOT NULL,           -- 用户ID
    version         TEXT NOT NULL,              -- 声明版本
    agreed_at       TEXT NOT NULL,              -- 同意时间
    ip_address      TEXT,                       -- IP地址

    FOREIGN KEY (user_id) REFERENCES user(id),
    UNIQUE(user_id, version)
);

-- 索引
CREATE INDEX idx_lt_disclaimer_user ON lt_disclaimer_agreement(user_id);
```

### 3.14 lt_org 表（组织表）

存储组织信息。

```sql
CREATE TABLE lt_org (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,              -- 组织名称
    slug            TEXT NOT NULL UNIQUE,       -- URL 标识（如 kbracer）
    type            TEXT NOT NULL,              -- 类型：club/organizer/media/shop
    description     TEXT,                       -- 描述
    logo_url        TEXT,                       -- Logo URL
    cover_url       TEXT,                       -- 封面图 URL
    theme_color     TEXT DEFAULT '#3B82F6',     -- 主题色（HEX）
    contact_name    TEXT,                       -- 联系人姓名
    contact_phone   TEXT,                       -- 联系人电话
    status          TEXT DEFAULT 'active',      -- 状态：active/suspended/expired
    subscription_start TEXT,                    -- 订阅开始日期
    subscription_end   TEXT,                    -- 订阅结束日期
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,
    deleted_at      TEXT
);

-- 索引
CREATE INDEX idx_lt_org_slug ON lt_org(slug);
CREATE INDEX idx_lt_org_status ON lt_org(status);
CREATE INDEX idx_lt_org_type ON lt_org(type);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | INTEGER | ✅ | 主键 |
| name | TEXT | ✅ | 组织名称 |
| slug | TEXT | ✅ | URL 标识，用于专属链接 |
| type | TEXT | ✅ | 组织类型 |
| logo_url | TEXT | ❌ | Logo 图片 URL |
| cover_url | TEXT | ❌ | 封面图 URL |
| theme_color | TEXT | ❌ | 主题色，HEX 格式 |
| status | TEXT | ✅ | 组织状态 |
| subscription_start | TEXT | ❌ | 订阅开始日期 |
| subscription_end | TEXT | ❌ | 订阅结束日期 |

**type 枚举值**：

| 值 | 说明 |
|-----|------|
| club | 俱乐部/车友会 |
| organizer | 赛道日组织方 |
| media | 媒体/车评人 |
| shop | 改装店/服务商 |

**status 枚举值**：

| 值 | 说明 |
|-----|------|
| active | 正常使用 |
| suspended | 暂停服务 |
| expired | 已过期 |

### 3.15 lt_org_sponsor 表（组织赞助商表）

存储组织的赞助商信息。

```sql
CREATE TABLE lt_org_sponsor (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    org_id          INTEGER NOT NULL,           -- 组织ID
    name            TEXT NOT NULL,              -- 赞助商名称
    logo_url        TEXT,                       -- Logo URL
    link_url        TEXT,                       -- 链接 URL
    sort_order      INTEGER DEFAULT 0,          -- 排序
    created_at      TEXT NOT NULL,

    FOREIGN KEY (org_id) REFERENCES lt_org(id)
);

-- 索引
CREATE INDEX idx_lt_org_sponsor_org ON lt_org_sponsor(org_id, sort_order);
```

### 3.16 lt_org_member 表（组织成员表）

存储组织成员关系。

```sql
CREATE TABLE lt_org_member (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    org_id          INTEGER NOT NULL,           -- 组织ID
    user_id         INTEGER NOT NULL,           -- 用户ID
    role            TEXT DEFAULT 'member',      -- 角色：admin/member
    nickname        TEXT,                       -- 组织内昵称
    joined_at       TEXT NOT NULL,              -- 加入时间
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,

    FOREIGN KEY (org_id) REFERENCES lt_org(id),
    FOREIGN KEY (user_id) REFERENCES user(id),
    UNIQUE(org_id, user_id)
);

-- 索引
CREATE INDEX idx_lt_org_member_org ON lt_org_member(org_id);
CREATE INDEX idx_lt_org_member_user ON lt_org_member(user_id);
CREATE INDEX idx_lt_org_member_role ON lt_org_member(org_id, role);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| org_id | INTEGER | ✅ | 组织ID |
| user_id | INTEGER | ✅ | 用户ID |
| role | TEXT | ✅ | 角色：admin/member |
| nickname | TEXT | ❌ | 组织内昵称 |
| joined_at | TEXT | ✅ | 加入时间 |

**role 枚举值**：

| 值 | 说明 |
|-----|------|
| admin | 管理员 |
| member | 普通成员 |

### 3.17 lt_org_join_request 表（组织加入申请表）

存储用户申请加入组织的记录。

```sql
CREATE TABLE lt_org_join_request (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    org_id          INTEGER NOT NULL,           -- 组织ID
    user_id         INTEGER NOT NULL,           -- 申请人ID
    message         TEXT,                       -- 申请留言
    status          TEXT DEFAULT 'pending',     -- 状态：pending/approved/rejected
    handled_by      INTEGER,                    -- 处理人ID
    handled_at      TEXT,                       -- 处理时间
    reject_reason   TEXT,                       -- 拒绝原因
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,

    FOREIGN KEY (org_id) REFERENCES lt_org(id),
    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_org_join_request_org ON lt_org_join_request(org_id, status);
CREATE INDEX idx_lt_org_join_request_user ON lt_org_join_request(user_id);
```

### 3.18 lt_org_record 表（组织成绩表）

存储组织内的成绩记录。

```sql
CREATE TABLE lt_org_record (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    org_id          INTEGER NOT NULL,           -- 组织ID
    user_id         INTEGER NOT NULL,           -- 用户ID（成员）
    track_type      TEXT NOT NULL,              -- 场地类型：track/mountain
    track_id        INTEGER NOT NULL,           -- 赛道/山路 ID
    lap_time        TEXT NOT NULL,              -- 圈速 mm:ss.xxx
    lap_time_ms     INTEGER NOT NULL,           -- 圈速毫秒数
    car_brand       TEXT NOT NULL,              -- 车辆品牌
    car_model       TEXT NOT NULL,              -- 车辆型号
    tire_brand      TEXT,                       -- 轮胎品牌
    tire_model      TEXT,                       -- 轮胎型号
    mod_level       INTEGER DEFAULT 0,          -- 改装程度 0-3
    weather         TEXT,                       -- 天气
    timing_photo    TEXT,                       -- 计时截图 URL
    video_url       TEXT,                       -- 视频 URL
    record_date     TEXT NOT NULL,              -- 成绩日期
    notes           TEXT,                       -- 备注（可写活动信息）
    verify_status   TEXT DEFAULT 'pending',     -- 审核状态：pending/approved/rejected
    verified_by     INTEGER,                    -- 审核人ID
    verified_at     TEXT,                       -- 审核时间
    sync_to_public  INTEGER DEFAULT 0,          -- 是否同步到综合榜单
    public_record_id INTEGER,                   -- 对应的公开成绩ID
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL,
    deleted_at      TEXT,

    FOREIGN KEY (org_id) REFERENCES lt_org(id),
    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- 索引
CREATE INDEX idx_lt_org_record_org ON lt_org_record(org_id);
CREATE INDEX idx_lt_org_record_user ON lt_org_record(org_id, user_id);
CREATE INDEX idx_lt_org_record_track ON lt_org_record(org_id, track_type, track_id);
CREATE INDEX idx_lt_org_record_lap_time ON lt_org_record(org_id, lap_time_ms);
CREATE INDEX idx_lt_org_record_status ON lt_org_record(org_id, verify_status);
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| org_id | INTEGER | ✅ | 组织ID |
| user_id | INTEGER | ✅ | 成员用户ID |
| verify_status | TEXT | ✅ | 审核状态 |
| verified_by | INTEGER | ❌ | 审核人（管理员）ID |
| sync_to_public | INTEGER | ✅ | 是否同步到综合榜单 |
| public_record_id | INTEGER | ❌ | 同步后的公开成绩ID |
| notes | TEXT | ❌ | 备注，可填写活动信息 |

**verify_status 枚举值**：

| 值 | 说明 |
|-----|------|
| pending | 待审核 |
| approved | 已通过 |
| rejected | 已拒绝 |

---

## 4. 表关系说明

### 4.1 关系图

```
User (HPA共用)
  │
  ├── 1:N ──► lt_record (成绩记录)
  │              │
  │              ├── 1:1 ──► lt_vote_session (投票会话)
  │              │              │
  │              │              └── 1:N ──► lt_vote (投票记录)
  │              │              └── 1:N ──► lt_vote_assignment (投票分配)
  │              │
  │              └── 1:N ──► lt_record_appeal (成绩申诉)
  │
  ├── 1:N ──► lt_mountain (山路标记)
  │              │
  │              └── 1:N ──► lt_mountain_appeal (山路申诉)
  │
  ├── 1:N ──► lt_vote (作为投票人)
  │
  ├── 1:N ──► lt_mountain_appeal (作为申诉人)
  │
  ├── 1:1 ──► lt_user_ban (禁止上榜)
  │
  ├── 1:N ──► lt_disclaimer_agreement (免责同意)
  │
  ├── N:M ──► lt_org (通过 lt_org_member)
  │              │
  │              └── 1:N ──► lt_org_record (组织成绩)
  │
  └── 1:N ──► lt_org_join_request (加入申请)

lt_org (组织)
  │
  ├── 1:N ──► lt_org_member (成员)
  ├── 1:N ──► lt_org_sponsor (赞助商)
  ├── 1:N ──► lt_org_record (组织成绩)
  └── 1:N ──► lt_org_join_request (加入申请)

lt_track (赛道)
  │
  └── 1:N ──► lt_record (track_type='track')
  └── 1:N ──► lt_org_record (track_type='track')
  └── 1:N ──► lt_crawled_record

lt_mountain (山路)
  │
  └── 1:N ──► lt_record (track_type='mountain')
  └── 1:N ──► lt_org_record (track_type='mountain')
```

### 4.2 关系说明

| 关系 | 说明 |
|------|------|
| User → lt_record | 一个用户可以有多条成绩记录 |
| User → lt_mountain | 一个用户可以创建多条山路 |
| lt_record → lt_vote_session | 一条公开成绩对应一个投票会话 |
| lt_vote_session → lt_vote | 一个投票会话最多 10 票 |
| lt_mountain → lt_mountain_appeal | 一条山路可被多人申诉 |
| lt_record → lt_record_appeal | 一条成绩可以申诉一次 |
| User ↔ lt_org | 多对多关系，通过 lt_org_member 关联 |
| lt_org → lt_org_member | 一个组织可有多个成员 |
| lt_org → lt_org_record | 一个组织可有多条成绩记录 |
| lt_org → lt_org_sponsor | 一个组织可有多个赞助商 |
| lt_org_record → lt_record | 组织成绩可同步到公开成绩（可选） |

---

## 5. 索引设计

### 5.1 查询场景与索引

| 查询场景 | 涉及表 | 索引 |
|----------|--------|------|
| 按赛道查榜单 | lt_record | idx_lt_record_track |
| 按圈速排序 | lt_record | idx_lt_record_lap_time |
| 查用户成绩 | lt_record | idx_lt_record_user |
| 查用户最佳 | lt_record | idx_lt_record_best |
| 按车型筛选 | lt_record | idx_lt_record_car |
| 查公开已验证 | lt_record | idx_lt_record_public |
| 查待验证投票 | lt_vote_session | idx_lt_vote_session_status |
| 查用户待投 | lt_vote_assignment | idx_lt_vote_assignment_voter |
| 按来源查爬虫数据 | lt_crawled_record | idx_lt_crawled_record_source |
| 按 slug 查组织 | lt_org | idx_lt_org_slug |
| 查组织成员 | lt_org_member | idx_lt_org_member_org |
| 查用户所属组织 | lt_org_member | idx_lt_org_member_user |
| 查组织管理员 | lt_org_member | idx_lt_org_member_role |
| 查组织待审批申请 | lt_org_join_request | idx_lt_org_join_request_org |
| 查组织成绩榜单 | lt_org_record | idx_lt_org_record_org |
| 查组织成员成绩 | lt_org_record | idx_lt_org_record_user |
| 按圈速排序组织榜单 | lt_org_record | idx_lt_org_record_lap_time |
| 查组织待审核成绩 | lt_org_record | idx_lt_org_record_status |

### 5.2 复合索引说明

```sql
-- 用户在某赛道的最佳成绩查询
CREATE INDEX idx_lt_record_best ON lt_record(user_id, track_type, track_id, is_best);

-- 综合榜单查询（公开+已验证）
CREATE INDEX idx_lt_record_public ON lt_record(is_public, verify_status);

-- 山路地理位置查询（用于重叠检测）
CREATE INDEX idx_lt_mountain_location ON lt_mountain(start_lat, start_lon, end_lat, end_lon);

-- 组织成员角色查询（用于查找组织管理员）
CREATE INDEX idx_lt_org_member_role ON lt_org_member(org_id, role);

-- 组织成绩按赛道+圈速查询（用于组织榜单排序）
CREATE INDEX idx_lt_org_record_track ON lt_org_record(org_id, track_type, track_id);
CREATE INDEX idx_lt_org_record_lap_time ON lt_org_record(org_id, lap_time_ms);

-- 组织成绩审核状态查询
CREATE INDEX idx_lt_org_record_status ON lt_org_record(org_id, verify_status);
```

---

## 6. 数据迁移

### 6.1 初始化脚本

```sql
-- 创建所有表
-- （包含上述所有 CREATE TABLE 语句）

-- 初始化赛道数据（爬虫后续填充）
-- 暂时手动插入几条测试数据
INSERT INTO lt_track (name, short_name, source, created_at, updated_at) VALUES
('浙江国际赛车场', '浙赛', 'manual', datetime('now'), datetime('now')),
('上海国际赛车场', '上赛', 'manual', datetime('now'), datetime('now')),
('北京金港汽车公园', '金港', 'manual', datetime('now'), datetime('now')),
('北京锐思赛车场', '锐思', 'manual', datetime('now'), datetime('now')),
('上海天马赛车场', '天马', 'manual', datetime('now'), datetime('now')),
('珠海国际赛车场', '珠海', 'manual', datetime('now'), datetime('now')),
('广东国际赛车场', '广东', 'manual', datetime('now'), datetime('now'));

-- 示例：创建测试组织（实际由平台管理员操作）
-- INSERT INTO lt_org (name, slug, type, description, theme_color, status, created_at, updated_at) VALUES
-- ('键盘车神教', 'kbracer', 'media', '专注赛道圈速测试的汽车媒体', '#3B82F6', 'active', datetime('now'), datetime('now'));
```

### 6.2 数据备份

```bash
# 每日备份
sqlite3 /app/data/hpa.db ".backup /app/backup/hpa_$(date +%Y%m%d).db"

# 保留最近 30 天
find /app/backup -name "hpa_*.db" -mtime +30 -delete
```

---

## 7. 圈速时间处理

### 7.1 格式转换

圈速存储两种格式：
- `lap_time`：字符串格式 `mm:ss.xxx`，用于展示
- `lap_time_ms`：毫秒数，用于排序和比较

```go
// 解析圈速字符串为毫秒
func ParseLapTime(lapTime string) (int64, error) {
    // 格式: mm:ss.xxx 或 m:ss.xxx
    parts := strings.Split(lapTime, ":")
    if len(parts) != 2 {
        return 0, errors.New("invalid lap time format")
    }

    minutes, err := strconv.ParseInt(parts[0], 10, 64)
    if err != nil {
        return 0, err
    }

    secParts := strings.Split(parts[1], ".")
    seconds, err := strconv.ParseInt(secParts[0], 10, 64)
    if err != nil {
        return 0, err
    }

    var milliseconds int64 = 0
    if len(secParts) > 1 {
        msStr := secParts[1]
        // 补齐到 3 位
        for len(msStr) < 3 {
            msStr += "0"
        }
        if len(msStr) > 3 {
            msStr = msStr[:3]
        }
        milliseconds, _ = strconv.ParseInt(msStr, 10, 64)
    }

    return minutes*60*1000 + seconds*1000 + milliseconds, nil
}

// 毫秒转圈速字符串
func FormatLapTime(ms int64) string {
    minutes := ms / 60000
    seconds := (ms % 60000) / 1000
    milliseconds := ms % 1000
    return fmt.Sprintf("%d:%02d.%03d", minutes, seconds, milliseconds)
}
```

### 7.2 示例

| 圈速字符串 | 毫秒数 |
|-----------|--------|
| 1:48.532 | 108532 |
| 2:05.100 | 125100 |
| 0:59.999 | 59999 |

---

## 8. 扩展字段预留

### 8.1 lt_record 扩展

未来可能新增的字段：

| 字段 | 说明 |
|------|------|
| sector_times | 分段计时（JSON） |
| gps_trace | GPS 轨迹数据 |
| temperature | 气温 |
| track_condition | 赛道状况 |

### 8.2 lt_crawled_record 扩展

未来可能新增的字段：

| 字段 | 说明 |
|------|------|
| video_url | 视频链接 |
| image_url | 图片链接 |
| event_name | 赛事名称 |
