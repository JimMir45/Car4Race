# Car4Race 圈速榜 - 技术架构

## 1. 设计原则

| 原则 | 说明 |
|------|------|
| **与 HPA 保持一致** | 共用技术栈、用户体系，降低维护成本 |
| **简单优先** | MVP 阶段避免过度设计 |
| **模块独立** | 圈速榜作为独立模块，可单独部署 |
| **数据可靠** | 成绩数据不可丢失，爬虫数据可重建 |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户终端                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Web 浏览器  │  │   iOS App    │  │  Android App │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Docker Container                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                      Nginx                                │   │
│  │              静态资源服务 + 反向代理                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│              ┌───────────────┴───────────────┐                  │
│              ▼                               ▼                  │
│  ┌──────────────────────┐      ┌──────────────────────┐        │
│  │     HPA Backend      │      │  LapTracker Backend  │        │
│  │    (Go + Gin)        │      │    (Go + Gin)        │        │
│  │                      │      │                      │        │
│  │  • 用户认证          │      │  • 成绩记录          │        │
│  │  • 笔记管理          │◄────►│  • 榜单查询          │        │
│  │  • 课程管理          │ JWT  │  • 投票验证          │        │
│  │  • ...               │      │  • 山路管理          │        │
│  └──────────────────────┘      └──────────────────────┘        │
│              │                               │                  │
│              ▼                               ▼                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                      SQLite                               │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐          │   │
│  │  │  用户表    │  │  成绩表    │  │  榜单表    │          │   │
│  │  │  (共用)    │  │  (独立)    │  │  (独立)    │          │   │
│  │  └────────────┘  └────────────┘  └────────────┘          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    定时任务 (Cron)                        │   │
│  │  • 每日 05:00 执行爬虫任务                                │   │
│  │  • 爬取 51GT3 / 键盘车神教 / 懂车帝 / 赛道微博             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    文件存储                               │   │
│  │  • /static/photos/   成绩截图                            │   │
│  │  • /static/videos/   随车视频                            │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 模块关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             HPA 主项目                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                                                            │
│  │   用户模块    │◄──────────────────────┐                                   │
│  │  • 登录注册   │                       │                                   │
│  │  • JWT 认证   │                       │ 共用                               │
│  │  • 用户信息   │                       │                                   │
│  └──────────────┘                       │                                   │
│         │                               │                                   │
│         │ 调用                           │                                   │
│         ▼                               │                                   │
│  ┌──────────────────────────────────────┴──────────────────────────────┐    │
│  │                       圈速榜模块 (LapTracker)                        │    │
│  ├──────────────────────────────────────────────────────────────────────┤    │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │    │
│  │  │  成绩模块   │ │  榜单模块   │ │  场地模块   │ │  组织模块   │       │    │
│  │  │ • 记录成绩  │ │ • 综合榜单  │ │ • 赛道库   │ │ • 组织管理  │       │    │
│  │  │ • 最佳管理  │ │ • 车型筛选  │ │ • 山路标记  │ │ • 成员管理  │       │    │
│  │  │ • 数据导入  │ │ • 组织榜单  │ │ • 山路申诉  │ │ • 组织成绩  │       │    │
│  │  └────────────┘ └────────────┘ └────────────┘ │ • 品牌展示  │       │    │
│  │                                               └────────────┘       │    │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐                     │    │
│  │  │  验证模块   │ │  爬虫模块   │ │  计时模块   │                     │    │
│  │  │ • 成绩投票  │ │ • 定时任务  │ │ • GPS 计时  │                     │    │
│  │  │ • 成绩申诉  │ │ • 数据解析  │ │ • 起终点   │                     │    │
│  │  │ • 山路申诉  │ │ • 数据入库  │ │            │                     │    │
│  │  └────────────┘ └────────────┘ └────────────┘                     │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 技术栈

### 3.1 技术选型

| 层次 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **前端** | Vue 3 | 3.4+ | 与 HPA 保持一致 |
| | Vite | 5.0+ | 构建工具 |
| | TailwindCSS | 3.4+ | 样式框架 |
| | Mapbox/高德地图 | - | 山路标记地图 |
| **后端** | Go | 1.21+ | 与 HPA 保持一致 |
| | Gin | 1.9+ | Web 框架 |
| | GORM | 1.25+ | ORM |
| **数据库** | SQLite | 3 | 与 HPA 共用 |
| **定时任务** | go-cron | - | 爬虫调度 |
| **爬虫** | colly | 2.1+ | Go 爬虫框架 |
| **部署** | Docker | - | 容器化 |
| | Nginx | - | 反向代理 |

### 3.2 前端技术详情

```
前端 (Vue 3 + Vite)
│
├── 核心框架
│   ├── Vue 3.4+          # 响应式框架
│   ├── Vue Router 4      # 路由管理
│   └── Pinia             # 状态管理
│
├── UI 相关
│   ├── TailwindCSS 3.4+  # 原子化 CSS
│   └── Headless UI       # 无样式组件库
│
├── 地图相关
│   └── 高德地图 JS API    # 山路标记、GPS 显示
│
├── 工具库
│   ├── axios             # HTTP 请求
│   ├── dayjs             # 日期处理
│   └── Papa Parse        # CSV 解析（RaceChrono 导入）
│
└── 构建工具
    └── Vite 5.0+         # 快速构建
```

### 3.3 后端技术详情

```
后端 (Go + Gin)
│
├── Web 框架
│   ├── Gin 1.9+          # HTTP 路由、中间件
│   └── gin-jwt           # JWT 认证
│
├── 数据库
│   ├── GORM 1.25+        # ORM
│   └── SQLite Driver     # SQLite 驱动
│
├── 爬虫相关
│   ├── colly 2.1+        # 爬虫框架
│   └── goquery           # HTML 解析
│
├── 定时任务
│   └── go-cron           # 定时调度
│
├── 工具库
│   ├── viper             # 配置管理
│   ├── zap               # 日志
│   └── validator         # 参数校验
│
└── 文件处理
    ├── 图片处理           # 成绩截图
    └── 视频处理           # 随车视频（仅存储）
```

---

## 4. 项目结构

### 4.1 目录结构

```
Car4Race/
├── docs/                          # 文档目录
│   ├── README.md                  # HPA 文档导航
│   ├── 01-立项/                   # HPA 立项文档
│   ├── 02-设计/                   # HPA 设计文档
│   └── 圈速榜/                    # 圈速榜文档
│       ├── 01-立项/
│       ├── 02-设计/
│       ├── 03-测试/
│       ├── 04-部署/
│       └── 05-运营/
│
├── frontend/                      # 前端代码（HPA + 圈速榜）
│   ├── src/
│   │   ├── components/            # 通用组件
│   │   ├── views/
│   │   │   ├── hpa/               # HPA 页面
│   │   │   └── laptracker/        # 圈速榜页面
│   │   │       ├── RecordView.vue      # 记录成绩
│   │   │       ├── MyRecordsView.vue   # 我的记录
│   │   │       ├── LeaderboardView.vue # 榜单
│   │   │       ├── TrackMapView.vue    # 山路地图
│   │   │       └── VoteView.vue        # 投票
│   │   ├── stores/
│   │   │   ├── user.js            # 用户状态（共用）
│   │   │   └── laptracker.js      # 圈速榜状态
│   │   ├── router/
│   │   │   └── index.js           # 路由配置
│   │   └── utils/
│   │       ├── api.js             # API 封装
│   │       ├── gps.js             # GPS 工具
│   │       └── csv-parser.js      # CSV 解析
│   ├── package.json
│   └── vite.config.js
│
├── backend/                       # 后端代码（HPA + 圈速榜）
│   ├── cmd/
│   │   └── server/
│   │       └── main.go            # 程序入口
│   ├── internal/
│   │   ├── middleware/            # 中间件
│   │   │   ├── auth.go            # JWT 认证
│   │   │   └── ratelimit.go       # 频率限制
│   │   ├── handler/               # HTTP 处理器
│   │   │   ├── hpa/               # HPA 处理器
│   │   │   └── laptracker/        # 圈速榜处理器
│   │   │       ├── record.go      # 成绩记录
│   │   │       ├── leaderboard.go # 榜单查询
│   │   │       ├── track.go       # 场地管理
│   │   │       ├── vote.go        # 投票验证
│   │   │       └── appeal.go      # 申诉处理
│   │   ├── service/               # 业务逻辑
│   │   │   ├── hpa/               # HPA 服务
│   │   │   └── laptracker/        # 圈速榜服务
│   │   │       ├── record.go
│   │   │       ├── leaderboard.go
│   │   │       ├── track.go
│   │   │       ├── vote.go
│   │   │       └── crawler.go     # 爬虫服务
│   │   ├── repository/            # 数据访问
│   │   │   ├── user.go            # 用户（共用）
│   │   │   └── laptracker/        # 圈速榜数据
│   │   │       ├── record.go
│   │   │       ├── track.go
│   │   │       └── vote.go
│   │   └── model/                 # 数据模型
│   │       ├── user.go            # 用户模型（共用）
│   │       └── laptracker/        # 圈速榜模型
│   │           ├── record.go
│   │           ├── track.go
│   │           └── vote.go
│   ├── pkg/                       # 可复用包
│   │   ├── crawler/               # 爬虫实现
│   │   │   ├── 51gt3.go
│   │   │   ├── kbracer.go
│   │   │   ├── dongchedi.go
│   │   │   └── weibo.go
│   │   ├── gps/                   # GPS 计算
│   │   │   └── distance.go
│   │   └── csv/                   # CSV 解析
│   │       └── racechrono.go
│   ├── config/
│   │   └── config.yaml            # 配置文件
│   ├── go.mod
│   └── go.sum
│
├── data/                          # 数据目录
│   ├── hpa.db                     # SQLite 数据库
│   └── crawler/                   # 爬虫缓存
│
├── static/                        # 静态文件
│   ├── photos/                    # 成绩截图
│   └── videos/                    # 随车视频
│
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
│
└── scripts/
    └── crawler.sh                 # 爬虫脚本
```

---

## 5. 核心流程

### 5.1 成绩记录流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  前端     │     │  Handler │     │  Service │     │   Repo   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │  POST /record  │                │                │
     │───────────────►│                │                │
     │                │  CreateRecord  │                │
     │                │───────────────►│                │
     │                │                │  检查用户     │
     │                │                │───────────────►│
     │                │                │◄───────────────│
     │                │                │                │
     │                │                │  是否公开上榜？ │
     │                │                │                │
     │                │                │ [是]           │
     │                │                │  检查必填项    │
     │                │                │  照片+视频     │
     │                │                │                │
     │                │                │  创建待验证记录│
     │                │                │───────────────►│
     │                │                │◄───────────────│
     │                │                │                │
     │                │                │  分配投票用户  │
     │                │                │───────────────►│
     │                │                │◄───────────────│
     │                │                │                │
     │                │                │ [否]           │
     │                │                │  创建私密记录  │
     │                │                │───────────────►│
     │                │◄───────────────│◄───────────────│
     │◄───────────────│                │                │
     │                │                │                │
```

### 5.2 投票验证流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  前端     │     │  Handler │     │  Service │     │   Repo   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │  POST /vote    │                │                │
     │───────────────►│                │                │
     │                │  CastVote      │                │
     │                │───────────────►│                │
     │                │                │  检查投票资格  │
     │                │                │───────────────►│
     │                │                │◄───────────────│
     │                │                │                │
     │                │                │  记录投票      │
     │                │                │───────────────►│
     │                │                │◄───────────────│
     │                │                │                │
     │                │                │  检查投票完成  │
     │                │                │  (10票)        │
     │                │                │                │
     │                │                │ [已满10票]     │
     │                │                │  统计结果      │
     │                │                │                │
     │                │                │ [<5假]         │
     │                │                │  成绩上榜      │
     │                │                │───────────────►│
     │                │                │                │
     │                │                │ [≥5假]         │
     │                │                │  成绩作废      │
     │                │                │  禁止上榜      │
     │                │                │───────────────►│
     │                │                │                │
     │                │◄───────────────│◄───────────────│
     │◄───────────────│                │                │
```

### 5.3 GPS 计时流程

```
┌──────────────────────────────────────────────────────────────┐
│                        前端 GPS 计时                          │
└──────────────────────────────────────────────────────────────┘

用户选择山路
     │
     ▼
显示免责声明 ──否──→ 返回
     │
    是
     │
     ▼
开启 GPS 监听
     │
     ▼
┌─────────────────────┐
│  持续获取 GPS 位置   │◄───────────┐
│  计算与起点距离      │            │
└─────────────────────┘            │
     │                             │
     ▼                             │
距离 < 阈值？ ──否────────────────►│
     │                             │
    是                             │
     │                             │
     ▼                             │
开始计时                           │
     │                             │
     ▼                             │
┌─────────────────────┐            │
│  持续获取 GPS 位置   │◄──────┐   │
│  计算与终点距离      │       │   │
└─────────────────────┘       │   │
     │                        │   │
     ▼                        │   │
距离 < 阈值？ ──否───────────►│   │
     │                             │
    是                             │
     │                             │
     ▼                             │
停止计时
     │
     ▼
显示成绩
     │
     ▼
保存成绩
```

### 5.4 爬虫执行流程

```
每日 05:00 触发
     │
     ▼
┌─────────────────────────────────────────┐
│             爬虫调度器                   │
│                                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 51GT3   │ │ 键盘车神 │ │ 懂车帝   │   │
│  │ 爬虫    │ │ 爬虫    │ │ 爬虫    │   │
│  └────┬────┘ └────┬────┘ └────┬────┘   │
│       │          │          │          │
│       ▼          ▼          ▼          │
│  ┌─────────────────────────────────┐   │
│  │         数据解析器               │   │
│  │  • 提取圈速、车型、驾驶人等      │   │
│  │  • 标准化数据格式               │   │
│  └─────────────────────────────────┘   │
│                   │                     │
│                   ▼                     │
│  ┌─────────────────────────────────┐   │
│  │         数据去重器               │   │
│  │  • 检查是否已存在               │   │
│  │  • 更新或新增                   │   │
│  └─────────────────────────────────┘   │
│                   │                     │
│                   ▼                     │
│  ┌─────────────────────────────────┐   │
│  │         数据入库                 │   │
│  │  • 写入 SQLite                  │   │
│  │  • 记录爬取日志                 │   │
│  └─────────────────────────────────┘   │
│                                          │
└─────────────────────────────────────────┘
```

---

## 6. 关键技术点

### 6.1 GPS 计时精度

**问题**：手机 GPS 精度通常在 5-15 米，可能影响计时准确性

**解决方案**：
1. 设置起终点触发半径（如 20 米）
2. 支持外置高精度 GPS 设备
3. 使用 GPS 平滑算法减少跳点
4. 提示用户 GPS 精度，低精度时警告

```go
// GPS 距离计算（Haversine 公式）
func CalculateDistance(lat1, lon1, lat2, lon2 float64) float64 {
    const R = 6371000 // 地球半径（米）

    lat1Rad := lat1 * math.Pi / 180
    lat2Rad := lat2 * math.Pi / 180
    deltaLat := (lat2 - lat1) * math.Pi / 180
    deltaLon := (lon2 - lon1) * math.Pi / 180

    a := math.Sin(deltaLat/2)*math.Sin(deltaLat/2) +
         math.Cos(lat1Rad)*math.Cos(lat2Rad)*
         math.Sin(deltaLon/2)*math.Sin(deltaLon/2)

    c := 2 * math.Atan2(math.Sqrt(a), math.Sqrt(1-a))

    return R * c
}

// 检查是否进入触发区域
func IsInTriggerZone(currentLat, currentLon, targetLat, targetLon float64, radius float64) bool {
    distance := CalculateDistance(currentLat, currentLon, targetLat, targetLon)
    return distance <= radius
}
```

### 6.2 山路唯一性判断

**问题**：如何判断两个山路标记是否重叠

**解决方案**：
1. 计算起点距离，小于阈值（如 100 米）视为相同起点
2. 计算终点距离，小于阈值视为相同终点
3. 起终点都相同，则视为同一路段

```go
const OVERLAP_THRESHOLD = 100.0 // 米

func IsOverlapping(track1, track2 *MountainTrack) bool {
    startDistance := CalculateDistance(
        track1.StartLat, track1.StartLon,
        track2.StartLat, track2.StartLon,
    )
    endDistance := CalculateDistance(
        track1.EndLat, track1.EndLon,
        track2.EndLat, track2.EndLon,
    )

    return startDistance < OVERLAP_THRESHOLD && endDistance < OVERLAP_THRESHOLD
}
```

### 6.3 投票用户选取

**问题**：如何选取 10 名投票用户

**解决方案**：
1. 优先选取同赛道有成绩的用户
2. 不足则从近期活跃用户中补充
3. 排除成绩提交者本人

```go
func SelectVoters(recordID int64, trackID int64, submitterID int64) ([]int64, error) {
    var voters []int64

    // 1. 同赛道有成绩的用户（排除提交者）
    sameTrackUsers, _ := repo.GetUsersWithRecordsOnTrack(trackID, submitterID)
    voters = append(voters, sameTrackUsers...)

    // 2. 如果不足 10 人，从活跃用户中补充
    if len(voters) < 10 {
        needed := 10 - len(voters)
        activeUsers, _ := repo.GetActiveUsers(needed, append(voters, submitterID))
        voters = append(voters, activeUsers...)
    }

    // 3. 随机打乱，取前 10 个
    rand.Shuffle(len(voters), func(i, j int) {
        voters[i], voters[j] = voters[j], voters[i]
    })

    if len(voters) > 10 {
        voters = voters[:10]
    }

    return voters, nil
}
```

### 6.4 RaceChrono 数据解析

**问题**：需要解析 RaceChrono 导出的 CSV 文件

**解决方案**：
1. 分析 RaceChrono CSV 格式
2. 提取圈速、赛道、日期等字段
3. 匹配系统中的赛道
4. 批量导入

```go
type RaceChronoRecord struct {
    LapTime     string
    TrackName   string
    RecordDate  time.Time
    // ...
}

func ParseRaceChronoCSV(file io.Reader) ([]RaceChronoRecord, error) {
    reader := csv.NewReader(file)
    records, err := reader.ReadAll()
    if err != nil {
        return nil, err
    }

    var result []RaceChronoRecord
    for _, row := range records[1:] { // 跳过表头
        record := RaceChronoRecord{
            LapTime:    row[0],
            TrackName:  row[1],
            RecordDate: parseDate(row[2]),
        }
        result = append(result, record)
    }

    return result, nil
}
```

---

## 7. 安全设计

### 7.1 认证授权

| 方案 | 说明 |
|------|------|
| JWT 认证 | 与 HPA 共用，统一登录 |
| 角色权限 | 游客、用户、管理员 |
| 接口鉴权 | 中间件统一校验 |

### 7.2 数据安全

| 风险 | 措施 |
|------|------|
| 成绩造假 | 投票验证机制 |
| 刷票 | 限制投票资格、一人一票 |
| 视频隐私 | 提醒脱敏、责任声明 |
| 爬虫封禁 | 合理频率、遵守 robots.txt |

### 7.3 接口安全

| 措施 | 说明 |
|------|------|
| HTTPS | 全站 HTTPS |
| CSRF | Token 校验 |
| 参数校验 | 严格校验输入 |
| 频率限制 | 防止刷接口 |

---

## 8. 部署架构

### 8.1 部署模式

系统支持两种部署模式，满足不同组织的需求：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **SaaS 模式** | 组织在平台上开通专属榜单，数据托管在平台 | 中小型俱乐部、媒体 |
| **私有化部署** | 为大客户单独部署整套系统，完全独立 | 大型俱乐部、企业客户 |

#### SaaS 模式架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        SaaS 平台                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    共享基础设施                           │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │    │
│  │  │ Web 服务 │  │ 数据库    │  │ 文件存储  │              │    │
│  │  └──────────┘  └──────────┘  └──────────┘              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│              ┌───────────────┼───────────────┐                  │
│              │               │               │                  │
│              ▼               ▼               ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   组织 A    │  │   组织 B    │  │   组织 C    │             │
│  │  /kbracer   │  │  /club-x    │  │  /media-y   │             │
│  │  专属榜单   │  │  专属榜单   │  │  专属榜单   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                  │
│  特点：                                                          │
│  • 多租户架构，数据隔离通过 org_id 实现                          │
│  • 共享综合榜单数据                                              │
│  • 统一维护和升级                                                │
│  • 按年付费订阅                                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 私有化部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      客户独立环境                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    独立基础设施                           │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │    │
│  │  │ Web 服务 │  │ 数据库    │  │ 文件存储  │              │    │
│  │  │ (独立)   │  │ (独立)   │  │ (独立)   │              │    │
│  │  └──────────┘  └──────────┘  └──────────┘              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    客户专属系统                           │    │
│  │  • 独立域名（如 lap.customer.com）                       │    │
│  │  • 独立数据库                                            │    │
│  │  • 可定制品牌                                            │    │
│  │  • 可自定义功能                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  特点：                                                          │
│  • 完全独立的系统实例                                            │
│  • 数据完全隔离                                                  │
│  • 可深度定制                                                    │
│  • 客户可自行维护或委托平台维护                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 Docker 部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./static:/app/static
    environment:
      - DB_PATH=/app/data/hpa.db
      - CRAWLER_SCHEDULE=0 5 * * *
    restart: always

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./static:/usr/share/nginx/html/static
    depends_on:
      - app
    restart: always
```

### 8.3 目录挂载

| 目录 | 用途 | 备份策略 |
|------|------|----------|
| /app/data | SQLite 数据库 | 每日备份 |
| /app/static/photos | 成绩截图 | 增量备份 |
| /app/static/videos | 随车视频 | 增量备份 |

### 8.4 私有化部署配置

私有化部署时，需要调整以下配置：

```yaml
# 私有化部署配置示例
app:
  # 基础配置
  name: "客户专属圈速榜"
  domain: "lap.customer.com"

  # 品牌配置
  branding:
    logo: "/static/custom/logo.png"
    primary_color: "#FF6B00"

  # 功能开关
  features:
    public_leaderboard: false    # 禁用综合榜单
    crawler: false               # 禁用爬虫
    multi_org: false             # 单组织模式

  # 数据隔离
  database:
    path: "/app/data/customer.db"
```

---

## 9. 监控与日志

### 9.1 日志

| 类型 | 内容 |
|------|------|
| 访问日志 | HTTP 请求日志 |
| 业务日志 | 成绩记录、投票、申诉 |
| 爬虫日志 | 爬取结果、错误信息 |
| 错误日志 | 异常堆栈 |

### 9.2 监控指标

| 指标 | 说明 |
|------|------|
| 爬虫状态 | 最近执行时间、成功/失败 |
| 待验证成绩数 | 积压情况 |
| 投票参与率 | 用户活跃度 |
| API 响应时间 | 性能监控 |

---

## 10. 扩展性考虑

### 10.1 数据库扩展

当前使用 SQLite，如需扩展：
- 迁移到 PostgreSQL / MySQL
- GORM 支持多数据库，迁移成本低

### 10.2 存储扩展

当前使用本地文件存储，如需扩展：
- 迁移到对象存储（OSS / S3）
- 视频可使用 CDN 加速

### 10.3 功能扩展

| 功能 | 扩展方向 |
|------|----------|
| 卡丁车场 | 新增场地类型，复用现有逻辑 |
| 分段计时 | 扩展成绩记录字段 |
| API 对接 | RaceChrono API、51GT3 API |
| 多语言 | i18n 支持 |
