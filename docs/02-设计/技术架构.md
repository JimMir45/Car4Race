# 技术架构

## 1. 架构概述

### 1.1 设计原则

| 原则 | 说明 | 体现 |
|-----|------|------|
| 简单优先 | MVP 追求最小可行 | 单容器部署、SQLite 存储 |
| 低成本 | 最小化运营开销 | 静态文件、无外部服务依赖 |
| 易维护 | 个人可独立运维 | 清晰的目录结构、完善的日志 |
| 安全优先 | 防止DDoS和滥用 | 访问频率限制、游客排队机制 |
| 可扩展 | 预留升级空间 | 模块化设计、支付接口预留 |

### 1.2 系统架构图

```
                                    ┌─────────────────┐
                                    │     用户浏览器    │
                                    └────────┬────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             Docker Container                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                            Nginx                                     │   │
│  │                 (反向代理 + 静态资源服务)                             │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                          │
│              ┌───────────────────┴───────────────────┐                     │
│              ▼                                       ▼                      │
│  ┌─────────────────────┐             ┌─────────────────────────────────┐   │
│  │     静态资源         │             │         Go Backend              │   │
│  │  ├── Vue SPA        │             │  ┌─────────────────────────┐    │   │
│  │  ├── Notes (MD)     │             │  │    Middleware 层         │    │   │
│  │  └── Courses (ZIP)  │             │  │  • 访问频率限制(15秒)    │    │   │
│  └─────────────────────┘             │  │  • 游客排队(IP>50)       │    │   │
│                                      │  │  • JWT认证              │    │   │
│                                      │  ├─────────────────────────┤    │   │
│                                      │  │      Gin Router         │    │   │
│                                      │  ├─────────────────────────┤    │   │
│                                      │  │     Service 层          │    │   │
│                                      │  ├─────────────────────────┤    │   │
│                                      │  │   Repository 层         │    │   │
│                                      │  └───────────┬─────────────┘    │   │
│                                      │              │                  │   │
│                                      │              ▼                  │   │
│  ┌─────────────────────┐             │  ┌─────────────────────┐       │   │
│  │   短信服务(外部)     │←────────────│  │      SQLite         │       │   │
│  │  阿里云/腾讯云SMS   │             │  └─────────────────────┘       │   │
│  └─────────────────────┘             └─────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────┐                                                   │
│  │   第三方支付(预留)   │                                                   │
│  │  微信支付/支付宝    │                                                   │
│  └─────────────────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 请求流程

```
用户请求
    │
    ▼
┌─────────┐
│  Nginx  │
└────┬────┘
     │
     ├──── /api/*  ──────────────→ Go Backend (端口 8080)
     │                                  │
     │                          ┌───────┴───────┐
     │                          ▼               ▼
     │                    需要认证？        公开接口
     │                          │               │
     │                     JWT验证         直接处理
     │                          │               │
     │                          └───────┬───────┘
     │                                  ▼
     │                           频率限制检查
     │                           游客排队检查
     │
     ├──── /static/notes/* ──────→ 静态笔记文件 (Markdown)
     │
     ├──── /static/courses/* ────→ 课程文件 (需后端验证Token)
     │
     └──── /*  ──────────────────→ Vue SPA (index.html)
```

## 2. 技术选型

### 2.1 技术栈一览

| 层级 | 技术 | 版本 | 选型理由 |
|-----|------|------|---------|
| 前端框架 | Vue 3 | 3.4+ | 生态成熟、学习成本低 |
| 构建工具 | Vite | 5.0+ | 快速、零配置 |
| UI 组件 | TailwindCSS | 3.4+ | 轻量、高度定制 |
| Markdown | markdown-it | - | 功能完整、可扩展 |
| 后端框架 | Gin | 1.9+ | 高性能、简洁 |
| 编程语言 | Go | 1.21+ | 单文件编译、性能优秀 |
| 数据库 | SQLite | 3 | 零配置、单文件存储 |
| 缓存 | go-cache | - | 内存缓存，用于频率限制 |
| JWT | jwt-go | v5 | 用户认证 |
| Web服务器 | Nginx | 1.24+ | 静态资源、反向代理 |
| 容器化 | Docker | 24+ | 一致环境、易部署 |
| 短信服务 | 阿里云/腾讯云 | - | 验证码发送 |

### 2.2 选型对比

#### 后端语言选型

| 选项 | 优点 | 缺点 | 结论 |
|-----|------|------|------|
| **Go** | 单文件部署、性能好、并发强 | 生态不如 Node | ✅ 选用 |
| Node.js | 生态丰富、开发快 | 依赖多、部署复杂 | ❌ |
| Python | 开发快、AI 友好 | 性能一般、依赖管理 | ❌ |

#### 数据库选型

| 选项 | 优点 | 缺点 | 结论 |
|-----|------|------|------|
| **SQLite** | 零配置、单文件、轻量 | 不适合高并发 | ✅ 选用 |
| MySQL | 功能强大、稳定 | 需要独立服务 | ❌ |
| PostgreSQL | 功能最强 | 配置复杂 | ❌ |

## 3. 目录结构

### 3.1 项目代码结构

```
hpa/
├── frontend/                    # 前端项目
│   ├── src/
│   │   ├── components/         # 通用组件
│   │   ├── views/              # 页面组件
│   │   │   ├── Home.vue        # 首页（含公告）
│   │   │   ├── Queue.vue       # 排队页面
│   │   │   ├── Auth.vue        # 登录注册
│   │   │   ├── Notes.vue       # 笔记列表
│   │   │   ├── Courses.vue     # 课程列表（含排序）
│   │   │   └── User/           # 个人中心
│   │   │       ├── Profile.vue
│   │   │       ├── Orders.vue
│   │   │       ├── History.vue
│   │   │       └── Downloads.vue
│   │   ├── router/             # 路由配置
│   │   ├── stores/             # Pinia 状态
│   │   ├── utils/              # 工具函数
│   │   └── App.vue
│   ├── public/
│   └── package.json
│
├── backend/                     # 后端项目
│   ├── cmd/
│   │   └── server/
│   │       └── main.go         # 入口文件
│   ├── internal/
│   │   ├── middleware/         # 中间件
│   │   │   ├── auth.go         # JWT认证
│   │   │   ├── ratelimit.go    # 频率限制
│   │   │   └── queue.go        # 游客排队
│   │   ├── handler/            # HTTP 处理器
│   │   │   ├── auth.go         # 注册登录
│   │   │   ├── note.go
│   │   │   ├── course.go
│   │   │   ├── order.go
│   │   │   ├── invite.go       # 邀请码
│   │   │   └── user.go         # 个人中心
│   │   ├── service/            # 业务逻辑
│   │   ├── repository/         # 数据访问
│   │   ├── model/              # 数据模型
│   │   └── config/             # 配置管理
│   ├── pkg/
│   │   ├── sms/                # 短信服务
│   │   └── utils/              # 公共工具
│   └── go.mod
│
├── docker/
│   ├── Dockerfile
│   └── nginx.conf
│
└── static/                      # 静态资源（挂载卷）
    ├── notes/                   # 学习笔记
    └── courses/                 # 课程文件
```

### 3.2 容器内结构

```
/app/
├── hpa                          # Go 编译后的可执行文件
├── dist/                        # 前端构建产物
├── static/                      # 静态资源（挂载点）
│   ├── notes/
│   └── courses/
├── data/
│   └── hpa.db                   # SQLite 数据库
├── config/
│   └── config.yaml              # 配置文件
└── logs/                        # 日志目录
```

## 4. 核心模块设计

### 4.1 模块划分

```
┌───────────────────────────────────────────────────────────────────────────┐
│                            Middleware 层                                   │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐         │
│   │ RateLimit  │  │  Queue     │  │   Auth     │  │   CORS     │         │
│   │ (15秒/用户)│  │ (游客排队) │  │  (JWT)     │  │            │         │
│   └────────────┘  └────────────┘  └────────────┘  └────────────┘         │
├───────────────────────────────────────────────────────────────────────────┤
│                             Handler 层                                     │
│ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │
│ │AuthAPI │ │NoteAPI │ │CourseAPI│ │OrderAPI│ │InviteAPI│ │UserAPI │       │
│ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘       │
├─────┼──────────┼──────────┼──────────┼──────────┼──────────┼─────────────┤
│     ▼          ▼          ▼          ▼          ▼          ▼             │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                         Service 层                               │   │
│   │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐│   │
│   │ │AuthSvc   │ │NoteSvc   │ │CourseSvc │ │OrderSvc  │ │MemberSvc ││   │
│   │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘│   │
│   └────────────────────────────────┬────────────────────────────────┘   │
│                                    │                                     │
├────────────────────────────────────┼─────────────────────────────────────┤
│                                    ▼                                     │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                       Repository 层                              │   │
│   │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐│   │
│   │ │UserRepo  │ │NoteRepo  │ │CourseRepo│ │OrderRepo │ │InviteRepo││   │
│   │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘│   │
│   └────────────────────────────────┬────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│                             ┌────────────┐                               │
│                             │   SQLite   │                               │
│                             └────────────┘                               │
└───────────────────────────────────────────────────────────────────────────┘
```

### 4.2 核心流程

#### 用户注册流程

```go
// 1. 发送验证码
func (h *AuthHandler) SendCode(c *gin.Context) {
    phone := c.PostForm("phone")

    // 检查发送频率（60秒间隔）
    if h.smsService.IsRateLimited(phone) {
        c.JSON(429, gin.H{"error": "请60秒后重试"})
        return
    }

    // 生成验证码并发送
    code := h.smsService.GenerateCode()
    h.smsService.Send(phone, code)
    h.smsService.SaveCode(phone, code) // 5分钟有效
}

// 2. 验证并注册
func (h *AuthHandler) Register(c *gin.Context) {
    phone := c.PostForm("phone")
    code := c.PostForm("code")

    // 验证验证码
    if !h.smsService.VerifyCode(phone, code) {
        c.JSON(400, gin.H{"error": "验证码错误"})
        return
    }

    // 生成用户名：日期 + 手机后4位
    username := time.Now().Format("20060102") + phone[len(phone)-4:]

    // 创建用户
    user := h.userService.Create(username, phone)

    // 生成JWT
    token := h.authService.GenerateToken(user)
    c.JSON(200, gin.H{"token": token, "user": user})
}
```

#### 访问频率限制

```go
// 用户级15秒频率限制
func RateLimitMiddleware(cache *cache.Cache) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("user_id")
        if userID == "" {
            c.Next()
            return
        }

        key := "rate:" + userID
        if _, found := cache.Get(key); found {
            c.JSON(429, gin.H{
                "code": 42901,
                "message": "访问过于频繁，请15秒后重试",
            })
            c.Abort()
            return
        }

        cache.Set(key, true, 15*time.Second)
        c.Next()
    }
}
```

#### 游客排队机制

```go
// 游客IP排队（超过50需排队）
type QueueManager struct {
    activeIPs map[string]time.Time
    queue     []string
    maxActive int // 50
    mu        sync.RWMutex
}

func (q *QueueManager) CheckAccess(ip string) (bool, int) {
    q.mu.Lock()
    defer q.mu.Unlock()

    // 清理过期IP（超过5分钟无活动）
    q.cleanExpired()

    // 已在活跃列表
    if _, exists := q.activeIPs[ip]; exists {
        q.activeIPs[ip] = time.Now()
        return true, 0
    }

    // 活跃数未满
    if len(q.activeIPs) < q.maxActive {
        q.activeIPs[ip] = time.Now()
        return true, 0
    }

    // 需要排队，返回排队位置
    position := q.getQueuePosition(ip)
    return false, position
}
```

#### 会员升级流程

```go
// 检查是否触发会员升级
func (s *MemberService) CheckUpgrade(userID int) {
    // 计算年消费（不含邀请码）
    yearSpent := s.orderRepo.GetYearSpentExcludeInvite(userID)

    if yearSpent >= 2000 {
        user := s.userRepo.GetByID(userID)
        if user.Role != "vip" {
            // 升级为会员
            user.Role = "vip"
            user.VipExpireAt = time.Now().AddDate(1, 0, 0) // 1年有效期
            s.userRepo.Update(user)

            // 创建公告（滚动3天）
            s.announcementRepo.Create(&Announcement{
                Content:   fmt.Sprintf("恭喜用户 %s 成为年度会员！", user.Username),
                Type:      "member",
                StartAt:   time.Now(),
                EndAt:     time.Now().AddDate(0, 0, 3),
            })
        }
    }
}
```

## 5. 安全设计

### 5.1 访问控制

```go
// JWT认证中间件
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        if token == "" {
            c.JSON(401, gin.H{"error": "未登录"})
            c.Abort()
            return
        }

        claims, err := jwt.ParseToken(token)
        if err != nil {
            c.JSON(401, gin.H{"error": "登录已过期"})
            c.Abort()
            return
        }

        c.Set("user_id", claims.UserID)
        c.Set("user_role", claims.Role)
        c.Next()
    }
}
```

### 5.2 下载链接保护

```go
type DownloadToken struct {
    Token       string
    UserID      int       // 关联用户
    CourseID    int       // 关联课程
    ExpireAt    time.Time // 过期时间
    MaxDownload int       // 最大下载次数
    Downloaded  int       // 已下载次数
}

func (s *OrderService) ValidateDownload(token string, userID int) (*Course, error) {
    dt, err := s.repo.GetToken(token)
    if err != nil {
        return nil, ErrTokenInvalid
    }

    // 检查用户匹配
    if dt.UserID != userID {
        return nil, ErrTokenInvalid
    }

    // 检查过期
    if dt.ExpireAt.Before(time.Now()) {
        return nil, ErrTokenExpired
    }

    // 检查下载次数
    if dt.Downloaded >= dt.MaxDownload {
        return nil, ErrDownloadLimitExceeded
    }

    // 检查是否为会员（会员无限下载）
    user := s.userRepo.GetByID(userID)
    if user.Role == "vip" && user.VipExpireAt.After(time.Now()) {
        return s.courseRepo.GetByID(dt.CourseID)
    }

    // 更新下载次数
    s.repo.IncrementDownload(token)
    return s.courseRepo.GetByID(dt.CourseID)
}
```

## 6. 配置管理

### 6.1 配置文件

```yaml
# config.yaml
server:
  port: 8080
  mode: release  # debug / release

database:
  path: ./data/hpa.db

static:
  notes_dir: ./static/notes
  courses_dir: ./static/courses

security:
  rate_limit_seconds: 15     # 用户访问频率限制
  guest_ip_limit: 50         # 游客IP上限
  jwt_secret: your-secret-key
  jwt_expire_hours: 168      # 7天

download:
  token_expire_hours: 24
  max_download_count: 3

sms:
  provider: aliyun  # aliyun / tencent
  access_key: xxx
  secret_key: xxx
  sign_name: xxx
  template_code: xxx
  code_expire_minutes: 5
  send_interval_seconds: 60

member:
  upgrade_threshold: 2000    # 会员升级消费门槛
  vip_duration_years: 1      # 会员有效期
  announce_days: 3           # 公告滚动天数

payment:
  # 预留第三方支付配置
  enabled: false
  provider: ""
```

### 6.2 环境变量

| 变量 | 说明 | 默认值 |
|-----|------|-------|
| HPA_PORT | 服务端口 | 8080 |
| HPA_DB_PATH | 数据库路径 | ./data/hpa.db |
| HPA_JWT_SECRET | JWT密钥 | - |
| HPA_SMS_PROVIDER | 短信服务商 | aliyun |
| HPA_SMS_ACCESS_KEY | 短信AK | - |
| HPA_SMS_SECRET_KEY | 短信SK | - |

## 7. 部署架构

### 7.1 单机部署

```
┌─────────────────────────────────────────────────────────────┐
│                        云服务器                              │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Docker Container                      │ │
│  │  ┌─────────────┐         ┌─────────────────────────┐  │ │
│  │  │    Nginx    │ ───────→│      Go Backend         │  │ │
│  │  └──────┬──────┘         │  • JWT认证              │  │ │
│  │         │                │  • 频率限制(15秒)       │  │ │
│  │         ▼                │  • 游客排队(IP>50)      │  │ │
│  │  ┌─────────────┐         │  • 会员系统             │  │ │
│  │  │   静态资源   │         └───────────┬─────────────┘  │ │
│  │  └─────────────┘                     │                │ │
│  │                                      ▼                │ │
│  │                              ┌─────────────┐          │ │
│  │                              │   SQLite    │          │ │
│  │                              └─────────────┘          │ │
│  └───────────────────────────────────────────────────────┘ │
│                           │                                 │
│                           ▼                                 │
│                   ┌──────────────┐                          │
│                   │ Volume Mount │                          │
│                   │ - notes/     │                          │
│                   │ - courses/   │                          │
│                   │ - data/      │                          │
│                   └──────────────┘                          │
│                                                             │
│  ┌───────────────┐                                          │
│  │   外部服务     │                                          │
│  │ • 短信服务    │                                          │
│  │ • 第三方支付  │                                          │
│  └───────────────┘                                          │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 资源需求

| 资源 | 最低配置 | 推荐配置 |
|-----|---------|---------|
| CPU | 1 核 | 2 核 |
| 内存 | 512MB | 1GB |
| 磁盘 | 10GB | 50GB（取决于课程大小）|
| 带宽 | 1Mbps | 5Mbps+ |

---

**文档版本**：v2.0
**创建日期**：2025-01-15
**最后更新**：2025-01-15
